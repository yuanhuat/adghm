# AdGuardHome 管理系统 (ADGHM)

[![Python](https://img.shields.io/badge/Python-3.11+-blue.svg)](https://www.python.org/downloads/)
[![Flask](https://img.shields.io/badge/Flask-2.3.3-green.svg)](https://flask.palletsprojects.com/)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

一个专为简化 AdGuardHome 管理而设计的 Web 应用程序，支持多用户管理、本地DNS记录管理、AI智能分析等功能。

## 🌟 主要功能

### 🔐 用户管理
- **多用户支持**：每个用户拥有独立的账户和客户端管理权限
- **权限分级**：支持管理员和普通用户两种角色
- **用户注册**：支持用户自主注册，首个注册用户自动成为管理员
- **密码管理**：安全的密码哈希存储和验证机制

![登录页面](screenshots/01-login-page.png)
*登录页面 - 美观的动画背景和现代化的登录界面*

![注册页面](screenshots/02-register-page.png)
*注册页面 - 用户友好的注册表单*

### 🖥️ 客户端管理
- **客户端创建**：支持创建和管理 AdGuardHome 客户端
- **客户端配置**：可配置过滤规则、安全浏览、家长控制等设置
- **批量操作**：支持批量管理多个客户端
- **状态监控**：实时显示客户端状态和统计信息

![用户主页](screenshots/03-user-dashboard.png)
*用户主页 - 显示用户统计信息和DNS配置*

![客户端管理](screenshots/04-client-management.png)
*客户端管理页面 - 管理用户的AdGuardHome客户端*


### 📊 查询日志增强
- **高级搜索**：支持多条件过滤和时间范围搜索
- **日志导出**：支持 CSV 和 JSON 格式的日志导出
- **趋势分析**：提供 DNS 查询趋势分析报告
- **可视化图表**：直观的统计图表展示

![查询日志](screenshots/09-query-log.png)
*查询日志页面 - 查看DNS查询记录*

![增强查询日志](screenshots/10-query-log-enhanced.png)
*增强查询日志页面 - 高级搜索和分析功能*

### 🤖 AI 智能分析
- **DeepSeek 集成**：集成 DeepSeek AI 进行智能域名分析
- **威胁识别**：自动识别广告、追踪器、恶意软件等威胁
- **智能推荐**：基于 AI 分析结果提供阻止建议
- **批量分析**：支持批量分析多个域名
- **审核流程**：管理员可审核 AI 分析结果并采取行动

![AI分析配置](screenshots/11-ai-analysis-config.png)
*AI分析配置页面 - 配置DeepSeek AI分析功能*

### 📧 邮件服务
- **邮件验证**：支持邮箱验证功能
- **密码重置**：通过邮件重置密码
- **通知服务**：重要操作的通知邮件发送

![邮件配置](screenshots/12-email-config.png)
*邮件配置页面 - 配置SMTP邮件服务器*

### 🔧 系统配置
- **AdGuardHome 配置**：管理 AdGuardHome API 连接
- **DNS 配置**：支持 DNS-over-QUIC、DNS-over-TLS、DNS-over-HTTPS 配置
- **邮件配置**：SMTP 邮件服务器配置
- **系统设置**：各种系统参数配置

![管理员后台](screenshots/05-admin-dashboard.png)
*管理员后台主页 - 系统管理入口*

![用户管理](screenshots/06-user-management.png)
*用户管理页面 - 管理系统用户*

![AdGuardHome配置](screenshots/07-adguard-config.png)
*AdGuardHome配置页面 - 配置API连接*

![DNS配置](screenshots/08-dns-config.png)
*DNS配置页面 - 配置DNS-over-QUIC/TLS/HTTPS*

![系统配置](screenshots/13-system-config.png)
*系统配置页面 - 系统参数设置*

### 📋 日志和反馈管理
- **操作日志**：记录系统操作历史
- **反馈管理**：用户反馈处理
- **全局阻止服务**：管理全局阻止的服务列表

![操作日志](screenshots/14-operation-logs.png)
*操作日志页面 - 查看系统操作记录*

![反馈管理](screenshots/15-feedbacks.png)
*反馈管理页面 - 处理用户反馈*

![全局阻止服务](screenshots/16-global-blocked-services.png)
*全局阻止服务页面 - 管理全局阻止的服务*

### 📖 使用指南
- **详细文档**：提供完整的使用指南和帮助文档

![使用指南](screenshots/17-guide.png)
*使用指南页面 - 详细的使用说明和帮助文档*

## 🚀 快速开始

### 环境要求

- **Python**: 3.11 或更高版本
- **操作系统**: Linux、Windows、macOS
- **内存**: 至少 2GB RAM
- **存储**: 至少 1GB 可用空间

### 安装方式

#### Docker 部署（推荐）

##### 方式一：使用 docker-compose（推荐）

```bash
# 克隆项目
git clone https://github.com/yourusername/adghm.git
cd adghm

# 启动容器
docker-compose up -d
```

##### 方式二：使用 docker run

```bash
# 拉取镜像
docker pull yuanhu66/adghm:latest

# 创建数据目录
mkdir -p /opt/adghm

# 运行容器
docker run -d \
  --name adghm \
  --restart unless-stopped \
  -p 5000:5000 \
  -v /opt/adghm:/app/instance \
  yuanhu66/adghm:latest
```

##### 方式三：自行构建镜像

```bash
# 克隆项目
git clone https://github.com/yourusername/adghm.git
cd adghm

# 构建镜像
docker build -t adghm .

# 运行容器
docker run -d \
  --name adghm \
  --restart unless-stopped \
  -p 5000:5000 \
  -v /opt/adghm:/app/instance \
  adghm
```

#### 手动部署

```bash
# 克隆项目
git clone https://github.com/yourusername/adghm.git
cd adghm

# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/macOS
# 或 venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt

# 启动应用
python run.py
```

### 初始配置

1. **环境变量配置**：在系统后台配置必要的环境变量（SECRET_KEY、AdGuardHome连接信息等）
2. **访问系统**：打开浏览器访问 `http://localhost:5000`
3. **注册管理员**：注册第一个用户账号（将自动成为管理员）
4. **配置 AdGuardHome**：在管理员后台配置 AdGuardHome API 连接

> **注意**：所有环境变量配置（如SECRET_KEY、AdGuardHome连接信息、邮件服务配置等）都应该在系统后台进行设置，而不是通过配置文件。详细的环境变量说明请参考下方的「配置说明」部分。

## 📖 使用指南

### 🚀 快速上手

#### 第一次使用

1. **系统访问**
   - 打开浏览器访问 `http://localhost:5000`
   - 如果是远程部署，请使用服务器的 IP 地址或域名

2. **管理员注册**
   - 点击「注册」按钮
   - 输入 6-12 位数字作为用户名（如：123456）
   - 设置安全密码（建议包含字母、数字和特殊字符）
   - 输入有效的邮箱地址
   - 第一个注册的用户将自动成为系统管理员

3. **基础配置**
   - 登录后进入管理员后台
   - 配置 AdGuardHome API 连接信息
   - 设置域名解析服务（可选）
   - 配置邮件服务（可选）

### 👤 普通用户操作指南

#### 用户注册和登录

**注册新用户**
1. 访问系统首页，点击「注册」
2. 填写注册信息：
   - **用户名**：必须是 6-12 位数字（如：987654）
   - **密码**：建议使用强密码
   - **邮箱**：用于接收通知和密码重置
3. 点击「注册」完成账户创建
4. 等待管理员审核（如果启用了审核功能）

**用户登录**
1. 在首页输入用户名和密码
2. 点击「登录」进入个人主页
3. 如果忘记密码，可点击「忘记密码」通过邮箱重置

#### 客户端管理

**创建客户端**
1. 登录后在个人主页点击「管理客户端」
2. 点击「创建客户端」按钮
3. 填写客户端信息：
   - **客户端名称**：便于识别的名称（如：我的手机）
   - **客户端标识**：唯一标识符（如：my-phone）
   - **描述**：可选的详细描述
4. 点击「创建」完成客户端创建

**配置客户端**
1. 在客户端列表中点击「配置」
2. 设置过滤规则：
   - **广告拦截**：启用/禁用广告过滤
   - **恶意软件防护**：启用/禁用恶意软件拦截
   - **家长控制**：设置儿童安全过滤
   - **自定义规则**：添加自定义过滤规则
3. 保存配置

**查看客户端状态**
- 在个人主页可查看所有客户端的状态
- 包括：在线状态、查询次数、拦截次数等
- 点击客户端名称可查看详细统计信息


#### 查询日志查看

**基础查看**
1. 在个人主页点击「查询日志」
2. 查看最近的 DNS 查询记录
3. 包括：查询时间、域名、查询类型、响应结果等

**高级搜索**
1. 点击「高级搜索」
2. 设置搜索条件：
   - **时间范围**：选择查询的时间段
   - **域名过滤**：搜索特定域名
   - **查询类型**：过滤 A、AAAA、CNAME 等记录类型
   - **响应状态**：过滤被拦截或允许的查询
3. 点击「搜索」查看结果

**导出日志**
1. 在查询日志页面点击「导出」
2. 选择导出格式：CSV 或 JSON
3. 选择导出的时间范围和数据量
4. 下载导出文件

### 👨‍💼 管理员操作指南

#### 系统配置管理

**AdGuardHome 配置**
1. 进入管理员后台 → 系统配置 → AdGuardHome 配置
2. 填写连接信息：
   - **API 地址**：AdGuardHome 的 API 地址（如：http://192.168.1.100:3000）
   - **用户名**：AdGuardHome 管理员用户名
   - **密码**：AdGuardHome 管理员密码
3. 点击「测试连接」验证配置
4. 保存配置



**邮件服务配置**
1. 进入系统配置 → 邮件配置
2. 配置 SMTP 服务器：
   - **SMTP 服务器**：邮件服务器地址（如：smtp.qq.com）
   - **端口**：SMTP 端口（通常为 587 或 465）
   - **用户名**：邮箱账号
   - **密码**：邮箱密码或授权码
   - **加密方式**：选择 TLS 或 SSL
3. 点击「发送测试邮件」验证配置
4. 保存配置

**DNS 高级配置**
1. 进入系统配置 → DNS 配置
2. 配置安全 DNS：
   - **DNS-over-QUIC**：启用 DoQ 支持
   - **DNS-over-TLS**：启用 DoT 支持
   - **DNS-over-HTTPS**：启用 DoH 支持
3. 设置上游 DNS 服务器
4. 配置 DNS 缓存策略
5. 保存配置

#### 用户管理

**查看用户列表**
1. 进入管理员后台 → 用户管理
2. 查看所有注册用户的信息
3. 包括：用户名、邮箱、注册时间、最后登录时间、状态等

**创建新用户**
1. 点击「创建用户」
2. 填写用户信息：
   - **用户名**：6-12 位数字
   - **密码**：为用户设置初始密码
   - **邮箱**：用户邮箱地址
   - **角色**：选择普通用户或管理员
3. 保存用户信息

**编辑用户信息**
1. 在用户列表中点击「编辑」
2. 修改用户信息（用户名不可修改）
3. 可以重置用户密码
4. 可以更改用户角色
5. 保存修改

**删除用户**
1. 在用户列表中点击「删除」
2. 确认删除操作
3. 用户的所有数据将被永久删除

#### 系统监控和日志

**查看操作日志**
1. 进入管理员后台 → 操作日志
2. 查看系统操作记录：
   - **用户操作**：登录、注册、配置修改等
   - **系统操作**：自动任务执行、错误记录等
   - **API 调用**：与 AdGuardHome 的交互记录
3. 可按时间、用户、操作类型进行过滤

**系统统计信息**
1. 在管理员主页查看系统概况
2. 包括：
   - **用户统计**：总用户数、活跃用户数
   - **客户端统计**：总客户端数、在线客户端数
   - **查询统计**：总查询数、拦截数、通过数
   - **系统状态**：服务运行状态、资源使用情况

#### AI 分析管理

**配置 AI 分析**
1. 进入管理员后台 → AI 分析配置
2. 配置 DeepSeek API：
   - **API 密钥**：DeepSeek 平台的 API 密钥
   - **模型选择**：选择使用的 AI 模型
   - **分析频率**：设置自动分析的频率
3. 启用 AI 分析功能

**查看分析结果**
1. 进入 AI 分析管理页面
2. 查看 AI 分析的域名列表
3. 包括：域名、威胁等级、分析结果、建议操作

**审核分析建议**
1. 在分析结果列表中点击「审核」
2. 查看 AI 的详细分析报告
3. 选择操作：
   - **采纳建议**：将域名添加到拦截列表
   - **忽略建议**：标记为误报
   - **需要人工审核**：标记为待进一步确认
4. 保存审核结果

### 🔧 高级功能使用

#### 批量操作

**批量管理客户端**
1. 在客户端管理页面选择多个客户端
2. 点击「批量操作」
3. 可执行：
   - **批量启用/禁用**：同时启用或禁用多个客户端
   - **批量配置**：为多个客户端应用相同配置
   - **批量删除**：删除多个客户端

**批量域名分析**
1. 在 AI 分析页面点击「批量分析」
2. 上传包含域名列表的文件（每行一个域名）
3. 或手动输入多个域名（换行分隔）
4. 点击「开始分析」
5. 等待 AI 分析完成

#### 数据导入导出

**导出系统配置**
1. 进入管理员后台 → 系统配置
2. 点击「导出配置」
3. 选择要导出的配置项
4. 下载配置文件

**导入系统配置**
1. 点击「导入配置」
2. 上传之前导出的配置文件
3. 选择要导入的配置项
4. 确认导入操作

**备份用户数据**
1. 进入用户管理页面
2. 点击「导出用户数据」
3. 选择导出格式和数据范围
4. 下载备份文件

### 🚨 常见问题解决

#### 连接问题

**无法连接 AdGuardHome**
1. 检查 AdGuardHome 服务是否正常运行
2. 验证 API 地址是否正确（注意端口号）
3. 确认用户名和密码是否正确
4. 检查网络连接和防火墙设置
5. 查看系统日志获取详细错误信息



**邮件发送失败**
1. 检查 SMTP 服务器配置
2. 验证邮箱账号和密码/授权码
3. 确认邮件服务器端口和加密方式
4. 检查网络连接和防火墙设置

#### 性能问题

**系统响应慢**
1. 检查服务器资源使用情况
2. 清理过期的日志数据
3. 优化数据库查询
4. 考虑增加服务器配置

**查询日志加载慢**
1. 减少查询的时间范围
2. 使用更精确的搜索条件
3. 定期清理历史日志
4. 考虑启用日志分页

#### 功能问题

**AI 分析不准确**
1. 检查 DeepSeek API 配置
2. 更新 AI 模型版本
3. 调整分析参数
4. 人工审核和标记结果

**客户端状态异常**
1. 检查客户端网络连接
2. 验证 DNS 配置是否正确
3. 重启客户端服务
4. 查看客户端日志

### 📱 移动端使用

#### 响应式界面
- 系统支持移动设备访问
- 自动适配手机和平板屏幕
- 触摸友好的操作界面

#### 移动端功能
- 查看客户端状态
- 查询 DNS 日志
- 接收系统通知

### 🔐 安全最佳实践

#### 密码安全
1. 使用强密码（包含大小写字母、数字、特殊字符）
2. 定期更换密码
3. 不要在多个系统中使用相同密码
4. 启用邮箱验证功能

#### 系统安全
1. 定期更新系统版本
2. 监控系统日志
3. 限制管理员权限
4. 定期备份重要数据

#### 网络安全
1. 使用 HTTPS 访问系统
2. 配置防火墙规则
3. 启用 DNS 安全功能
4. 监控异常访问

### 📊 性能优化建议

#### 系统优化
1. 定期清理日志数据
2. 优化数据库索引
3. 配置适当的缓存策略
4. 监控系统资源使用

#### 网络优化
1. 使用 CDN 加速静态资源
2. 启用 Gzip 压缩
3. 优化 DNS 查询路径
4. 配置负载均衡（如需要）

## 🏗️ 技术架构

### 后端技术栈

- **Web 框架**: Flask 2.3.3
- **数据库**: SQLAlchemy + SQLite
- **认证**: Flask-Login
- **邮件**: Flask-Mail
- **任务调度**: Flask-APScheduler
- **AI 集成**: DeepSeek API

### 前端技术栈

- **模板引擎**: Jinja2
- **CSS 框架**: Bootstrap 4
- **图标**: Font Awesome
- **图表**: Chart.js
- **JavaScript**: jQuery

### 项目结构

```
adghm/
├── app/                    # 应用主目录
│   ├── admin/             # 管理员模块
│   ├── auth/              # 认证模块
│   ├── main/              # 主要视图
│   ├── models/            # 数据模型
│   ├── services/          # 服务层
│   ├── static/            # 静态文件
│   ├── templates/         # 模板文件
│   └── utils/             # 工具函数
├── docs/                  # 文档
├── migrations/            # 数据库迁移
├── openapi/              # API 文档
└── requirements.txt       # 依赖列表
```



## 📊 功能特性

### 核心特性

- ✅ **多用户支持**：独立账户和权限管理
- ✅ **本地DNS管理**：自定义域名解析记录
- ✅ **双栈支持**：IPv4 和 IPv6 地址解析
- ✅ **AI 智能分析**：DeepSeek AI 集成
- ✅ **高级日志管理**：搜索、导出、分析
- ✅ **邮件服务**：验证和通知功能
- ✅ **Docker 支持**：容器化部署
- ✅ **响应式设计**：移动端友好

### 安全特性

- 🔒 **密码加密**：使用 Werkzeug 安全哈希
- 🔒 **会话管理**：Flask-Login 安全会话
- 🔒 **权限控制**：基于角色的访问控制
- 🔒 **API 安全**：AdGuardHome API 认证
- 🔒 **数据保护**：敏感信息加密存储

## 🤝 贡献指南

欢迎贡献代码！请遵循以下步骤：

1. Fork 本项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 创建 Pull Request

## 📝 更新日志

### v1.0.0 (2025-08-07)
- ✨ 新增多用户管理系统
- ✨ 新增自动化域名解析功能
- ✨ 新增 AI 智能分析功能
- ✨ 新增高级查询日志功能
- ✨ 新增邮件服务功能
- ✨ 新增 Docker 支持
- 🐛 修复多个已知问题
- 📚 完善文档和用户手册

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 📞 支持与反馈

如果您遇到问题或有建议，请通过以下方式联系我们：

- 📧 邮箱：1179736569@qq.com
- 🐛 [GitHub Issues](https://github.com/yourusername/adghm/issues)
- 📖 [项目文档](https://github.com/yourusername/adghm/docs)

## 🙏 致谢

感谢以下开源项目的支持：

- [Flask](https://flask.palletsprojects.com/) - Web 框架
- [AdGuardHome](https://adguardhome.adguard.com/) - DNS 服务器
- [Bootstrap](https://getbootstrap.com/) - CSS 框架
- [DeepSeek](https://platform.deepseek.com/) - AI 服务

---

⭐ 如果这个项目对您有帮助，请给我们一个星标！