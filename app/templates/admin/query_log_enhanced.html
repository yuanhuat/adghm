{% extends "admin/base.html" %}

{% block title %}æŸ¥è¯¢æ—¥å¿—å¢å¼º - AdGuard Home ç®¡ç†{% endblock %}

{% block extra_css %}
<style>
/* ä¸»é¢˜è‰²å½©å˜é‡ */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-medium: 0 4px 20px rgba(0,0,0,0.15);
    --border-radius: 12px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* æœç´¢é¢æ¿ç°ä»£åŒ–è®¾è®¡ */
.search-panel {
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    border: none;
    border-radius: var(--border-radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-light);
    position: relative;
    overflow: hidden;
}

.search-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
}

.search-panel h5 {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.filter-group {
    margin-bottom: 20px;
}

.filter-group label {
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    color: #495057;
    font-size: 0.9rem;
}

.form-control {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    padding: 10px 15px;
    transition: var(--transition);
    font-size: 0.9rem;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    transform: translateY(-1px);
}

/* åˆ†æé¢æ¿ */
.analysis-panel {
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    border: none;
    border-radius: var(--border-radius);
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-medium);
    position: relative;
    overflow: hidden;
}

.analysis-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--info-gradient);
}

/* ç»Ÿè®¡å¡ç‰‡ç°ä»£åŒ– */
.stats-card {
    background: var(--primary-gradient);
    color: white;
    border-radius: var(--border-radius);
    padding: 25px 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-medium);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.stats-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
}

.stats-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    transition: var(--transition);
}

.stats-card:hover::before {
    transform: scale(1.5);
}

.stats-number {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
}

.stats-label {
    font-size: 0.9rem;
    opacity: 0.9;
    position: relative;
    z-index: 1;
    font-weight: 500;
}

/* ä¸åŒç±»å‹çš„ç»Ÿè®¡å¡ç‰‡ */
.stats-card.success {
    background: var(--success-gradient);
}

.stats-card.warning {
    background: var(--warning-gradient);
}

.stats-card.info {
    background: var(--info-gradient);
}

.stats-card.dark {
    background: var(--dark-gradient);
}

/* AIåˆ†æå¡ç‰‡ */
.ai-analysis-card {
    border: none;
    background: linear-gradient(145deg, #f8f9ff 0%, #e3f2fd 100%);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: var(--shadow-light);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.ai-analysis-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--info-gradient);
}

.ai-analysis-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

/* ç½®ä¿¡åº¦æ¡ */
.confidence-bar {
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 8px;
    position: relative;
}

.confidence-fill {
    height: 100%;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.confidence-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.confidence-high { background: linear-gradient(90deg, #4caf50, #66bb6a); }
.confidence-medium { background: linear-gradient(90deg, #ff9800, #ffb74d); }
.confidence-low { background: linear-gradient(90deg, #f44336, #ef5350); }

/* åŸŸåæ ‡ç­¾ */
.domain-tag {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    margin-right: 8px;
    margin-bottom: 4px;
    font-weight: 500;
    transition: var(--transition);
    cursor: default;
}

.domain-tag:hover {
    transform: scale(1.05);
}

.tag-ad { 
    background: linear-gradient(135deg, #ffebee, #ffcdd2); 
    color: #c62828; 
    border: 1px solid #ffcdd2;
}
.tag-tracker { 
    background: linear-gradient(135deg, #fff3e0, #ffe0b2); 
    color: #ef6c00; 
    border: 1px solid #ffe0b2;
}
.tag-malware { 
    background: linear-gradient(135deg, #fce4ec, #f8bbd9); 
    color: #ad1457; 
    border: 1px solid #f8bbd9;
}
.tag-legitimate { 
    background: linear-gradient(135deg, #e8f5e8, #c8e6c9); 
    color: #2e7d32; 
    border: 1px solid #c8e6c9;
}

/* å¯¼å‡ºè¿›åº¦ */
.export-progress {
    display: none;
    margin-top: 15px;
}

.progress {
    height: 8px;
    border-radius: 4px;
    background: #e9ecef;
    overflow: hidden;
}

.progress-bar {
    background: var(--primary-gradient);
    transition: width 0.3s ease;
}

/* å›¾è¡¨å®¹å™¨ */
.chart-container {
    height: 350px;
    margin: 25px 0;
    padding: 20px;
    background: #fff;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
}

/* åŠ è½½åŠ¨ç”» */
.loading-spinner {
    display: inline-block;
    width: 24px;
    height: 24px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* æŒ‰é’®æ ·å¼ç°ä»£åŒ– */
.btn {
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 500;
    transition: var(--transition);
    border: none;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    transition: width 0.3s, height 0.3s;
    transform: translate(-50%, -50%);
}

.btn:hover::before {
    width: 300px;
    height: 300px;
}

.btn-ai {
    background: var(--primary-gradient);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-ai:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    color: white;
}

.btn-primary {
    background: var(--primary-gradient);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn-success {
    background: var(--success-gradient);
    box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
}

.btn-outline-primary {
    border: 2px solid #667eea;
    color: #667eea;
    background: transparent;
}

.btn-outline-primary:hover {
    background: var(--primary-gradient);
    border-color: transparent;
    transform: translateY(-2px);
}

/* å¡ç‰‡æ ·å¼ */
.card {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
    transition: var(--transition);
    overflow: hidden;
}

.card:hover {
    box-shadow: var(--shadow-medium);
}

.card-header {
    background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: none;
    padding: 20px 25px;
    position: relative;
}

.card-header::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary-gradient);
}

.card-body {
    padding: 25px;
}

/* è¡¨æ ¼æ ·å¼ç°ä»£åŒ– */
.table {
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-light);
}

.table thead th {
    background: var(--primary-gradient);
    color: white;
    border: none;
    padding: 15px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
}

.table tbody tr {
    transition: var(--transition);
}

.table tbody tr:hover {
    background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 100%);
    transform: scale(1.01);
}

.table tbody td {
    padding: 15px;
    border-color: #e9ecef;
    vertical-align: middle;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal-content {
    border: none;
    border-radius: var(--border-radius);
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    overflow: hidden;
}

.modal-header {
    background: var(--primary-gradient);
    color: white;
    border-bottom: none;
    padding: 20px 25px;
}

.modal-header .close {
    color: white;
    opacity: 0.8;
    font-size: 1.5rem;
}

.modal-header .close:hover {
    opacity: 1;
}

.modal-body {
    padding: 25px;
}

.modal-footer {
    border-top: 1px solid #e9ecef;
    padding: 20px 25px;
    background: #f8f9fa;
}
</style>
{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-search"></i> æŸ¥è¯¢æ—¥å¿—å¢å¼º</h2>
                <div>
                    <button class="btn btn-primary" onclick="showExportModal()"><i class="fas fa-download"></i> å¯¼å‡ºæ—¥å¿—</button>
                    <button class="btn btn-ai" onclick="showAIAnalysisModal()"><i class="fas fa-robot"></i> AIåˆ†æ</button>
                    <a href="{{ url_for('admin.ai_analysis_config') }}" class="btn btn-ai mr-2"><i class="fas fa-cog"></i> AIé…ç½®</a>
                    <a href="{{ url_for('admin.query_log') }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> è¿”å›åŸç‰ˆ</a>
                </div>
            </div>
        </div>
    </div>

    <!-- é«˜çº§æœç´¢é¢æ¿ -->
    <div class="search-panel">
        <h5><i class="fas fa-filter"></i> é«˜çº§æœç´¢</h5>
        <form id="searchForm" onsubmit="event.preventDefault(); performSearch();">
            <div class="row">
                <div class="col-md-3">
                    <div class="filter-group">
                        <label for="domainFilter">åŸŸå</label>
                        <input type="text" class="form-control" id="domainFilter" placeholder="æ”¯æŒé€šé…ç¬¦ *.example.com">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="filter-group">
                        <label for="clientFilter">å®¢æˆ·ç«¯</label>
                        <input type="text" class="form-control" id="clientFilter" placeholder="IPåœ°å€æˆ–å®¢æˆ·ç«¯åç§°">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="filter-group">
                        <label for="queryTypeFilter">æŸ¥è¯¢ç±»å‹</label>
                        <select class="form-control" id="queryTypeFilter">
                            <option value="">å…¨éƒ¨</option>
                            <option value="A">A</option>
                            <option value="AAAA">AAAA</option>
                            <option value="CNAME">CNAME</option>
                            <option value="MX">MX</option>
                            <option value="TXT">TXT</option>
                            <option value="PTR">PTR</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="filter-group">
                        <label for="blockedFilter">çŠ¶æ€</label>
                        <select class="form-control" id="blockedFilter">
                            <option value="">å…¨éƒ¨</option>
                            <option value="true">å·²é˜»æ­¢</option>
                            <option value="false">å·²å…è®¸</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <div>
                            <button type="button" class="btn btn-primary" onclick="performSearch()"><i class="fas fa-search"></i> æœç´¢</button>
                            <button type="button" class="btn btn-secondary" onclick="clearFilters()"><i class="fas fa-times"></i> æ¸…é™¤</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="filter-group">
                        <label for="startTimeFilter">å¼€å§‹æ—¶é—´</label>
                        <input type="datetime-local" class="form-control" id="startTimeFilter">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="filter-group">
                        <label for="endTimeFilter">ç»“æŸæ—¶é—´</label>
                        <input type="datetime-local" class="form-control" id="endTimeFilter">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="filter-group">
                        <label for="reasonFilter">é˜»æ­¢åŸå› </label>
                        <input type="text" class="form-control" id="reasonFilter" placeholder="è¿‡æ»¤è§„åˆ™ã€é»‘åå•ç­‰">
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="row" id="statsContainer" style="display: none;">
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stats-number" id="totalQueries">0</div>
                        <div class="stats-label">æ€»æŸ¥è¯¢æ•°</div>
                    </div>
                    <i class="fas fa-search fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card warning">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stats-number" id="blockedQueries">0</div>
                        <div class="stats-label">å·²é˜»æ­¢</div>
                    </div>
                    <i class="fas fa-shield-alt fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card success">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stats-number" id="allowedQueries">0</div>
                        <div class="stats-label">å·²å…è®¸</div>
                    </div>
                    <i class="fas fa-check-circle fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card info">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stats-number" id="blockRate">0%</div>
                        <div class="stats-label">é˜»æ­¢ç‡</div>
                    </div>
                    <i class="fas fa-percentage fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card dark">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stats-number" id="uniqueDomains">0</div>
                        <div class="stats-label">å”¯ä¸€åŸŸå</div>
                    </div>
                    <i class="fas fa-globe fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="stats-card info">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="stats-number" id="uniqueClients">0</div>
                        <div class="stats-label">å”¯ä¸€å®¢æˆ·ç«¯</div>
                    </div>
                    <i class="fas fa-users fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- æŸ¥è¯¢æ—¥å¿—è¡¨æ ¼ -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list"></i> æŸ¥è¯¢æ—¥å¿—</h5>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()"><i class="fas fa-sync"></i> åˆ·æ–°</button>
                <button class="btn btn-sm btn-outline-success" onclick="generateReport()"><i class="fas fa-chart-line"></i> ç”ŸæˆæŠ¥å‘Š</button>
            </div>
        </div>
        <div class="card-body">
            <div id="loadingIndicator" class="text-center py-5" style="display: none;">
                <div class="d-flex flex-column align-items-center">
                    <div class="loading-spinner mb-3" style="width: 3rem; height: 3rem;"></div>
                    <h6 class="text-muted mb-2">æ­£åœ¨åŠ è½½æ•°æ®...</h6>
                    <small class="text-muted">è¯·ç¨å€™ï¼Œæ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚</small>
                </div>
            </div>
            
            <div class="table-responsive" id="logTableContainer">
                <table class="table table-hover mb-0" id="logTable">
                    <thead class="table-light">
                        <tr>
                            <th class="border-0 fw-semibold text-muted"><i class="fas fa-clock me-1"></i>æ—¶é—´</th>
                            <th class="border-0 fw-semibold text-muted"><i class="fas fa-globe me-1"></i>åŸŸå</th>
                            <th class="border-0 fw-semibold text-muted"><i class="fas fa-tag me-1"></i>ç±»å‹</th>
                            <th class="border-0 fw-semibold text-muted"><i class="fas fa-desktop me-1"></i>å®¢æˆ·ç«¯</th>
                            <th class="border-0 fw-semibold text-muted"><i class="fas fa-info-circle me-1"></i>çŠ¶æ€</th>
                            <th class="border-0 fw-semibold text-muted"><i class="fas fa-stopwatch me-1"></i>å“åº”æ—¶é—´</th>
                            <th class="border-0 fw-semibold text-muted"><i class="fas fa-cog me-1"></i>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody">
                        <!-- æ—¥å¿—æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
            
            <div class="row mt-4" id="paginationContainer">
                <div class="col-md-6 d-flex align-items-center">
                    <div id="resultInfo" class="text-muted small">æ˜¾ç¤º 0 æ¡ç»“æœ</div>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-outline-primary btn-sm px-4" id="loadMoreBtn" onclick="loadMoreLogs()" style="display: none;">
                        <i class="fas fa-plus me-2"></i>åŠ è½½æ›´å¤š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AIåˆ†æç»“æœé¢æ¿ -->
    <div class="card border-0 shadow-sm mt-4" id="aiAnalysisPanel" style="display: none;">
        <div class="card-header bg-gradient-primary text-white border-0">
            <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-0"><i class="fas fa-brain me-2"></i>AI æ™ºèƒ½åˆ†æ</h5>
                <span class="badge bg-light text-primary">Beta</span>
            </div>
        </div>
        <div class="card-body p-4" id="aiAnalysisContent">
            <div class="d-flex align-items-center justify-content-center py-4">
                <div class="text-center">
                    <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-0">AIåˆ†æç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title"><i class="fas fa-download me-2"></i>å¯¼å‡ºæŸ¥è¯¢æ—¥å¿—</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <form id="exportForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="exportFormat" class="form-label fw-semibold"><i class="fas fa-file-export me-2"></i>å¯¼å‡ºæ ¼å¼</label>
                                <select class="form-control" id="exportFormat">
                                    <option value="csv">ğŸ“Š CSV æ ¼å¼</option>
                                    <option value="json">ğŸ“„ JSON æ ¼å¼</option>
                                    <option value="xlsx">ğŸ“ˆ Excel æ ¼å¼</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="maxRecords" class="form-label fw-semibold"><i class="fas fa-list-ol me-2"></i>æœ€å¤§è®°å½•æ•°</label>
                                <input type="number" class="form-control" id="maxRecords" value="10000" min="1" max="100000">
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="border rounded p-3 bg-light">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="useCurrentFilters" checked>
                                <label class="form-check-label fw-semibold" for="useCurrentFilters">
                                    <i class="fas fa-filter me-2"></i>ä½¿ç”¨å½“å‰æœç´¢æ¡ä»¶
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info border-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>æç¤ºï¼š</strong>å¯¼å‡ºå°†åŒ…å«å½“å‰æœç´¢æ¡ä»¶ä¸‹çš„æ‰€æœ‰ç»“æœã€‚å¤§é‡æ•°æ®å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´å¤„ç†ã€‚
                    </div>
                </form>
                <div class="export-progress">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted">æ­£åœ¨å¯¼å‡ºï¼Œè¯·ç¨å€™...</small>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-primary" onclick="startExport()">
                    <i class="fas fa-download me-2"></i>å¼€å§‹å¯¼å‡º
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AIåˆ†ææ¨¡æ€æ¡† -->
<div class="modal fade" id="aiAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-gradient-primary text-white border-0">
                <h5 class="modal-title"><i class="fas fa-robot me-2"></i>AIåŸŸååˆ†æ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-4">
                    <label for="analysisMode" class="form-label fw-semibold"><i class="fas fa-cogs me-2"></i>åˆ†ææ¨¡å¼</label>
                    <select class="form-control" id="analysisMode">
                        <option value="single">ğŸ¯ å•ä¸ªåŸŸååˆ†æ</option>
                        <option value="batch">ğŸ“‹ æ‰¹é‡åŸŸååˆ†æ</option>
                        <option value="auto">ğŸ¤– è‡ªåŠ¨åˆ†æå½“å‰ç»“æœ</option>
                    </select>
                </div>
                
                <div id="singleAnalysisPanel" class="border rounded p-3 bg-light">
                    <div class="form-group">
                        <label for="singleDomain" class="form-label fw-semibold"><i class="fas fa-globe me-2"></i>åŸŸå</label>
                        <input type="text" class="form-control" id="singleDomain" placeholder="è¾“å…¥è¦åˆ†æçš„åŸŸå">
                    </div>
                </div>
                
                <div id="batchAnalysisPanel" class="border rounded p-3 bg-light" style="display: none;">
                    <div class="form-group">
                        <label for="batchDomains" class="form-label fw-semibold"><i class="fas fa-list me-2"></i>åŸŸååˆ—è¡¨</label>
                        <textarea class="form-control" id="batchDomains" rows="5" placeholder="æ¯è¡Œä¸€ä¸ªåŸŸå"></textarea>
                        <small class="form-text text-muted">æ”¯æŒæ‰¹é‡è¾“å…¥ï¼Œæ¯è¡Œä¸€ä¸ªåŸŸå</small>
                    </div>
                </div>
                
                <div id="autoAnalysisPanel" class="border rounded p-3 bg-light" style="display: none;">
                    <div class="alert alert-info border-0 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>è‡ªåŠ¨åˆ†ææ¨¡å¼ï¼š</strong>å°†è‡ªåŠ¨åˆ†æå½“å‰æœç´¢ç»“æœä¸­çš„æ‰€æœ‰åŸŸå
                    </div>
                </div>
                
                <div id="aiAnalysisProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>AIåˆ†æä¸­ï¼Œè¯·ç¨å€™...</small>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-ai" onclick="startAIAnalysis()">
                    <i class="fas fa-brain me-2"></i>å¼€å§‹åˆ†æ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†ææŠ¥å‘Šæ¨¡æ€æ¡† -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-gradient-success text-white border-0">
                <h5 class="modal-title"><i class="fas fa-chart-line me-2"></i>DNSæŸ¥è¯¢è¶‹åŠ¿åˆ†ææŠ¥å‘Š</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body p-4">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <label for="reportTimeRange" class="form-label fw-semibold"><i class="fas fa-clock me-2"></i>æ—¶é—´èŒƒå›´</label>
                                <div class="d-flex gap-2">
                                    <select class="form-control" id="reportTimeRange">
                                        <option value="1h">â° æœ€è¿‘1å°æ—¶</option>
                                        <option value="6h">ğŸ•• æœ€è¿‘6å°æ—¶</option>
                                        <option value="24h" selected>ğŸ“… æœ€è¿‘24å°æ—¶</option>
                                        <option value="7d">ğŸ“Š æœ€è¿‘7å¤©</option>
                                        <option value="30d">ğŸ“ˆ æœ€è¿‘30å¤©</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="generateAnalysisReport()">
                                        <i class="fas fa-chart-bar me-2"></i>ç”ŸæˆæŠ¥å‘Š
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="reportContent" class="border rounded p-3 bg-light">
                    <div class="text-center py-5">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">é€‰æ‹©æ—¶é—´èŒƒå›´å¹¶ç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"å¼€å§‹åˆ†æ</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>å…³é—­
                </button>
                <button type="button" class="btn btn-success" onclick="exportReport()">
                    <i class="fas fa-file-export me-2"></i>å¯¼å‡ºæŠ¥å‘Š
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
        $(document).ready(function() {
            // åˆå§‹åŒ–æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);

            const formatDateTimeLocal = (date) => {
                const pad = (num) => num.toString().padStart(2, '0');
                const year = date.getFullYear();
                const month = pad(date.getMonth() + 1);
                const day = pad(date.getDate());
                const hours = pad(date.getHours());
                const minutes = pad(date.getMinutes());
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };

            $('#start-time').val(formatDateTimeLocal(oneHourAgo));
            $('#end-time').val(formatDateTimeLocal(now));
            performSearch();
        });
let currentLogs = [];
let currentOlderThan = null;
let hasMoreLogs = false;
let currentFilters = {};



// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸ºæœ¬åœ°æ ¼å¼
function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    
    return `${year}-${month}-${day}T${hours}:${minutes}`;
}

// æ‰§è¡Œæœç´¢
function performSearch() {
    // æ”¶é›†è¿‡æ»¤æ¡ä»¶
    currentFilters = {
        domain: $('#domainFilter').val(),
        client: $('#clientFilter').val(),
        query_type: $('#queryTypeFilter').val(),
        status: $('#blockedFilter').val(),
        start_time: $('#startTimeFilter').val() ? new Date($('#startTimeFilter').val()).toISOString() : null,
        end_time: $('#endTimeFilter').val() ? new Date($('#endTimeFilter').val()).toISOString() : null,
        reason: $('#reasonFilter').val()
    };
    
    // æ¸…é™¤ç©ºå€¼
    Object.keys(currentFilters).forEach(key => {
        if (currentFilters[key] === '' || currentFilters[key] === null) {
            delete currentFilters[key];
        }
    });
    
    // é‡ç½®åˆ†é¡µ
    currentLogs = [];
    currentOlderThan = null;
    
    // æ‰§è¡Œæœç´¢
    searchLogs();
}

// æœç´¢æ—¥å¿—
function searchLogs() {
    $('#loadingIndicator').show();
    
    $.ajax({
        url: '/admin/api/query-log/advanced-search',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            filters: currentFilters,
            page_size: 50,
            older_than: currentOlderThan
        }),
        success: function(response) {
            if (response.success) {
                const data = response.data;
                
                if (currentOlderThan === null) {
                    // é¦–æ¬¡æœç´¢ï¼Œæ¸…ç©ºè¡¨æ ¼
                    currentLogs = data.data;
                    updateLogTable(currentLogs);
                    updateStats(data.stats);
                } else {
                    // åŠ è½½æ›´å¤šï¼Œè¿½åŠ æ•°æ®
                    currentLogs = currentLogs.concat(data.data);
                    appendLogTable(data.data);
                }
                
                currentOlderThan = data.oldest;
                hasMoreLogs = data.has_more;
                
                $('#loadMoreBtn').toggle(hasMoreLogs);
                $('#resultInfo').text(`æ˜¾ç¤º ${currentLogs.length} æ¡ç»“æœ`);
            } else {
                showAlert('æœç´¢å¤±è´¥: ' + response.error, 'danger');
            }
        },
        error: function() {
            showAlert('æœç´¢è¯·æ±‚å¤±è´¥', 'danger');
        },
        complete: function() {
            $('#loadingIndicator').hide();
        }
    });
}

// æ›´æ–°æ—¥å¿—è¡¨æ ¼
function updateLogTable(logs) {
    const tbody = $('#logTableBody');
    tbody.empty();
    appendLogTable(logs);
}

// è¿½åŠ æ—¥å¿—åˆ°è¡¨æ ¼
function appendLogTable(logs) {
    const tbody = $('#logTableBody');
    
    logs.forEach(function(log) {
        const row = createLogRow(log);
        tbody.append(row);
    });
}

// åˆ›å»ºæ—¥å¿—è¡Œ
function createLogRow(log) {
    // ä½¿ç”¨æ–°çš„APIå­—æ®µæ ¼å¼
    const time = log.time ? new Date(log.time).toLocaleString() : 'Invalid Date';
    const question = log.question || {};
    const domain = question.name || '';
    const queryType = question.type || '';
    const client = log.client || '';
    const clientInfo = log.client_info || {};
    const clientName = clientInfo.name || client;
    const elapsed = log.elapsedMs ? log.elapsedMs + 'ms' : '';
    
    // åˆ¤æ–­æ˜¯å¦è¢«é˜»æ­¢
    const reason = log.reason || '';
    const isBlocked = reason && reason !== 'NotFilteredNotFound';
    
    let statusBadge;
    if (isBlocked) {
        statusBadge = `<span class="badge badge-danger">å·²é˜»æ­¢</span>`;
        if (reason) {
            statusBadge += `<br><small class="text-muted">${reason}</small>`;
        }
    } else {
        statusBadge = `<span class="badge badge-success">å·²å…è®¸</span>`;
    }
    
    return `
        <tr>
            <td>${time}</td>
            <td>
                <span class="domain-name">${domain}</span>
                <button class="btn btn-sm btn-outline-primary ml-1" onclick="analyzeDomain('${domain}')" title="AIåˆ†æ">
                    <i class="fas fa-robot"></i>
                </button>
            </td>
            <td>${queryType}</td>
            <td>${clientName}</td>
            <td>${statusBadge}</td>
            <td>${elapsed}</td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="showLogDetails('${encodeURIComponent(JSON.stringify(log))}')" title="è¯¦æƒ…">
                    <i class="fas fa-info-circle"></i>
                </button>
            </td>
        </tr>
    `;
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats(stats) {
    if (stats) {
        $('#totalQueries').text(stats.total_queries || 0);
        $('#blockedQueries').text(stats.blocked_queries || 0);
        $('#allowedQueries').text(stats.allowed_queries || 0);
        
        const blockRate = stats.total_queries > 0 ? 
            ((stats.blocked_queries / stats.total_queries) * 100).toFixed(1) : 0;
        $('#blockRate').text(blockRate + '%');
        
        $('#uniqueDomains').text(stats.unique_domains_count || 0);
        $('#uniqueClients').text(stats.unique_clients_count || 0);
        
        $('#statsContainer').show();
    }
}

// æ¸…é™¤è¿‡æ»¤æ¡ä»¶
function clearFilters() {
    $('#searchForm')[0].reset();
    currentFilters = {};
    performSearch();
}

// åˆ·æ–°æ—¥å¿—
function refreshLogs() {
    performSearch();
}

// åŠ è½½æ›´å¤šæ—¥å¿—
function loadMoreLogs() {
    if (hasMoreLogs) {
        searchLogs();
    }
}

// æ˜¾ç¤ºå¯¼å‡ºæ¨¡æ€æ¡†
function showExportModal() {
    $('#exportModal').modal('show');
}

// å¼€å§‹å¯¼å‡º
function startExport() {
    const format = $('#exportFormat').val();
    const maxRecords = parseInt($('#maxRecords').val());
    const useCurrentFilters = $('#useCurrentFilters').is(':checked');
    
    const exportData = {
        format: format,
        max_records: maxRecords,
        filters: useCurrentFilters ? currentFilters : {}
    };
    
    $('.export-progress').show();
    
    $.ajax({
        url: '/admin/api/query-log/export',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(exportData),
        success: function(response) {
            if (response.success) {
                showAlert('å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶è·¯å¾„: ' + response.file_path, 'success');
                $('#exportModal').modal('hide');
            } else {
                showAlert('å¯¼å‡ºå¤±è´¥: ' + response.error, 'danger');
            }
        },
        error: function() {
            showAlert('å¯¼å‡ºè¯·æ±‚å¤±è´¥', 'danger');
        },
        complete: function() {
            $('.export-progress').hide();
        }
    });
}

// æ˜¾ç¤ºAIåˆ†ææ¨¡æ€æ¡†
function showAIAnalysisModal() {
    $('#aiAnalysisModal').modal('show');
}

// å¼€å§‹AIåˆ†æ
function startAIAnalysis() {
    const mode = $('#analysisMode').val();
    let analysisData = {};
    
    if (mode === 'single') {
        const domain = $('#singleDomain').val().trim();
        if (!domain) {
            showAlert('è¯·è¾“å…¥è¦åˆ†æçš„åŸŸå', 'warning');
            return;
        }
        analysisData = { domain: domain };
    } else if (mode === 'batch') {
        const domainsText = $('#batchDomains').val().trim();
        if (!domainsText) {
            showAlert('è¯·è¾“å…¥è¦åˆ†æçš„åŸŸååˆ—è¡¨', 'warning');
            return;
        }
        const domains = domainsText.split('\n').map(d => d.trim()).filter(d => d);
        analysisData = { domains: domains };
    } else if (mode === 'auto') {
        const domains = [...new Set(currentLogs.map(log => log.question?.name).filter(d => d))];
        if (domains.length === 0) {
            showAlert('å½“å‰æœç´¢ç»“æœä¸­æ²¡æœ‰åŸŸåå¯åˆ†æ', 'warning');
            return;
        }
        analysisData = { domains: domains };
    }
    
    $('#aiAnalysisProgress').show();
    
    const url = mode === 'single' ? '/admin/api/ai-analysis/domain' : '/admin/api/ai-analysis/domains/batch';
    
    $.ajax({
        url: url,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(analysisData),
        success: function(response) {
            if (response.success) {
                displayAIAnalysisResultsInModal(response);
                // ä¸å…³é—­æ¨¡æ€æ¡†ï¼Œåœ¨æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºç»“æœ
            } else {
                showAlert('AIåˆ†æå¤±è´¥: ' + response.error, 'danger');
            }
        },
        error: function() {
            showAlert('AIåˆ†æè¯·æ±‚å¤±è´¥', 'danger');
        },
        complete: function() {
            $('#aiAnalysisProgress').hide();
        }
    });
}

// åˆ†æå•ä¸ªåŸŸå
function analyzeDomain(domain) {
    // é‡ç½®æ¨¡æ€æ¡†çŠ¶æ€
    resetAIAnalysisModal();
    
    // è®¾ç½®åŸŸåå’Œæ¨¡å¼
    $('#singleDomain').val(domain);
    $('#analysisMode').val('single').trigger('change');
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    showAIAnalysisModal();
}

// æ˜¾ç¤ºAIåˆ†æç»“æœ
function displayAIAnalysisResults(response) {
    const panel = $('#aiAnalysisPanel');
    const content = $('#aiAnalysisContent');
    
    let html = '';
    
    if (response.analysis) {
        // å•ä¸ªåŸŸååˆ†æç»“æœ
        html = createAnalysisCard(response.analysis.domain, response.analysis);
    } else if (response.results) {
        // æ‰¹é‡åˆ†æç»“æœ
        Object.entries(response.results).forEach(([domain, analysis]) => {
            html += createAnalysisCard(domain, analysis);
        });
    }
    
    content.html(html);
    panel.show();
}

// åœ¨æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºAIåˆ†æç»“æœ
function displayAIAnalysisResultsInModal(response) {
    // éšè—åˆ†æè¿›åº¦æ¡
    $('#aiAnalysisProgress').hide();
    
    // éšè—åˆ†æé…ç½®é¢æ¿
    $('#singleAnalysisPanel, #batchAnalysisPanel, #autoAnalysisPanel').hide();
    $('#analysisMode').closest('.mb-4').hide();
    
    let html = '<div id="aiAnalysisResults" class="mt-3">';
    html += '<h6 class="mb-3"><i class="fas fa-brain me-2"></i>AIåˆ†æç»“æœ</h6>';
    
    if (response.analysis) {
        // å•ä¸ªåŸŸååˆ†æç»“æœ
        html += createAnalysisCardForModal(response.analysis.domain, response.analysis);
    } else if (response.results) {
        // æ‰¹é‡åˆ†æç»“æœ
        Object.entries(response.results).forEach(([domain, analysis]) => {
            html += createAnalysisCardForModal(domain, analysis);
        });
    }
    
    html += '</div>';
    
    // åœ¨æ¨¡æ€æ¡†bodyä¸­æ·»åŠ ç»“æœ
    $('.modal-body').append(html);
    
    // ä¿®æ”¹æ¨¡æ€æ¡†åº•éƒ¨æŒ‰é’®
    $('.modal-footer').html(`
        <button type="button" class="btn btn-outline-secondary" onclick="resetAIAnalysisModal()">
            <i class="fas fa-arrow-left me-2"></i>é‡æ–°åˆ†æ
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>å…³é—­
        </button>
    `);
}

// åˆ›å»ºåˆ†æç»“æœå¡ç‰‡
function createAnalysisCard(domain, analysis) {
    const confidenceClass = analysis.confidence >= 0.8 ? 'confidence-high' : 
                           analysis.confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';
    
    const typeClass = {
        'ad': 'tag-ad',
        'tracker': 'tag-tracker', 
        'malware': 'tag-malware',
        'legitimate': 'tag-legitimate'
    }[analysis.analysis_type] || 'tag-legitimate';
    
    return `
        <div class="ai-analysis-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">${domain}</h6>
                    <span class="domain-tag ${typeClass}">${analysis.analysis_type}</span>
                    ${analysis.category ? `<span class="badge badge-secondary">${analysis.category}</span>` : ''}
                </div>
                <div class="text-right">
                    <small class="text-muted">ç½®ä¿¡åº¦: ${(analysis.confidence * 100).toFixed(1)}%</small>
                    <div class="confidence-bar">
                        <div class="confidence-fill ${confidenceClass}" style="width: ${analysis.confidence * 100}%"></div>
                    </div>
                </div>
            </div>
            <p class="mb-2 mt-2">${analysis.description || 'æ— è¯¦ç»†æè¿°'}</p>
            <div class="d-flex justify-content-between align-items-center">
                <span class="badge badge-${analysis.recommendation === 'block' ? 'danger' : analysis.recommendation === 'monitor' ? 'warning' : 'success'}">
                    æ¨è: ${analysis.recommendation}
                </span>
                <div>
                    <button class="btn btn-sm btn-outline-success" onclick="reviewAnalysis(${analysis.id}, 'allow')" title="å…è®¸">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="reviewAnalysis(${analysis.id}, 'block')" title="é˜»æ­¢">
                        <i class="fas fa-ban"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="reviewAnalysis(${analysis.id}, 'ignore')" title="å¿½ç•¥">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

// åˆ›å»ºæ¨¡æ€æ¡†ä¸­çš„åˆ†æç»“æœå¡ç‰‡
function createAnalysisCardForModal(domain, analysis) {
    const confidenceClass = analysis.confidence >= 0.8 ? 'confidence-high' : 
                           analysis.confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';
    
    const typeClass = {
        'ad': 'tag-ad',
        'tracker': 'tag-tracker', 
        'malware': 'tag-malware',
        'legitimate': 'tag-legitimate'
    }[analysis.analysis_type] || 'tag-legitimate';
    
    const recommendationText = {
        'block': 'é˜»æ­¢',
        'allow': 'å…è®¸',
        'monitor': 'ç›‘æ§'
    }[analysis.recommendation] || analysis.recommendation;
    
    return `
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h6 class="mb-1 text-primary">${domain}</h6>
                        <span class="badge bg-${analysis.analysis_type === 'ad' ? 'danger' : analysis.analysis_type === 'tracker' ? 'warning' : analysis.analysis_type === 'malware' ? 'dark' : 'success'} me-2">
                            ${analysis.analysis_type}
                        </span>
                        ${analysis.category ? `<span class="badge bg-secondary">${analysis.category}</span>` : ''}
                    </div>
                    <div class="text-end">
                        <small class="text-muted d-block">ç½®ä¿¡åº¦</small>
                        <strong class="text-${analysis.confidence >= 0.8 ? 'success' : analysis.confidence >= 0.5 ? 'warning' : 'danger'}">
                            ${(analysis.confidence * 100).toFixed(1)}%
                        </strong>
                    </div>
                </div>
                
                <p class="text-muted mb-3">${analysis.description || 'æ— è¯¦ç»†æè¿°'}</p>
                
                <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-${analysis.recommendation === 'block' ? 'danger' : analysis.recommendation === 'monitor' ? 'warning' : 'success'} fs-6">
                        AIæ¨è: ${recommendationText}
                    </span>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-success btn-sm" onclick="reviewAnalysisInModal(${analysis.id}, 'allow', '${domain}')" title="å…è®¸æ­¤åŸŸå">
                            <i class="fas fa-check me-1"></i>å…è®¸
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="reviewAnalysisInModal(${analysis.id}, 'block', '${domain}')" title="é˜»æ­¢æ­¤åŸŸå">
                            <i class="fas fa-ban me-1"></i>é˜»æ­¢
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="reviewAnalysisInModal(${analysis.id}, 'ignore', '${domain}')" title="å¿½ç•¥æ­¤åˆ†æ">
                            <i class="fas fa-times me-1"></i>å¿½ç•¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// å®¡æ ¸åˆ†æç»“æœ
function reviewAnalysis(analysisId, action) {
    const notes = prompt('è¯·è¾“å…¥å®¡æ ¸å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:');
    
    $.ajax({
        url: '/admin/api/ai-analysis/review',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            analysis_id: analysisId,
            action: action,
            notes: notes || ''
        }),
        success: function(response) {
            if (response.success) {
                showAlert('å®¡æ ¸å®Œæˆ', 'success');
                // åˆ·æ–°åˆ†æç»“æœ
                location.reload();
            } else {
                showAlert('å®¡æ ¸å¤±è´¥: ' + response.error, 'danger');
            }
        },
        error: function() {
            showAlert('å®¡æ ¸è¯·æ±‚å¤±è´¥', 'danger');
        }
    });
}

// åœ¨æ¨¡æ€æ¡†ä¸­å®¡æ ¸åˆ†æç»“æœ
function reviewAnalysisInModal(analysisId, action, domain) {
    const actionText = {
        'allow': 'å…è®¸',
        'block': 'é˜»æ­¢',
        'ignore': 'å¿½ç•¥'
    }[action];
    
    const confirmMessage = `ç¡®å®šè¦${actionText}åŸŸå "${domain}" å—ï¼Ÿ`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    const notes = prompt('è¯·è¾“å…¥å®¡æ ¸å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:');
    
    $.ajax({
        url: '/admin/api/ai-analysis/review',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            analysis_id: analysisId,
            action: action,
            notes: notes || ''
        }),
        success: function(response) {
            if (response.success) {
                showAlert(`å·²${actionText}åŸŸå "${domain}"`, 'success');
                // ç§»é™¤å·²å®¡æ ¸çš„å¡ç‰‡
                $(`button[onclick*="reviewAnalysisInModal(${analysisId}"]`).closest('.card').fadeOut(300, function() {
                    $(this).remove();
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªå®¡æ ¸çš„ç»“æœ
                    if ($('#aiAnalysisResults .card').length === 0) {
                        $('#aiAnalysisResults').html('<div class="alert alert-success text-center"><i class="fas fa-check-circle me-2"></i>æ‰€æœ‰åˆ†æç»“æœå·²å®¡æ ¸å®Œæˆ</div>');
                    }
                });
            } else {
                showAlert('å®¡æ ¸å¤±è´¥: ' + response.error, 'danger');
            }
        },
        error: function() {
            showAlert('å®¡æ ¸è¯·æ±‚å¤±è´¥', 'danger');
        }
    });
}

// é‡ç½®AIåˆ†ææ¨¡æ€æ¡†
function resetAIAnalysisModal() {
    // ç§»é™¤åˆ†æç»“æœ
    $('#aiAnalysisResults').remove();
    
    // æ˜¾ç¤ºåˆ†æé…ç½®é¢æ¿
    $('#analysisMode').closest('.mb-4').show();
    $('#analysisMode').val('single').trigger('change');
    
    // æ¸…ç©ºè¾“å…¥
    $('#singleDomain').val('');
    $('#batchDomains').val('');
    
    // éšè—è¿›åº¦æ¡
    $('#aiAnalysisProgress').hide();
    
    // æ¢å¤åŸå§‹åº•éƒ¨æŒ‰é’®
    $('.modal-footer').html(`
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>å–æ¶ˆ
        </button>
        <button type="button" class="btn btn-ai" onclick="startAIAnalysis()">
            <i class="fas fa-brain me-2"></i>å¼€å§‹åˆ†æ
        </button>
    `);
}

// ç”ŸæˆæŠ¥å‘Š
function generateReport() {
    $('#reportModal').modal('show');
}

// ç”Ÿæˆåˆ†ææŠ¥å‘Š
function generateAnalysisReport() {
    const timeRange = $('#reportTimeRange').val();
    
    $.ajax({
        url: '/admin/api/query-log/analysis-report',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ time_range: timeRange }),
        success: function(response) {
            if (response.success) {
                displayReport(response.report);
            } else {
                showAlert('ç”ŸæˆæŠ¥å‘Šå¤±è´¥: ' + response.error, 'danger');
            }
        },
        error: function() {
            showAlert('ç”ŸæˆæŠ¥å‘Šè¯·æ±‚å¤±è´¥', 'danger');
        }
    });
}

// æ˜¾ç¤ºæŠ¥å‘Š
function displayReport(report) {
    const content = $('#reportContent');
    
    let html = `
        <div class="row">
            <div class="col-md-12">
                <h6>æ¦‚è§ˆ</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${report.summary.total_queries}</h5>
                                <p class="card-text">æ€»æŸ¥è¯¢æ•°</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${report.summary.blocked_queries}</h5>
                                <p class="card-text">å·²é˜»æ­¢</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${report.summary.block_rate}%</h5>
                                <p class="card-text">é˜»æ­¢ç‡</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${report.summary.unique_domains}</h5>
                                <p class="card-text">å”¯ä¸€åŸŸå</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <h6>æŸ¥è¯¢è¶‹åŠ¿</h6>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <h6>çƒ­é—¨åŸŸå</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr><th>åŸŸå</th><th>æŸ¥è¯¢æ¬¡æ•°</th></tr>
                        </thead>
                        <tbody>
    `;
    
    Object.entries(report.top_domains || {}).slice(0, 10).forEach(([domain, count]) => {
        html += `<tr><td>${domain}</td><td>${count}</td></tr>`;
    });
    
    html += `
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-md-6">
                <h6>çƒ­é—¨è¢«é˜»æ­¢åŸŸå</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr><th>åŸŸå</th><th>é˜»æ­¢æ¬¡æ•°</th></tr>
                        </thead>
                        <tbody>
    `;
    
    Object.entries(report.top_blocked_domains || {}).slice(0, 10).forEach(([domain, count]) => {
        html += `<tr><td>${domain}</td><td>${count}</td></tr>`;
    });
    
    html += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    content.html(html);
    
    // ç»˜åˆ¶è¶‹åŠ¿å›¾
    drawTrendChart(report.time_series);
}

// ç»˜åˆ¶è¶‹åŠ¿å›¾
function drawTrendChart(timeSeries) {
    const ctx = document.getElementById('trendChart').getContext('2d');
    
    const labels = timeSeries.map(item => new Date(item.timestamp).toLocaleTimeString());
    const totalData = timeSeries.map(item => item.total_queries);
    const blockedData = timeSeries.map(item => item.blocked_queries);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'æ€»æŸ¥è¯¢æ•°',
                data: totalData,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }, {
                label: 'è¢«é˜»æ­¢æŸ¥è¯¢æ•°',
                data: blockedData,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// æ˜¾ç¤ºæ—¥å¿—è¯¦æƒ…
function showLogDetails(encodedLog) {
    const log = JSON.parse(decodeURIComponent(encodedLog));
    const question = log.question || {};
    const clientInfo = log.client_info || {};
    
    let details = `
        <div class="row">
            <div class="col-md-6">
                <p><strong><i class="fas fa-clock me-2"></i>æ—¶é—´:</strong> ${log.time ? new Date(log.time).toLocaleString() : 'N/A'}</p>
                <p><strong><i class="fas fa-globe me-2"></i>åŸŸå:</strong> ${question.name || 'N/A'}</p>
                <p><strong><i class="fas fa-tag me-2"></i>æŸ¥è¯¢ç±»å‹:</strong> ${question.type || 'N/A'}</p>
                <p><strong><i class="fas fa-desktop me-2"></i>å®¢æˆ·ç«¯IP:</strong> ${log.client || 'N/A'}</p>
            </div>
            <div class="col-md-6">
                <p><strong><i class="fas fa-user me-2"></i>å®¢æˆ·ç«¯åç§°:</strong> ${clientInfo.name || log.client || 'N/A'}</p>
                <p><strong><i class="fas fa-stopwatch me-2"></i>å“åº”æ—¶é—´:</strong> ${log.elapsedMs ? log.elapsedMs + 'ms' : 'N/A'}</p>
                <p><strong><i class="fas fa-server me-2"></i>ä¸Šæ¸¸æœåŠ¡å™¨:</strong> ${log.upstream || 'N/A'}</p>
                <p><strong><i class="fas fa-memory me-2"></i>ç¼“å­˜:</strong> 
                    <span class="badge ${log.cached ? 'bg-success' : 'bg-secondary'}">
                        ${log.cached ? 'æ˜¯' : 'å¦'}
                    </span>
                </p>
            </div>
        </div>
    `;
    
    // æ·»åŠ çŠ¶æ€ä¿¡æ¯
    const reason = log.reason || '';
    const isBlocked = reason && reason !== 'NotFilteredNotFound';
    
    details += `
        <hr>
        <div class="row">
            <div class="col-md-6">
                <p><strong><i class="fas fa-code me-2"></i>çŠ¶æ€:</strong> ${log.status || 'N/A'}</p>
                <p><strong><i class="fas fa-shield-alt me-2"></i>æ˜¯å¦è¢«è¿‡æ»¤:</strong> 
                    <span class="badge ${isBlocked ? 'bg-danger' : 'bg-success'}">
                        ${isBlocked ? 'æ˜¯' : 'å¦'}
                    </span>
                </p>
            </div>
            <div class="col-md-6">
    `;
    
    if (isBlocked && reason) {
        details += `<p><strong><i class="fas fa-ban me-2"></i>é˜»æ­¢åŸå› :</strong> <span class="text-danger">${reason}</span></p>`;
    }
    
    details += `</div></div>`;
    
    // æ˜¾ç¤ºDNSåº”ç­”
    if (log.answer && log.answer.length > 0) {
        details += `
            <hr>
            <h6><i class="fas fa-list me-2"></i>DNSåº”ç­”:</h6>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>ç±»å‹</th>
                            <th>å€¼</th>
                            <th>TTL</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        log.answer.forEach(answer => {
            details += `<tr><td><span class="badge bg-primary">${answer.type || 'N/A'}</span></td><td><code>${answer.value || 'N/A'}</code></td><td>${answer.ttl || 'N/A'}</td></tr>`;
        });
        details += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    showLogDetailsModal(details);
}

// æ˜¾ç¤ºæ—¥å¿—è¯¦æƒ…æ¨¡æ€æ¡†
function showLogDetailsModal(content) {
    // åˆ›å»ºæ¨¡æ€æ¡†HTML
    const modalHtml = `
        <div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-primary text-white border-0">
                        <h5 class="modal-title" id="logDetailsModalLabel">
                            <i class="fas fa-info-circle me-2"></i>æ—¥å¿—è¯¦æƒ…
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body p-4">
                        ${content}
                    </div>
                    <div class="modal-footer border-0 bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>å…³é—­
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
    $('#logDetailsModal').remove();
    
    // æ·»åŠ æ–°çš„æ¨¡æ€æ¡†åˆ°é¡µé¢
    $('body').append(modalHtml);
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    $('#logDetailsModal').modal('show');
    
    // æ¨¡æ€æ¡†å…³é—­åç§»é™¤DOMå…ƒç´ 
    $('#logDetailsModal').on('hidden.bs.modal', function () {
        $(this).remove();
    });
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type = 'info', title = '') {
    const alertClass = {
        'success': 'alert-success',
        'danger': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${title ? `<strong>${title}</strong><br>` : ''}
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    `;
    
    // åœ¨é¡µé¢å†…å®¹åŒºåŸŸé¡¶éƒ¨æ˜¾ç¤ºæç¤ºï¼Œé¿å…æ·»åŠ åˆ°å¯¼èˆªæ 
    // é€‰æ‹©å¯¼èˆªæ ä¹‹åçš„ç¬¬ä¸€ä¸ªcontainerï¼Œè¿™æ˜¯é¡µé¢ä¸»è¦å†…å®¹åŒºåŸŸ
    const container = $('nav').next('.container, .container-fluid');
    if (container.length > 0) {
        container.prepend(alertHtml);
    } else {
        // å¤‡ç”¨æ–¹æ¡ˆï¼šé€‰æ‹©é¡µé¢ä¸­çš„æœ€åä¸€ä¸ªcontainer-fluidï¼ˆé€šå¸¸æ˜¯é¡µé¢å†…å®¹ï¼‰
        $('.container-fluid').last().prepend(alertHtml);
    }
    
    // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}
</script>
{% endblock %}