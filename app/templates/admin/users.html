{% extends "admin/base.html" %}

{% block page_content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">用户管理</h2>
        <button type="button" class="btn btn-info btn-sm" id="deleteStatusBtn" onclick="showDeleteStatus()" style="display: none;">
            <i class="fas fa-tasks"></i> 查看删除状态
        </button>
    </div>
    
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <div class="mb-3">
                    <button type="button" class="btn btn-primary" onclick="showBulkEmailModal()" id="bulkEmailBtn" disabled>
                        <i class="fas fa-envelope"></i> 批量发送邮件
                    </button>
                    <button type="button" class="btn btn-danger ms-2" onclick="showBulkDeleteModal()" id="bulkDeleteBtn" disabled>
                         <i class="fas fa-trash"></i> 删除用户（逐个）
                     </button>
                    <button type="button" class="btn btn-warning ms-2" onclick="filterZeroDnsUsers()" id="filterZeroDnsBtn">
                        <i class="fas fa-filter"></i> 筛选DNS请求数为0的用户
                    </button>
                    <button type="button" class="btn btn-secondary ms-2" onclick="clearFilter()" id="clearFilterBtn" style="display: none;">
                        <i class="fas fa-times"></i> 清除筛选
                    </button>
                    <button type="button" class="btn btn-success ms-2" onclick="showAdGuardClientsModal()" id="adguardClientsBtn">
                        <i class="fas fa-network-wired"></i> 查询AdGuard客户端
                    </button>
                    <span class="ms-2 text-muted" id="selectedCount">已选择 0 个用户</span>
                    <span class="ms-2 text-info" id="filterStatus" style="display: none;"></span>
                </div>
                
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                <label for="selectAll" class="ms-1">全选</label>
                            </th>
                            <th>ID</th>
                            <th>用户名</th>
                            <th>注册邮箱</th>
                            <th>注册时间</th>
                            <th>客户端数</th>
                            <th>DNS请求数</th>
                            <th>客户端名称</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>
                                {% if user.email %}
                                <input type="checkbox" class="user-checkbox" value="{{ user.id }}" data-email="{{ user.email }}" onchange="updateSelectedCount()">
                                {% else %}
                                <span class="text-muted">无邮箱</span>
                                {% endif %}
                            </td>
                            <td>{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>
                                {% if user.email %}
                                    {{ user.email }}
                                {% else %}
                                    <span class="text-muted">未设置</span>
                                {% endif %}
                            </td>
                            <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>{{ user.client_mappings|length }}</td>
                            <td>
                                <span class="badge badge-info">
                                    {{ user_stats.get(user.id, 0) }}
                                </span>
                            </td>
                            <td>
                                {% if user.client_mappings %}
                                <ul class="list-unstyled mb-0">
                                    {% for mapping in user.client_mappings %}
                                    <li>{{ mapping.client_name }}</li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <span class="text-muted">无客户端</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('admin.user_clients', user_id=user.id) }}" class="btn btn-sm btn-primary">查看客户端</a>
                                    {% if not user.is_admin %}
                                    <button onclick="deleteUser({{ user.id }})" class="btn btn-sm btn-danger">删除用户</button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 批量邮件发送模态框 -->
<div class="modal fade" id="bulkEmailModal" tabindex="-1" aria-labelledby="bulkEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkEmailModalLabel">批量发送邮件</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulkEmailForm">
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">邮件主题 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="emailSubject" name="subject" required placeholder="请输入邮件主题">
                    </div>
                    <div class="mb-3">
                        <label for="emailMessage" class="form-label">邮件内容 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="emailMessage" name="message" rows="8" required placeholder="请输入邮件内容，支持HTML格式"></textarea>
                        <div class="form-text">支持HTML格式，如 &lt;br&gt; 换行、&lt;b&gt;粗体&lt;/b&gt; 等</div>
                    </div>
                    <div class="mb-3">
                        <label for="additionalInfo" class="form-label">附加信息</label>
                        <textarea class="form-control" id="additionalInfo" name="additional_info" rows="3" placeholder="可选的附加信息"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span id="recipientInfo">将发送给 0 个用户</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="sendBulkEmail()" id="sendEmailBtn">
                    <i class="fas fa-paper-plane"></i> 发送邮件
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 批量删除用户模态框 -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkDeleteModalLabel">删除用户（逐个删除）</h5>
                <div>
                    <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="minimizeDeleteModal" onclick="minimizeDeleteModal()" title="最小化">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>警告：</strong>此操作将永久删除选中的用户及其所有关联数据，包括：
                    <ul class="mt-2 mb-0">
                        <li>用户账号信息</li>
                        <li>AdGuardHome客户端配置</li>
                        <li>客户端映射记录</li>
                        <li>用户反馈记录</li>
                    </ul>
                    <strong>此操作不可撤销，请谨慎操作！</strong>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>删除方式：</strong>系统将逐个删除选中的用户，每个用户独立处理。即使某个用户删除失败，其他用户的删除操作仍会继续进行。
                </div>
                
                <p id="deleteInfo">将删除 434 个用户</p>
                 
                 <!-- 删除进度显示区域 -->
                 <div id="deleteProgress" style="display: none;">
                     <div class="alert alert-info">
                         <div class="d-flex align-items-center">
                             <div class="spinner-border spinner-border-sm me-2" role="status">
                                 <span class="visually-hidden">Loading...</span>
                             </div>
                             <div>
                                 <strong>删除进度：</strong><span id="progressText">准备开始...</span><br>
                                 <small class="text-muted">当前正在删除：<span id="currentUser">-</span></small>
                             </div>
                         </div>
                         <div class="progress mt-2">
                             <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                         </div>
                         <div class="text-center mt-3">
                             <button type="button" id="cancelDeleteBtn" class="btn btn-secondary btn-sm">取消删除</button>
                         </div>
                     </div>
                 </div>
                 
                 <div class="form-check" id="confirmSection">
                     <input class="form-check-input" type="checkbox" id="confirmDelete">
                     <label class="form-check-label" for="confirmDelete">
                         我确认要逐个删除这些用户，并了解此操作不可撤销
                     </label>
                 </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="bulkDeleteUsers()" id="deleteUsersBtn" disabled>
                    <i class="fas fa-trash"></i> 逐个删除用户
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function deleteUser(userId) {
    if (!confirm('确定要删除该用户吗？这将同时删除用户的所有客户端。')) {
        return;
    }
    
    fetch(`/admin/users/${userId}`, {
        method: 'DELETE',
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            // 显示成功消息
            alert(data.message);
            
            // 如果有客户端删除失败的错误，显示详细信息
            if (data.errors && data.errors.length > 0) {
                alert('部分客户端删除失败：\n' + data.errors.join('\n'));
            }
            
            // 刷新页面
            location.reload();
        }
    })
    .catch(error => {
        alert('删除用户失败：' + error);
    });
}

// 全选/取消全选功能
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    // 只选择可见行中的复选框
    const visibleRows = document.querySelectorAll('tbody tr:not([style*="display: none"])');
    const userCheckboxes = [];
    
    visibleRows.forEach(row => {
        const checkbox = row.querySelector('.user-checkbox');
        if (checkbox) {
            userCheckboxes.push(checkbox);
        }
    });
    
    userCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelectedCount();
}

// 更新选中用户数量
function updateSelectedCount() {
    const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
    const count = selectedCheckboxes.length;
    
    document.getElementById('selectedCount').textContent = `已选择 ${count} 个用户`;
    document.getElementById('bulkEmailBtn').disabled = count === 0;
    document.getElementById('bulkDeleteBtn').disabled = count === 0;
    
    // 更新全选复选框状态 - 只考虑可见的复选框
    const visibleRows = document.querySelectorAll('tbody tr:not([style*="display: none"])');
    const visibleCheckboxes = [];
    
    visibleRows.forEach(row => {
        const checkbox = row.querySelector('.user-checkbox');
        if (checkbox) {
            visibleCheckboxes.push(checkbox);
        }
    });
    
    const visibleSelectedCount = visibleCheckboxes.filter(cb => cb.checked).length;
    const selectAllCheckbox = document.getElementById('selectAll');
    
    if (visibleSelectedCount === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (visibleSelectedCount === visibleCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

// 显示批量邮件发送模态框
function showBulkEmailModal() {
    const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
    const count = selectedCheckboxes.length;
    
    if (count === 0) {
        alert('请先选择要发送邮件的用户');
        return;
    }
    
    document.getElementById('recipientInfo').textContent = `将发送给 ${count} 个用户`;
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('bulkEmailModal'));
    modal.show();
}

// 发送批量邮件
function sendBulkEmail() {
    const form = document.getElementById('bulkEmailForm');
    const formData = new FormData(form);
    
    // 验证表单
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // 获取选中的用户ID
    const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
    const userIds = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    if (userIds.length === 0) {
        alert('请先选择要发送邮件的用户');
        return;
    }
    
    const sendBtn = document.getElementById('sendEmailBtn');
    const originalText = sendBtn.innerHTML;
    
    // 禁用发送按钮并显示加载状态
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 发送中...';
    
    // 准备发送数据
    const emailData = {
        user_ids: userIds,
        subject: formData.get('subject'),
        message: formData.get('message'),
        additional_info: formData.get('additional_info')
    };
    
    // 发送请求
    fetch('/admin/send-bulk-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(emailData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`邮件发送成功！\n成功发送：${data.success_count} 封\n失败：${data.failed_count} 封`);
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkEmailModal'));
            modal.hide();
            
            // 清空表单
            form.reset();
            
            // 取消所有选择
            document.querySelectorAll('.user-checkbox:checked').forEach(cb => cb.checked = false);
            document.getElementById('selectAll').checked = false;
            updateSelectedCount();
        } else {
            alert('邮件发送失败：' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('邮件发送失败：网络错误');
    })
    .finally(() => {
        // 恢复发送按钮
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
    });
}

// 筛选DNS请求数为0的用户
function filterZeroDnsUsers() {
    const rows = document.querySelectorAll('tbody tr');
    let hiddenCount = 0;
    let visibleCount = 0;
    
    rows.forEach(row => {
        const dnsRequestCell = row.querySelector('td:nth-child(7) .badge');
        if (dnsRequestCell) {
            const dnsRequestCount = parseInt(dnsRequestCell.textContent.trim());
            if (dnsRequestCount === 0) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
                hiddenCount++;
            }
        }
    });
    
    // 显示筛选状态
    document.getElementById('filterStatus').textContent = `显示 ${visibleCount} 个DNS请求数为0的用户，隐藏 ${hiddenCount} 个用户`;
    document.getElementById('filterStatus').style.display = 'inline';
    document.getElementById('clearFilterBtn').style.display = 'inline-block';
    document.getElementById('filterZeroDnsBtn').disabled = true;
    
    // 清除所有选择
    document.querySelectorAll('.user-checkbox:checked').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateSelectedCount();
}

// 清除筛选
function clearFilter() {
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        row.style.display = '';
    });
    
    // 隐藏筛选状态
    document.getElementById('filterStatus').style.display = 'none';
    document.getElementById('clearFilterBtn').style.display = 'none';
    document.getElementById('filterZeroDnsBtn').disabled = false;
    
    // 清除所有选择
    document.querySelectorAll('.user-checkbox:checked').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateSelectedCount();
}

// 显示批量删除模态框
function showBulkDeleteModal() {
    const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
    const count = selectedCheckboxes.length;
    
    if (count === 0) {
        alert('请先选择要删除的用户');
        return;
    }
    
    document.getElementById('deleteInfo').textContent = `将删除 ${count} 个用户`;
    
    // 重置确认复选框
    document.getElementById('confirmDelete').checked = false;
    document.getElementById('deleteUsersBtn').disabled = true;
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
    modal.show();
}

// 获取选中的用户信息
function getSelectedUsers() {
    const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
    const users = [];
    
    selectedCheckboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const userId = checkbox.value;
        const username = row.querySelector('td:nth-child(3)').textContent.trim();
        const email = checkbox.dataset.email;
        
        users.push({
            id: userId,
            username: username,
            email: email
        });
    });
    
    return users;
}

// 全局变量用于控制删除操作
let deleteAbortController = null;
let isDeletionCancelled = false;
let isMinimized = false; // 标记是否为最小化操作

// 批量删除用户（使用优化API）
async function bulkDeleteUsers() {
    const selectedUsers = getSelectedUsers();
    const userIds = selectedUsers.map(user => user.id);
    
    if (userIds.length === 0) {
        alert('请先选择要删除的用户');
        return;
    }
    
    if (!document.getElementById('confirmDelete').checked) {
        alert('请确认删除操作');
        return;
    }
    
    // 重置取消状态
    isDeletionCancelled = false;
    deleteAbortController = new AbortController();
    
    // 显示进度区域，隐藏确认区域
    document.getElementById('confirmSection').style.display = 'none';
    document.getElementById('deleteProgress').style.display = 'block';
    
    // 显示最小化按钮
    document.getElementById('minimizeDeleteModal').style.display = 'block';
    
    // 禁用删除按钮，启用取消按钮
    const deleteBtn = document.getElementById('deleteUsersBtn');
    const cancelBtn = document.getElementById('cancelDeleteBtn');
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在删除中...';
    cancelBtn.disabled = false;
    cancelBtn.onclick = cancelDeletion;
    
    // 初始化进度
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const currentUserSpan = document.getElementById('currentUser');
    
    try {
        // 更新进度显示
        progressBar.style.width = '10%';
        progressText.textContent = '正在准备批量删除...';
        currentUserSpan.textContent = '-';

        if (isDeletionCancelled) {
            progressText.textContent = '删除已取消';
            return;
        }

        // 更新进度
        progressBar.style.width = '30%';
        progressText.textContent = '正在执行批量删除...';

        // 调用优化的批量删除API
         const response = await fetch('/admin/bulk-delete-users-optimized', {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
                 'X-Requested-With': 'XMLHttpRequest'
             },
             body: JSON.stringify({
                 user_ids: userIds
             }),
             signal: deleteAbortController.signal
         });

        if (isDeletionCancelled) {
            progressText.textContent = '删除已取消';
            return;
        }

        // 更新进度
        progressBar.style.width = '80%';
        progressText.textContent = '正在处理删除结果...';

        const result = await response.json();

        // 更新进度到完成
        progressBar.style.width = '100%';
        progressText.textContent = '删除完成';
        currentUserSpan.textContent = '-';

        // 显示结果
        let resultMessage = result.message;
        if (result.errors && result.errors.length > 0) {
            resultMessage += `\n\n错误详情:\n${result.errors.join('\n')}`;
        }

        if (result.success) {
            alert(resultMessage);
            // 刷新页面
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            alert('批量删除失败: ' + resultMessage);
        }

    } catch (error) {
        if (error.name === 'AbortError') {
            progressText.textContent = '删除已取消';
            currentUserSpan.textContent = '-';
            return;
        }
        
        console.error('批量删除过程中发生错误:', error);
        progressText.textContent = '删除过程中发生错误';
        currentUserSpan.textContent = '-';
        alert('批量删除过程中发生错误: ' + error.message);
    }
    
    // 删除用户的辅助函数，支持重试和取消
     async function deleteUserWithRetry(user, maxRetries, abortSignal) {
         for (let attempt = 1; attempt <= maxRetries; attempt++) {
             try {
                 // 检查是否已取消
                 if (abortSignal.aborted) {
                     throw new Error('操作已取消');
                 }
                 
                 const response = await fetch(`/admin/delete-user-progressive/${user.id}`, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     signal: abortSignal // 使用统一的取消信号
                 });
                 
                 const data = await response.json();
                 
                 if (data.success) {
                     return data;
                 } else {
                     // 如果是AdGuard Home相关错误，继续重试
                     if (data.message && (data.message.includes('AdGuard') || data.message.includes('timeout') || data.message.includes('连接'))) {
                         if (attempt === maxRetries) {
                             throw new Error(`${data.message} (重试${maxRetries}次后跳过)`);
                         }
                         throw new Error(data.message);
                     } else {
                         // 其他错误直接抛出
                         throw new Error(data.message || '删除失败');
                     }
                 }
             } catch (error) {
                 if (error.name === 'AbortError' || error.message === '操作已取消') {
                     throw error;
                 }
                 if (attempt === maxRetries) {
                     throw error;
                 }
                 // 重试前等待，AdGuard Home相关错误等待适中时间
                 const isAdGuardError = error.message && (error.message.includes('AdGuard') || error.message.includes('timeout') || error.message.includes('连接'));
                 const waitTime = isAdGuardError ? 2000 * attempt : 1000 * attempt;
                 await new Promise(resolve => setTimeout(resolve, waitTime));
             }
         }
     }
    
    // 完成后显示结果
    if (isDeletionCancelled) {
        progressText.textContent = '删除已取消';
        currentUserSpan.textContent = '-';
    } else {
        progressText.textContent = '删除完成';
        currentUserSpan.textContent = '-';
    }
    
    // 禁用取消按钮
    const cancelBtnEnd = document.getElementById('cancelDeleteBtn');
    cancelBtnEnd.disabled = true;
    
    // 构建详细的结果报告
    let resultMessage;
    if (isDeletionCancelled) {
        resultMessage = `删除操作已取消！\n\n已处理：${successCount + failedCount} 个用户\n成功删除：${successCount} 个用户\n失败：${failedCount} 个用户\n未处理：${selectedUsers.length - successCount - failedCount} 个用户`;
    } else {
        resultMessage = `删除操作完成！\n\n总计处理：${selectedUsers.length} 个用户\n成功删除：${successCount} 个用户\n失败：${failedCount} 个用户`;
    }
    
    // 显示每个用户的删除状态
    if (results.length > 0) {
        resultMessage += '\n\n详细结果：';
        results.forEach((result, index) => {
            const status = result.success ? '✓ 成功' : '✗ 失败';
            resultMessage += `\n${index + 1}. ${result.username}: ${status}`;
            if (result.errors && result.errors.length > 0) {
                resultMessage += ` (${result.errors.join(', ')})`;
            }
        });
    }
    
    // 如果有错误信息
    if (errors.length > 0) {
        resultMessage += '\n\n警告信息：\n' + errors.join('\n');
    }
    
    alert(resultMessage);
    
    // 隐藏状态按钮和最小化按钮
    document.getElementById('deleteStatusBtn').style.display = 'none';
    document.getElementById('minimizeDeleteModal').style.display = 'none';
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('bulkDeleteModal'));
    modal.hide();
    
    // 刷新页面
    location.reload();
}

// 取消删除操作
function cancelDeletion() {
    if (deleteAbortController) {
        isDeletionCancelled = true;
        deleteAbortController.abort();
        
        // 更新UI
        const cancelBtnCancel = document.getElementById('cancelDeleteBtn');
        cancelBtnCancel.disabled = true;
        cancelBtnCancel.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在取消...';
        
        // 更新进度显示
        document.getElementById('progressText').textContent = '正在取消删除操作...';
        document.getElementById('currentUser').textContent = '-';
        
        // 隐藏状态按钮和最小化按钮
        document.getElementById('deleteStatusBtn').style.display = 'none';
        document.getElementById('minimizeDeleteModal').style.display = 'none';
    }
}

// 最小化删除模态框
function minimizeDeleteModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('bulkDeleteModal'));
    if (modal) {
        isMinimized = true; // 标记为最小化操作
        modal.hide();
        // 显示状态按钮
        document.getElementById('deleteStatusBtn').style.display = 'block';
    }
}

// 显示删除状态
function showDeleteStatus() {
    // 隐藏状态按钮
    document.getElementById('deleteStatusBtn').style.display = 'none';
    // 重新显示模态框
    isMinimized = false; // 重新打开，不是最小化状态
    const modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
    modal.show();
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
    
    // 监听确认删除复选框变化
    document.getElementById('confirmDelete').addEventListener('change', function() {
        document.getElementById('deleteUsersBtn').disabled = !this.checked;
    });
    
    // 监听模态框关闭事件，只有在非最小化情况下才重置状态
    document.getElementById('bulkDeleteModal').addEventListener('hidden.bs.modal', function() {
        // 如果是最小化操作，不重置状态
        if (isMinimized) {
            isMinimized = false; // 重置标志
            return;
        }
        
        // 重置进度显示
        document.getElementById('deleteProgress').style.display = 'none';
        document.getElementById('confirmSection').style.display = 'block';
        
        // 重置进度条
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressText').textContent = '准备开始...';
        document.getElementById('currentUser').textContent = '-';
        
        // 重置删除按钮
        const deleteBtn = document.getElementById('deleteUsersBtn');
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '逐个删除用户';
        
        // 重置取消按钮
        const cancelBtnReset = document.getElementById('cancelDeleteBtn');
        cancelBtnReset.disabled = true;
        cancelBtnReset.innerHTML = '取消删除';
        cancelBtnReset.onclick = null;
        
        // 重置确认复选框
        document.getElementById('confirmDelete').checked = false;
        
        // 重置全局变量
        isDeletionCancelled = false;
        deleteAbortController = null;
    });
});

// 显示AdGuard客户端查询模态框
function showAdGuardClientsModal() {
    const modal = new bootstrap.Modal(document.getElementById('adguardClientsModal'));
    modal.show();
    
    // 清空之前的数据
    document.getElementById('clientsTableBody').innerHTML = '<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> 正在加载...</td></tr>';
    document.getElementById('clientsStats').innerHTML = '';
    
    // 获取AdGuard客户端数据
    fetch('/admin/adguard-clients')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAdGuardClients(data);
            } else {
                document.getElementById('clientsTableBody').innerHTML = `<tr><td colspan="6" class="text-center text-danger">错误: ${data.error}</td></tr>`;
            }
        })
        .catch(error => {
            console.error('获取AdGuard客户端失败:', error);
            document.getElementById('clientsTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">网络错误，请重试</td></tr>';
        });
}

// 显示AdGuard客户端数据
function displayAdGuardClients(data) {
    const tbody = document.getElementById('clientsTableBody');
    const statsDiv = document.getElementById('clientsStats');
    
    // 显示统计信息
    statsDiv.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-2">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h5>${data.total_count}</h5>
                        <small>总计</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h5>${data.manual_count}</h5>
                        <small>手动配置</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h5>${data.auto_count}</h5>
                        <small>自动发现</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h5>${data.matched_count}</h5>
                        <small>已匹配</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h5>${data.unmatched_clients.length}</h5>
                        <small>未匹配</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card bg-dark text-white">
                    <div class="card-body text-center">
                        <h5>${data.unmatched_allowed_ids.length}</h5>
                        <small>孤立ID</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 显示未匹配提示
    if (data.has_unmatched) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-warning mt-3';
        alertDiv.innerHTML = `
            <h5><i class="fas fa-exclamation-triangle"></i> 发现未匹配的客户端</h5>
            <p>检测到 ${data.unmatched_clients.length} 个未匹配的客户端和 ${data.unmatched_allowed_ids.length} 个孤立的允许客户端ID。</p>
            <button type="button" class="btn btn-warning" onclick="showUnmatchedClients(${JSON.stringify(data).replace(/"/g, '&quot;')})">
                <i class="fas fa-list"></i> 查看详情
            </button>
            <button type="button" class="btn btn-danger ms-2" onclick="confirmDeleteUnmatched(${JSON.stringify(data).replace(/"/g, '&quot;')})">
                <i class="fas fa-trash"></i> 删除未匹配项
            </button>
        `;
        statsDiv.appendChild(alertDiv);
    }
    
    // 显示客户端列表
    if (data.clients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无客户端</td></tr>';
        return;
    }
    
    tbody.innerHTML = '';
    data.clients.forEach(client => {
        const row = document.createElement('tr');
        
        // 处理客户端ID列表
        const idsHtml = client.ids.map(id => `<span class="badge bg-secondary me-1">${id}</span>`).join('');
        
        // 处理匹配状态
        const matchedBadge = client.matched ? 
            '<span class="badge bg-success"><i class="fas fa-check"></i> 已匹配</span>' : 
            '<span class="badge bg-danger"><i class="fas fa-times"></i> 未匹配</span>';
        
        // 处理标签
        const tagsHtml = client.tags ? client.tags.map(tag => `<span class="badge bg-info me-1">${tag}</span>`).join('') : '';
        
        // 处理被阻止的服务
        const blockedServicesHtml = client.blocked_services ? client.blocked_services.slice(0, 3).map(service => `<span class="badge bg-warning me-1">${service}</span>`).join('') : '';
        const moreServices = client.blocked_services && client.blocked_services.length > 3 ? `<span class="text-muted">+${client.blocked_services.length - 3}更多</span>` : '';
        
        row.innerHTML = `
            <td>${client.name || '<span class="text-muted">未命名</span>'}</td>
            <td>${idsHtml}</td>
            <td><span class="badge ${client.type === '手动配置' ? 'bg-success' : 'bg-info'}">${client.type}</span></td>
            <td>${matchedBadge}</td>
            <td>
                ${client.filtering_enabled ? '<i class="fas fa-check text-success" title="过滤已启用"></i>' : '<i class="fas fa-times text-danger" title="过滤已禁用"></i>'}
                ${client.parental_enabled ? '<i class="fas fa-child text-warning ms-1" title="家长控制已启用"></i>' : ''}
                ${client.safebrowsing_enabled ? '<i class="fas fa-shield-alt text-primary ms-1" title="安全浏览已启用"></i>' : ''}
            </td>
            <td>${tagsHtml}</td>
            <td>${blockedServicesHtml}${moreServices}</td>
        `;
        
        // 为未匹配的行添加特殊样式
        if (!client.matched) {
            row.classList.add('table-warning');
        }
        
        tbody.appendChild(row);
    });
}

function showUnmatchedClients(data) {
    let content = '<h5>未匹配的客户端:</h5>';
    if (data.unmatched_clients.length > 0) {
        content += '<ul>';
        data.unmatched_clients.forEach(client => {
            content += `<li><strong>${client.name}</strong> (${client.type}) - IDs: ${client.ids.join(', ')}</li>`;
        });
        content += '</ul>';
    } else {
        content += '<p>无未匹配的客户端</p>';
    }
    
    content += '<h5>孤立的允许客户端ID:</h5>';
    if (data.unmatched_allowed_ids.length > 0) {
        content += '<ul>';
        data.unmatched_allowed_ids.forEach(id => {
            content += `<li><code>${id}</code></li>`;
        });
        content += '</ul>';
    } else {
        content += '<p>无孤立的允许客户端ID</p>';
    }
    
    // 创建详情模态框
    const detailModal = `
        <div class="modal fade" id="unmatchedDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">未匹配项详情</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除已存在的模态框
    const existingModal = document.getElementById('unmatchedDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新模态框
    document.body.insertAdjacentHTML('beforeend', detailModal);
    const modal = new bootstrap.Modal(document.getElementById('unmatchedDetailsModal'));
    modal.show();
}

function confirmDeleteUnmatched(data) {
    if (data.unmatched_clients.length === 0 && data.unmatched_allowed_ids.length === 0) {
        alert('没有需要删除的未匹配项');
        return;
    }
    
    let message = '确定要删除以下未匹配项吗？\n\n';
    
    if (data.unmatched_clients.length > 0) {
        message += `客户端 (${data.unmatched_clients.length}个):\n`;
        data.unmatched_clients.forEach(client => {
            message += `- ${client.name} (${client.type})\n`;
        });
        message += '\n';
    }
    
    if (data.unmatched_allowed_ids.length > 0) {
        message += `允许客户端ID (${data.unmatched_allowed_ids.length}个):\n`;
        data.unmatched_allowed_ids.forEach(id => {
            message += `- ${id}\n`;
        });
    }
    
    message += '\n此操作不可撤销！';
    
    if (confirm(message)) {
        deleteUnmatchedClients(data);
    }
}

function deleteUnmatchedClients(data) {
    // 显示删除进度
    const progressModal = `
        <div class="modal fade" id="deleteProgressModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">删除未匹配项</h5>
                    </div>
                    <div class="modal-body">
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 0%" id="deleteProgress"></div>
                        </div>
                        <div id="deleteStatus">正在准备删除...</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除已存在的进度模态框
    const existingProgressModal = document.getElementById('deleteProgressModal');
    if (existingProgressModal) {
        existingProgressModal.remove();
    }
    
    // 添加进度模态框
    document.body.insertAdjacentHTML('beforeend', progressModal);
    const modal = new bootstrap.Modal(document.getElementById('deleteProgressModal'));
    modal.show();
    
    // 发送删除请求
    fetch('/admin/delete-unmatched-clients', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            unmatched_clients: data.unmatched_clients,
            unmatched_allowed_ids: data.unmatched_allowed_ids
        })
    })
    .then(response => response.json())
    .then(result => {
        const progressBar = document.getElementById('deleteProgress');
        const statusDiv = document.getElementById('deleteStatus');
        
        if (result.success) {
            progressBar.style.width = '100%';
            progressBar.classList.add('bg-success');
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6>删除完成！</h6>
                    <p>成功删除 ${result.deleted_clients} 个客户端和 ${result.deleted_allowed_ids} 个允许ID</p>
                    ${result.errors.length > 0 ? `<p class="text-warning">部分删除失败：${result.errors.join(', ')}</p>` : ''}
                </div>
                <button type="button" class="btn btn-success" onclick="location.reload()">刷新页面</button>
            `;
        } else {
            progressBar.style.width = '100%';
            progressBar.classList.add('bg-danger');
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6>删除失败</h6>
                    <p>${result.message}</p>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            `;
        }
    })
    .catch(error => {
        const progressBar = document.getElementById('deleteProgress');
        const statusDiv = document.getElementById('deleteStatus');
        
        progressBar.style.width = '100%';
        progressBar.classList.add('bg-danger');
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6>网络错误</h6>
                <p>无法连接到服务器：${error.message}</p>
            </div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        `;
    });
}
</script>

<!-- AdGuard客户端查询模态框 -->
<div class="modal fade" id="adguardClientsModal" tabindex="-1" aria-labelledby="adguardClientsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adguardClientsModalLabel">
                    <i class="fas fa-network-wired"></i> AdGuard Home 客户端列表
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 统计信息 -->
                <div id="clientsStats"></div>
                
                <!-- 客户端列表 -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>客户端名称</th>
                                <th>IP/ID</th>
                                <th>类型</th>
                                <th>匹配状态</th>
                                <th>状态</th>
                                <th>标签</th>
                                <th>被阻止的服务</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> 正在加载...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="showAdGuardClientsModal()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}