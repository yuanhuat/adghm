<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主页 - AdGuardHome用户管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="main-container">
        <header class="main-header">
            <h1>欢迎，{{ current_user.username }}</h1>
            <nav class="main-nav">
                <a href="{{ url_for('main.clients') }}">客户端管理</a>
                {% if current_user.is_admin %}
                <a href="{{ url_for('admin.index') }}">管理员后台</a>
                {% endif %}
                <a href="{{ url_for('auth.logout') }}">退出登录</a>
            </nav>
        </header>
        
        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <div class="dashboard">
                <div class="dashboard-card">
                    <h2>我的客户端</h2>
                    <p class="dashboard-stat">{{ current_user.client_mappings|length }}</p>
                    <a href="{{ url_for('main.clients') }}" class="btn btn-primary">管理客户端</a>
                </div>
                
                <div class="dashboard-card">
                    <h2>账号信息</h2>
                    <div class="info-list">
                        <p><strong>用户名：</strong>{{ current_user.username }}</p>
                        <p><strong>注册时间：</strong>{{ current_user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        <p><strong>账号类型：</strong>{% if current_user.is_admin %}管理员{% else %}普通用户{% endif %}</p>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h2>我的域名</h2>
                    <div class="info-list" id="domain-info">
                        {% if domain_mapping %}
                        <p><strong>域名：</strong>{{ domain_mapping.full_domain }}</p>
                        <p><strong>当前IP：</strong>{{ domain_mapping.ip_address }}</p>
                        <p><strong>创建时间：</strong>{{ domain_mapping.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        <button id="refresh-domain" class="btn btn-primary">刷新IP地址</button>
                        {% else %}
                        <p>您还没有域名映射记录</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const refreshButton = document.getElementById('refresh-domain');
                if (refreshButton) {
                    refreshButton.addEventListener('click', async function() {
                        try {
                            refreshButton.disabled = true;
                            refreshButton.textContent = '正在刷新...';
                            
                            const response = await fetch('/refresh-domain', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({})
                            });
                            
                            const data = await response.json();
                            
                            if (response.ok && data.success) {
                                alert('域名IP地址刷新成功');
                                // 更新页面上的IP地址
                                const ipElement = document.querySelector('#domain-info p:nth-child(2)');
                                if (ipElement) {
                                    ipElement.innerHTML = `<strong>当前IP：</strong>${data.ip_address}`;
                                }
                            } else {
                                alert(data.message || '刷新IP地址失败');
                            }
                        } catch (error) {
                            alert('操作失败：' + error.message);
                        } finally {
                            refreshButton.disabled = false;
                            refreshButton.textContent = '刷新IP地址';
                        }
                    });
                }
            });
            </script>
        </main>
    </div>
</body>
</html>