<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主页 - AdGuardHome用户管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fontawesome/all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fontawesome/brands.css') }}">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="apple-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <svg class="brand-icon" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span>AdGuard Home</span>
            </div>
            <button class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-menu" id="navMenu">
                <a href="{{ url_for('main.clients') }}" class="nav-link">客户端</a>
                <a href="{{ url_for('main.guide') }}" class="nav-link">指南</a>
                <a href="{{ url_for('main.donation') }}" class="nav-link">支持</a>
                {% if donation_config and donation_config.show_ranking %}
                <a href="{{ url_for('main.donation_ranking') }}" class="nav-link">排行榜</a>
                {% endif %}
                <a href="http://test.dns.con:5000/dns-test" target="_blank" class="nav-link">DNS检测</a>
                <div class="nav-dropdown">
                    <button class="nav-dropdown-toggle">{{ current_user.username }}</button>
                    <div class="nav-dropdown-menu">
                        <a href="{{ url_for('main.change_password_page') }}">修改密码</a>
                        <a href="{{ url_for('main.change_email_page') }}">修改邮箱</a>
                        {% if current_user.is_admin %}
                        <a href="{{ url_for('admin.index') }}">管理员后台</a>
                        {% endif %}
                        <a href="{{ url_for('auth.delete_account') }}" class="danger">注销账户</a>
                        <a href="{{ url_for('auth.logout') }}">退出登录</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        
        <!-- 系统公告横幅 -->
        <div class="announcement-banner" id="announcement-banner" style="display: none;">
            <div class="announcement-banner-content">
                <svg class="announcement-icon" viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <div class="announcement-text" id="banner-announcement-text">暂无公告</div>
                <button class="announcement-close" onclick="closeAnnouncementBanner()">
                    <svg viewBox="0 0 24 24" width="16" height="16">
                        <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- 英雄区域 -->
        <section class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">
                    <span class="hero-greeting">欢迎回来</span>
                    <span class="hero-name">{{ current_user.username }}</span>
                </h1>
                <p class="hero-subtitle">强大的DNS管理，融入超薄、超轻、超便携的设计之中</p>
                <div class="hero-stats">
                    <div class="hero-stat">
                        <span class="stat-number" id="user-request-count">{{ user_request_count or 0 }}</span>
                        <span class="stat-label">我的DNS请求</span>
                    </div>
                    <div class="hero-stat">
                        <span class="stat-number" id="total-dns-queries">{{ total_dns_queries or 0 }}</span>
                        <span class="stat-label">总查询数</span>
                    </div>
                    <div class="hero-stat">
                        <span class="stat-number" id="total-blocked-queries">{{ total_blocked_queries or 0 }}</span>
                        <span class="stat-label">总拦截数</span>
                    </div>
                </div>
            </div>
            <div class="hero-visual">
                <img src="{{ url_for('static', filename='images/hero-graphic.svg') }}" alt="DNS服务图示" class="hero-graphic" style="width: 400px; height: 300px; object-fit: contain;">
            </div>
        </section>
        
        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- 功能卡片网格 -->
            <section class="features-grid">
                <!-- 客户端管理卡片 -->
                <div class="feature-card primary-card">
                    <div class="card-header">
                        <svg class="card-icon" viewBox="0 0 24 24" width="32" height="32">
                            <path fill="currentColor" d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
                        </svg>
                        <h3>我的客户端</h3>
                    </div>
                    <div class="card-content">
                        <div class="big-number">{{ current_user.client_mappings|length }}</div>
                        <p class="card-description">管理您的DNS客户端设备</p>
                        <div class="ranking-info" id="user-ranking-info" style="display: none;">
                            <p>排名：<span id="user-ranking">-</span> / <span id="total-clients">-</span></p>
                        </div>
                    </div>
                    <div class="card-action">
                        <a href="{{ url_for('main.clients') }}" class="btn-modern">管理客户端</a>
                    </div>
                </div>

                <!-- 账号信息卡片 -->
                <div class="feature-card">
                    <div class="card-header">
                        <svg class="card-icon" viewBox="0 0 24 24" width="32" height="32">
                            <path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        <h3>账号信息</h3>
                    </div>
                    <div class="card-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">用户名</span>
                                <span class="info-value">{{ current_user.username }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">注册时间</span>
                                <span class="info-value">{{ current_user.created_at.strftime('%Y-%m-%d') }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">账号类型</span>
                                <span class="info-value account-type">{% if current_user.is_vip() %}VIP用户{% elif current_user.is_admin %}管理员{% else %}普通用户{% endif %}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DNS配置卡片 -->
                <div class="feature-card wide-card">
                    <div class="card-header">
                        <img src="{{ url_for('static', filename='images/dns-icon.svg') }}" alt="DNS配置" class="card-icon">
                        <h3 id="dns-config-title">DNS配置信息</h3>
                    </div>
                    <div class="card-content">
                        <div class="dns-config-content" id="dns-config-content">
                            <p>加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- 苹果设备配置卡片 -->
                <div class="feature-card wide-card">
                    <div class="card-header">
                        <img src="{{ url_for('static', filename='images/apple-icon.svg') }}" alt="苹果配置" class="card-icon">
                        <h3>苹果设备配置</h3>
                    </div>
                    <div class="card-content">
                        <p class="card-description">为您的iPhone、iPad或Mac设备快速配置DNS设置</p>
                        <div class="apple-config-content" id="apple-config-content">
                            <p>加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- 客户端排行榜卡片 -->
                <div class="feature-card wide-card">
                    <div class="card-header">
                        <img src="{{ url_for('static', filename='images/ranking-icon.svg') }}" alt="排行榜" class="card-icon">
                        <h3>客户端排行榜</h3>
                    </div>
                    <div class="card-content">
                        <div class="ranking-list" id="client-ranking">
                            <p>加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- 需求留言卡片 -->
                <div class="feature-card wide-card">
                    <div class="card-header">
                        <img src="{{ url_for('static', filename='images/feedback-icon.svg') }}" alt="留言" class="card-icon">
                        <h3>需求留言</h3>
                    </div>
                    <div class="card-content">
                        <form id="feedback-form" class="modern-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <input type="text" id="feedback-title" name="title" required maxlength="100" placeholder="留言标题">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <textarea id="feedback-content" name="content" required maxlength="1000" rows="3" placeholder="详细描述您的需求或问题"></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn-modern primary">提交留言</button>
                        </form>
                        <div class="feedback-list" id="feedback-list">
                            <h4>我的留言</h4>
                            <div id="feedback-items">
                                <p>加载中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            

        </main>
    </div>

<!-- 公告弹窗模态框 -->
<div id="announcementModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="announcementTitle">公告</h3>
            <span class="modal-close" onclick="closeAnnouncementModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="announcementContent"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeAnnouncementModal()">我知道了</button>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s;
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 0;
    border: none;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s;
}

.modal-header {
    padding: 20px;
    background-color: #007bff;
    color: white;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.modal-close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.modal-close:hover {
    opacity: 0.7;
}

.modal-body {
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
    line-height: 1.6;
}

.modal-footer {
    padding: 15px 20px;
    text-align: right;
    border-top: 1px solid #dee2e6;
    border-radius: 0 0 8px 8px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* 公告横幅样式 - 在header之上，挤压页面布局 */
.announcement-banner {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    animation: slideDown 0.5s ease-out;
    width: 100%;
}

.announcement-banner-content {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    max-width: 1200px;
    margin: 0 auto;
    gap: 15px;
    min-height: 48px;
}

.announcement-banner .fas.fa-bullhorn {
    font-size: 18px;
    color: #fff;
    flex-shrink: 0;
}

.announcement-banner .announcement-text {
    flex: 1;
    font-size: 14px;
    line-height: 1.4;
    margin: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.announcement-close {
    background: none;
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;
    padding: 5px;
    border-radius: 3px;
    transition: background-color 0.3s ease;
    flex-shrink: 0;
}

.announcement-close:hover {
    background-color: rgba(255,255,255,0.2);
}

@keyframes slideDown {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

<style>
/* 苹果配置文件样式 */
.apple-config-items {
    margin-bottom: 20px;
}

.apple-config-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.apple-config-item h4 {
    margin: 0 0 5px 0;
    color: #333;
    font-size: 16px;
}

.apple-config-item p {
    margin: 0;
    color: #6c757d;
    font-size: 14px;
}

.btn-download {
    padding: 8px 16px;
    font-size: 14px;
    border-radius: 6px;
    text-decoration: none;
    white-space: nowrap;
}

.btn-download:hover {
    text-decoration: none;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.apple-config-note {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.apple-config-note p {
    margin: 0 0 10px 0;
    color: #856404;
    font-weight: bold;
}

.apple-config-note ol {
    margin: 0;
    padding-left: 20px;
    color: #856404;
}

.apple-config-note li {
    margin-bottom: 5px;
}

@media (max-width: 768px) {
    .apple-config-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .btn-download {
        align-self: stretch;
        text-align: center;
    }
}
</style>

<script>
// 数字滚动动画函数
         function animateNumber(element, targetValue) {
             const currentValue = parseInt(element.textContent.replace(/,/g, '')) || 0;
             const difference = Math.abs(targetValue - currentValue);
             
             // 如果数值没有变化，直接返回
             if (difference === 0) return;
             
             // 清除可能存在的动画
             if (element.animationTimer) {
                 cancelAnimationFrame(element.animationTimer);
             }
             
             // 根据数值变化大小动态调整动画时间
             let duration;
             if (difference < 100) {
                 duration = 800;  // 小变化：快速动画
             } else if (difference < 1000) {
                 duration = 1200; // 中等变化：中等速度
             } else if (difference < 10000) {
                 duration = 1800; // 大变化：较慢动画
             } else {
                 duration = 2500; // 巨大变化：最慢动画
             }
             
             const startTime = Date.now();
             
             // 使用 requestAnimationFrame 实现更平滑的动画
             function animate() {
                 const elapsed = Date.now() - startTime;
                 const progress = Math.min(elapsed / duration, 1);
                 
                 // 使用更平滑的缓动函数（easeOutCubic）
                 const easeProgress = 1 - Math.pow(1 - progress, 3);
                 
                 const newValue = Math.round(currentValue + ((targetValue - currentValue) * easeProgress));
                 
                 // 格式化数字（添加千位分隔符）
                 element.textContent = newValue.toLocaleString();
                 
                 if (progress < 1) {
                     element.animationTimer = requestAnimationFrame(animate);
                 } else {
                     // 动画完成，确保显示准确值
                     element.textContent = targetValue.toLocaleString();
                     delete element.animationTimer;
                 }
             }
             
             animate();
         }

// 动态更新统计数据
function updateStats() {
    fetch('/api/stats', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Accept': 'application/json'
        }
    })
        .then(response => {
            console.log('Stats API response status:', response.status);
            if (response.status === 401 || response.status === 403) {
                console.log('Stats API: 认证失败，用户未登录');
                return null;
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) {
                console.log('Stats API: 跳过处理（认证失败）');
                return;
            }
            console.log('Stats API data:', data);
            
            // 更新用户请求数（滚动效果）
            const userRequestElement = document.getElementById('user-request-count');
            if (userRequestElement) {
                animateNumber(userRequestElement, data.user_request_count || 0);
            }
            
            // 更新总DNS查询数（滚动效果）
            const totalQueriesElement = document.getElementById('total-dns-queries');
            if (totalQueriesElement) {
                animateNumber(totalQueriesElement, data.total_dns_queries || 0);
            }
            
            // 更新总拦截数（滚动效果）
            const totalBlockedElement = document.getElementById('total-blocked-queries');
            if (totalBlockedElement) {
                animateNumber(totalBlockedElement, data.total_blocked_queries || 0);
            }
            
            // 更新用户排名信息
            const userRankingElement = document.getElementById('user-ranking');
            const totalClientsElement = document.getElementById('total-clients');
            const rankingInfoElement = document.getElementById('user-ranking-info');
            
            if (userRankingElement && totalClientsElement && rankingInfoElement) {
                if (data.user_ranking && data.user_ranking > 0 && data.total_clients > 0) {
                    userRankingElement.textContent = data.user_ranking;
                    totalClientsElement.textContent = data.total_clients;
                    rankingInfoElement.style.display = 'block';
                } else {
                    // 如果没有排名数据，隐藏排名信息
                    rankingInfoElement.style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('Stats API error:', error);
        });
}

// 动态更新客户端排行数据
function updateClientRanking() {
    fetch('/api/client_ranking', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Accept': 'application/json'
        }
    })
        .then(response => {
            console.log('Client ranking API response status:', response.status);
            if (response.status === 401 || response.status === 403) {
                console.log('Client ranking API: 认证失败，用户未登录');
                return null;
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) {
                console.log('Client ranking API: 跳过处理（认证失败）');
                return;
            }
            console.log('Client ranking API data:', data);
            
            const rankingElement = document.getElementById('client-ranking');
            if (rankingElement && data.client_ranking) {
                if (data.client_ranking.length === 0) {
                    rankingElement.innerHTML = '<p>暂无数据</p>';
                } else {
                    let html = '<div class="ranking-items">';
                    data.client_ranking.forEach((client, index) => {
                        const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-other';
                        const currentUserClass = client.is_current_user ? 'current-user' : '';
                        
                        // 获取排名图标
                        let rankIcon = '';
                        if (index === 0) rankIcon = '<i class="fas fa-crown"></i>';
                        else if (index === 1) rankIcon = '<i class="fas fa-medal"></i>';
                        else if (index === 2) rankIcon = '<i class="fas fa-award"></i>';
                        else rankIcon = '<i class="fas fa-user"></i>';
                        
                        // 显示完整数字
                        let formattedCount = client.request_count.toLocaleString();
                        
                        html += `
                            <div class="ranking-item ${rankClass} ${currentUserClass}">
                                <div class="rank-badge">
                                    ${rankIcon}
                                    <span class="rank-number">${index + 1}</span>
                                </div>
                                <div class="client-info">
                                    <div class="client-name">
                                        <i class="fas fa-desktop"></i>
                                        ${client.client_name}
                                        ${client.is_current_user ? '<span class="current-badge">当前</span>' : ''}
                                    </div>
                                </div>
                                <div class="request-stats">
                                    <span class="request-count">${formattedCount}</span>
                                    <span class="request-label">请求数</span>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    rankingElement.innerHTML = html;
                }
            }
        })
        .catch(error => {
            console.error('Client ranking API error:', error);
        });
}

// 获取DNS配置信息
function updateDnsConfig() {
    fetch('/api/dns-config', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => {
        console.log('DNS config API response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('DNS config API data:', data);
        
        const titleElement = document.getElementById('dns-config-title');
        const contentElement = document.getElementById('dns-config-content');
        
        if (titleElement && data.display_title) {
            titleElement.textContent = data.display_title;
        }
        
        if (contentElement) {
            let html = '';
            
            if (data.display_description) {
                html += `<p class="dns-description">${data.display_description}</p>`;
            }
            
            let hasConfig = false;
            
            // DNS-over-QUIC配置
            if (data.doq_enabled && data.doq_server) {
                hasConfig = true;
                html += `
                    <div class="dns-config-item">
                        <h4><i class="fas fa-bolt" style="color: #007bff;"></i> DNS-over-QUIC (DoQ)</h4>
                        <div class="dns-server-info">
                            <p><strong>服务器：</strong> <code>quic://${data.doq_server}:${data.doq_port}</code></p>
                            ${data.doq_description ? `<p class="dns-desc">${data.doq_description}</p>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // DNS-over-TLS配置
            if (data.dot_enabled && data.dot_server) {
                hasConfig = true;
                html += `
                    <div class="dns-config-item">
                        <h4><i class="fas fa-shield-alt" style="color: #28a745;"></i> DNS-over-TLS (DoT)</h4>
                        <div class="dns-server-info">
                            <p><strong>服务器：</strong> <code>tls://${data.dot_server}:${data.dot_port}</code></p>
                            ${data.dot_description ? `<p class="dns-desc">${data.dot_description}</p>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // DNS-over-HTTPS配置
            if (data.doh_enabled && data.doh_server) {
                hasConfig = true;
                const dohUrl = `https://${data.doh_server}${data.doh_port && data.doh_port != 443 ? ':' + data.doh_port : ''}${data.doh_path || '/dns-query'}`;
                html += `
                    <div class="dns-config-item">
                        <h4><i class="fas fa-globe" style="color: #17a2b8;"></i> DNS-over-HTTPS (DoH)</h4>
                        <div class="dns-server-info">
                            <p><strong>服务器：</strong> <code>${dohUrl}</code></p>
                            ${data.doh_description ? `<p class="dns-desc">${data.doh_description}</p>` : ''}
                        </div>
                    </div>
                `;
            }
            
            if (!hasConfig) {
                html = '<p class="no-config">暂无可用的DNS配置信息</p>';
            }
            
            contentElement.innerHTML = html;
        }
        
        // 同时更新苹果配置文件
        updateAppleConfig(data);
    })
    .catch(error => {
        console.error('DNS config API error:', error);
        const contentElement = document.getElementById('dns-config-content');
        if (contentElement) {
            contentElement.innerHTML = '<p class="error-message">加载DNS配置信息失败</p>';
        }
    });
}

// 更新苹果配置文件
function updateAppleConfig(dnsData) {
    const appleContentElement = document.getElementById('apple-config-content');
    if (!appleContentElement) return;
    
    let html = '';
    let hasConfig = false;
    
    // 检查管理员是否启用了苹果配置文件功能
    if (!dnsData.apple_config_enabled) {
        html = '<p class="no-config">管理员已禁用苹果设备配置文件下载功能</p>';
        appleContentElement.innerHTML = html;
        return;
    }
    
    // 检查是否有可用的DNS配置
    const hasDoH = dnsData.doh_enabled && dnsData.doh_server && dnsData.apple_doh_config_enabled;
    const hasDoT = dnsData.dot_enabled && dnsData.dot_server && dnsData.apple_dot_config_enabled;
    
    if (hasDoH || hasDoT) {
        hasConfig = true;
        html += '<div class="apple-config-items">';
        
        if (hasDoH) {
            const dohHost = dnsData.doh_server || 'localhost';
            html += `
                <div class="apple-config-item">
                    <div class="config-info">
                        <h4><i class="fas fa-globe" style="color: #17a2b8;"></i> DNS-over-HTTPS (DoH)</h4>
                        <p>适用于 iOS 14+ 和 macOS Big Sur+</p>
                    </div>
                    <a href="/api/apple/doh.mobileconfig?host=${encodeURIComponent(dohHost)}" class="btn btn-primary btn-download" download>
                        <i class="fas fa-download"></i> 下载配置文件
                    </a>
                </div>
            `;
        }
        
        if (hasDoT) {
            // 从包含客户端ID的服务器地址中提取原始域名
            const dotServerWithClientId = dnsData.dot_server || 'localhost';
            // 如果服务器地址包含客户端ID，提取原始域名部分
            const dotHost = dotServerWithClientId.includes('.') ? 
                dotServerWithClientId.substring(dotServerWithClientId.indexOf('.') + 1) : 
                dotServerWithClientId;
            html += `
                <div class="apple-config-item">
                    <div class="config-info">
                        <h4><i class="fas fa-shield-alt" style="color: #28a745;"></i> DNS-over-TLS (DoT)</h4>
                        <p>适用于 iOS 14+ 和 macOS Big Sur+</p>
                    </div>
                    <a href="/api/apple/dot.mobileconfig?host=${encodeURIComponent(dotHost)}" class="btn btn-primary btn-download" download>
                        <i class="fas fa-download"></i> 下载配置文件
                    </a>
                </div>
            `;
        }
        
        html += '</div>';
        html += '<div class="apple-config-note">';
        html += '<p><i class="fas fa-info-circle"></i> <strong>使用说明：</strong></p>';
        html += '<ol>';
        html += '<li>点击下载按钮获取配置文件</li>';
        html += '<li>在设备上打开下载的.mobileconfig文件</li>';
        html += '<li>按照系统提示安装配置文件</li>';
        html += '<li>安装完成后，您的设备将自动使用AdGuard Home的DNS服务</li>';
        html += '</ol>';
        html += '</div>';
    }
    
    if (!hasConfig) {
        html = '<p class="no-config">暂无可用的DNS配置，请联系管理员设置</p>';
    }
    
    appleContentElement.innerHTML = html;
}

// 提交留言表单
function submitFeedback(event) {
    event.preventDefault();
    
    const form = document.getElementById('feedback-form');
    const formData = new FormData(form);
    const data = {
        title: formData.get('title'),
        content: formData.get('content')
    };
    
    fetch('/api/feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.status === 401 || response.status === 403) {
            alert('请先登录后再提交留言');
            return null;
        }
        return response.json();
    })
    .then(data => {
        if (!data) return; // 认证失败时跳过处理
        
        if (data.success) {
            form.reset();
            updateFeedbackList();
            alert('留言提交成功！');
        } else {
            alert('提交失败：' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        alert('提交失败，请稍后重试');
    });
}

// 更新留言列表
function updateFeedbackList() {
    fetch('/api/feedback')
        .then(response => {
            if (response.status === 401 || response.status === 403) {
                // 认证失败，可能需要重新登录
                return null;
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // 认证失败时跳过处理
            
            const feedbackItemsElement = document.getElementById('feedback-items');
            if (feedbackItemsElement && data.feedbacks) {
                if (data.feedbacks.length === 0) {
                    feedbackItemsElement.innerHTML = '<p>暂无留言</p>';
                } else {
                    let html = '';
                    data.feedbacks.forEach(feedback => {
                        const statusClass = feedback.status === 'open' ? 'status-open' : 'status-closed';
                        const statusText = feedback.status === 'open' ? '待处理' : '已关闭';
                        html += `
                            <div class="feedback-item ${statusClass}">
                                <div class="feedback-header">
                                    <h4>${feedback.title}</h4>
                                    <span class="feedback-status">${statusText}</span>
                                </div>
                                <div class="feedback-content">${feedback.content}</div>
                                <div class="feedback-meta">
                                    <span>创建时间：${new Date(feedback.created_at).toLocaleString()}</span>
                                    ${feedback.admin_reply ? `<div class="admin-reply"><strong>管理员回复：</strong>${feedback.admin_reply}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    feedbackItemsElement.innerHTML = html;
                }
            }
        })
        .catch(error => {
            console.error('Feedback API error:', error);
        });
}

// 公告相关函数
function loadAnnouncements() {
    fetch('/api/announcements/active', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (response.status === 401 || response.status === 403) {
            return null;
        }
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // 更新公告横幅显示
        updateAnnouncementBanner(data);
        
        // 检查是否有未读公告需要弹窗显示
        checkForUnreadAnnouncements(data);
    })
    .catch(error => {
        console.error('获取公告失败:', error);
    });
}

function updateAnnouncementBanner(data) {
    const banner = document.getElementById('announcement-banner');
    const bannerText = document.getElementById('banner-announcement-text');
    
    if (!banner || !bannerText) return;
    
    // 检查是否有已关闭的横幅记录
    const closedBanners = JSON.parse(localStorage.getItem('closedAnnouncementBanners') || '[]');
    
    if (!data || !data.announcements || data.announcements.length === 0) {
        banner.style.display = 'none';
        return;
    }
    
    // 找到最新的未关闭公告
    const latestAnnouncement = data.announcements.find(announcement => 
        !closedBanners.includes(announcement.id)
    );
    
    if (latestAnnouncement) {
        bannerText.textContent = `${latestAnnouncement.title}: ${latestAnnouncement.content}`;
        banner.style.display = 'block';
        banner.dataset.announcementId = latestAnnouncement.id;
    } else {
        banner.style.display = 'none';
    }
}

function closeAnnouncementBanner() {
    const banner = document.getElementById('announcement-banner');
    if (!banner) return;
    
    const announcementId = banner.dataset.announcementId;
    if (announcementId) {
        // 记录已关闭的横幅
        const closedBanners = JSON.parse(localStorage.getItem('closedAnnouncementBanners') || '[]');
        if (!closedBanners.includes(parseInt(announcementId))) {
            closedBanners.push(parseInt(announcementId));
            localStorage.setItem('closedAnnouncementBanners', JSON.stringify(closedBanners));
        }
    }
    
    banner.style.display = 'none';
}

function checkForUnreadAnnouncements(data) {
    if (!data || !data.announcements || data.announcements.length === 0) {
        return;
    }
    
    // 获取已读公告列表
    const readAnnouncements = JSON.parse(localStorage.getItem('readAnnouncements') || '[]');
    
    // 查找未读公告
    const unreadAnnouncement = data.announcements.find(announcement => 
        !readAnnouncements.includes(announcement.id)
    );
    
    if (unreadAnnouncement) {
        showAnnouncementModal(unreadAnnouncement);
    }
}

function showAnnouncementModal(announcement) {
    const modal = document.getElementById('announcementModal');
    const title = document.getElementById('announcementTitle');
    const content = document.getElementById('announcementContent');
    
    if (modal && title && content) {
        title.textContent = announcement.title;
        content.innerHTML = announcement.content;
        modal.style.display = 'block';
        
        // 记录当前显示的公告ID
        modal.dataset.announcementId = announcement.id;
    }
}

function closeAnnouncementModal() {
    const modal = document.getElementById('announcementModal');
    if (modal) {
        const announcementId = modal.dataset.announcementId;
        if (announcementId) {
            // 标记公告为已读
            const readAnnouncements = JSON.parse(localStorage.getItem('readAnnouncements') || '[]');
            if (!readAnnouncements.includes(parseInt(announcementId))) {
                readAnnouncements.push(parseInt(announcementId));
                localStorage.setItem('readAnnouncements', JSON.stringify(readAnnouncements));
            }
        }
        modal.style.display = 'none';
    }
}

// 点击模态框外部关闭
window.onclick = function(event) {
    const modal = document.getElementById('announcementModal');
    if (event.target === modal) {
        closeAnnouncementModal();
    }
}

// 页面加载完成后开始定期更新
document.addEventListener('DOMContentLoaded', function() {
    // 立即更新一次
    updateStats();
    updateClientRanking();
    updateFeedbackList();
    updateDnsConfig();
    
    // 加载公告
    loadAnnouncements();
    
    // 绑定留言表单提交事件
    const feedbackForm = document.getElementById('feedback-form');
    if (feedbackForm) {
        feedbackForm.addEventListener('submit', submitFeedback);
    }
    
    // 每1秒更新一次统计数据
    setInterval(updateStats, 1000);
    
    // 每5秒更新一次客户端排行
    setInterval(updateClientRanking, 5000);
    
    // 每30秒更新一次留言列表
    setInterval(updateFeedbackList, 30000);
    
    // 每2分钟更新一次公告
    setInterval(loadAnnouncements, 120000);
    
    // 导航菜单控制
    const navToggle = document.getElementById('navToggle');
    const navMenu = document.getElementById('navMenu');
    
    if (navToggle && navMenu) {
        navToggle.addEventListener('click', function() {
            navToggle.classList.toggle('active');
            navMenu.classList.toggle('active');
        });
        
        // 点击菜单项后关闭菜单
        const navLinks = navMenu.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                navToggle.classList.remove('active');
                navMenu.classList.remove('active');
            });
        });
        
        // 点击页面其他地方关闭菜单
        document.addEventListener('click', function(e) {
            if (!navToggle.contains(e.target) && !navMenu.contains(e.target)) {
                navToggle.classList.remove('active');
                navMenu.classList.remove('active');
            }
        });
    }
});
</script>
</body>
</html>