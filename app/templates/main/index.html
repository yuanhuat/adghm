<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>主页 - AdGuardHome用户管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="main-container">
        <header class="main-header">
            <h1>欢迎，{{ current_user.username }}</h1>
            <nav class="main-nav">
                <a href="{{ url_for('main.clients') }}">客户端管理</a>
                <a href="{{ url_for('main.guide') }}">使用指南</a>
                {% if current_user.is_admin %}
                <a href="{{ url_for('admin.index') }}">管理员后台</a>
                {% endif %}
                <a href="{{ url_for('auth.logout') }}">退出登录</a>
            </nav>
        </header>
        
        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <div class="dashboard">
                <div class="dashboard-card">
                    <h2>我的客户端</h2>
                    <p class="dashboard-stat">{{ current_user.client_mappings|length }}</p>
                    <a href="{{ url_for('main.clients') }}" class="btn btn-primary">管理客户端</a>
                </div>
                
                <div class="dashboard-card">
                      <h2>我的DNS请求数</h2>
                      <p class="dashboard-stat" id="user-request-count">{{ user_request_count or 0 }}</p>
                      <p>您的客户端总请求数量</p>
                  </div>
                  
                  <div class="dashboard-card">
                      <h2>总DNS查询数</h2>
                      <p class="dashboard-stat" id="total-dns-queries">{{ total_dns_queries or 0 }}</p>
                      <p>AdGuardHome总查询数量</p>
                  </div>
                
                <div class="dashboard-card">
                    <h2>账号信息</h2>
                    <div class="info-list">
                        <p><strong>用户名：</strong>{{ current_user.username }}</p>
                        <p><strong>注册时间：</strong>{{ current_user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        <p><strong>账号类型：</strong>{% if current_user.is_admin %}管理员{% else %}普通用户{% endif %}</p>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h2>我的域名</h2>
                    <div class="info-list" id="domain-info">
                        {% if domain_mapping %}
                        <p><strong>域名：</strong>{{ domain_mapping.full_domain }}</p>
                        <p><strong>创建时间：</strong>{{ domain_mapping.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        {% else %}
                        <p>您还没有域名映射记录</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h2>客户端排行榜</h2>
                    <div class="ranking-list" id="client-ranking">
                        <p>加载中...</p>
                    </div>
                </div>
            </div>
            

        </main>
    </div>

<script>
// 动态更新统计数据
function updateStats() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            // 更新用户请求数
            const userRequestElement = document.getElementById('user-request-count');
            if (userRequestElement) {
                userRequestElement.textContent = data.user_request_count || 0;
            }
            
            // 更新总DNS查询数
            const totalQueriesElement = document.getElementById('total-dns-queries');
            if (totalQueriesElement) {
                totalQueriesElement.textContent = data.total_dns_queries || 0;
            }
        })
        .catch(error => {
            // 静默处理错误，不显示日志
        });
}

// 动态更新客户端排行数据
function updateClientRanking() {
    fetch('/api/client_ranking')
        .then(response => response.json())
        .then(data => {
            const rankingElement = document.getElementById('client-ranking');
            if (rankingElement && data.client_ranking) {
                if (data.client_ranking.length === 0) {
                    rankingElement.innerHTML = '<p>暂无数据</p>';
                } else {
                    let html = '<div class="ranking-items">';
                    data.client_ranking.forEach((client, index) => {
                        const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-other';
                        const currentUserClass = client.is_current_user ? 'current-user' : '';
                        html += `
                            <div class="ranking-item ${rankClass} ${currentUserClass}">
                                <span class="rank-number">${index + 1}</span>
                                <div class="client-info">
                                    <div class="client-name">${client.client_name}</div>
                                    <div class="user-name">${client.user_name}</div>
                                </div>
                                <span class="request-count">${client.request_count.toLocaleString()}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    rankingElement.innerHTML = html;
                }
            }
        })
        .catch(error => {
            // 静默处理错误，不显示日志
        });
}

// 页面加载完成后开始定期更新
document.addEventListener('DOMContentLoaded', function() {
    // 立即更新一次
    updateStats();
    updateClientRanking();
    
    // 每1秒更新一次统计数据
    setInterval(updateStats, 1000);
    
    // 每5秒更新一次客户端排行
    setInterval(updateClientRanking, 5000);
});
</script>
</body>
</html>