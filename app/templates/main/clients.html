<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ seo_config.title if seo_config else '客户端管理 - AdGuardHome用户管理系统' }}</title>
    
    <!-- SEO Meta Tags -->
    {% include 'components/seo_meta.html' %}
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/clients.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fontawesome/all.min.css') }}">
    
    <style>
        /* 优化规则类型选择器样式 */
        #ruleType {
            background: linear-gradient(135deg, #2c2c2e 0%, #1c1c1e 100%);
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        
        #ruleType:hover {
            border-color: #007bff;
            background: linear-gradient(135deg, #3a3a3c 0%, #2c2c2e 100%);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
            transform: translateY(-1px);
        }
        
        #ruleType:focus {
            border-color: #007bff;
            background: linear-gradient(135deg, #3a3a3c 0%, #2c2c2e 100%);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
            outline: none;
        }
        
        #ruleType option {
            padding: 8px 12px;
            font-size: 14px;
            background-color: #2c2c2e;
            color: #ffffff;
        }
        
        #ruleType option[value="block"] {
            background-color: #3d1a1a;
            color: #ff6b6b;
        }
        
        #ruleType option[value="allow"] {
            background-color: #1a3d1a;
            color: #4caf50;
        }
        
        /* 优化上游DNS配置文本框样式 */
        #upstreamsConfig {
            background: linear-gradient(135deg, #2c2c2e 0%, #1c1c1e 100%);
            color: #ffffff;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            min-height: 120px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        #upstreamsConfig:hover {
            border-color: #007bff;
            background: linear-gradient(135deg, #3a3a3c 0%, #2c2c2e 100%);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
            transform: translateY(-1px);
        }
        
        #upstreamsConfig:focus {
            border-color: #007bff;
            background: linear-gradient(135deg, #3a3a3c 0%, #2c2c2e 100%);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
            outline: none;
        }
        
        #upstreamsConfig::placeholder {
            color: #888;
            font-style: italic;
        }
        
        /* 优化表单文本样式 */
        .form-text {
            color: #aaa;
            font-size: 12px;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="apple-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <svg class="brand-icon" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span>AdGuard Home</span>
            </div>
            <button class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-menu" id="navMenu">
                <a href="{{ url_for('main.dashboard') }}" class="nav-link">主页</a>
                <a href="{{ url_for('main.clients') }}" class="nav-link">客户端</a>
                <a href="{{ url_for('main.guide') }}" class="nav-link">指南</a>
                <a href="{{ url_for('main.donation') }}" class="nav-link">支持</a>
                {% if donation_config and donation_config.show_ranking %}
                <a href="{{ url_for('main.donation_ranking') }}" class="nav-link">排行榜</a>
                {% endif %}
                {% if current_user.is_admin %}
                <a href="{{ url_for('admin.index') }}" class="nav-link">管理后台</a>
                {% endif %}
                <a href="{{ url_for('auth.logout') }}" class="nav-link">退出</a>
            </div>
        </div>
    </nav>
    
    <div class="main-container">
        
        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <div class="client-list">
                <div class="client-header">
                    <h2>我的客户端列表</h2>
                    {% if current_user.is_vip() %}
                    <button class="btn btn-primary" id="createClientBtn">
                        <i class="fas fa-plus"></i> 创建新客户端
                    </button>
                    {% endif %}
                </div>
                {% if current_user.client_mappings %}
                <table>
                    <thead>
                        <tr>
                            <th>客户端名称</th>
                            <th>客户端ID</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mapping in current_user.client_mappings %}
                        <tr>
                            <td>{{ mapping.client_name }}</td>
                            <td>
                                <ul class="client-ids">
                                    {% for client_id in mapping.client_ids %}
                                    <li>{{ client_id }}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                            <td>{{ mapping.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>
                                {% if current_user.is_vip() %}
                                <button class="btn btn-info btn-sm" onclick="editUpstreams('{{ mapping.client_name }}', {{ mapping.id }})"
                                        title="编辑上游DNS">
                                    <i class="fas fa-cog"></i> 上游DNS
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="manageCustomRules('{{ mapping.client_ids[0] if mapping.client_ids else '' }}', '{{ mapping.client_name }}')"
                                        title="管理自定义规则">
                                    <i class="fas fa-filter"></i> 自定义规则
                                </button>
                                {% if not loop.first %}
                                <button class="btn btn-danger btn-sm" onclick="deleteClient({{ mapping.id }}, '{{ mapping.client_name }}')"
                                        title="删除客户端">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">{% if loop.first %}主客户端{% else %}仅VIP可编辑{% endif %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="no-data">您还没有客户端。</p>
                {% endif %}
            </div>
        </main>
    </div>
    
    <!-- 创建客户端模态框 -->
    {% if current_user.is_vip() %}
    <div id="createClientModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>创建新客户端</h3>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createClientForm">
                    <div class="form-group">
                        <label for="clientName">客户端名称:</label>
                        <input type="text" id="clientName" name="client_name" required placeholder="请输入客户端名称（仅限英文字母）">
                    </div>
                    <div class="form-group">
                        <label for="clientId">客户端ID:</label>
                        <input type="text" id="clientId" name="client_id" required placeholder="请输入客户端ID（仅限小写字母、数字等）">
                        <small class="form-text">客户端ID用于标识设备，可以是IP地址或设备名称</small>
                    </div>
                    <!-- 客户端标签选择功能已隐藏，VIP用户默认使用user_child标签 -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">取消</button>
                        <button type="submit" class="btn btn-primary">创建客户端</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 编辑上游DNS模态框 -->
    {% if current_user.is_vip() %}
    <div id="editUpstreamsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑上游DNS配置</h3>
                <span class="close" id="closeUpstreamsModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editUpstreamsForm">
                    <div class="form-group">
                        <label for="clientNameDisplay">客户端名称:</label>
                        <input type="text" id="clientNameDisplay" readonly class="form-control-readonly">
                        <input type="hidden" id="clientMappingId">
                        <input type="hidden" id="clientNameHidden">
                    </div>
                    <div class="form-group">
                        <label for="upstreamsConfig">上游DNS服务器:</label>
                        <textarea id="upstreamsConfig" name="upstreams" rows="8" 
                                  placeholder="📡 每行一个DNS服务器，支持多种格式：&#10;&#10;🔹 普通DNS: 8.8.8.8&#10;🔹 DoH: https://dns.google/dns-query&#10;🔹 DoT: tls://dns.google&#10;🔹 IPv6: 2001:4860:4860::8888&#10;&#10;💡 留空将使用全局DNS设置"
                                  class="form-control"></textarea>
                        <small class="form-text">✨ 支持普通DNS、DoH(HTTPS)、DoT(TLS)、IPv6等多种格式 | 🌐 留空将继承全局DNS配置</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelUpstreamsBtn">取消</button>
                        <button type="submit" class="btn btn-primary">保存配置</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 自定义规则管理模态框 -->
    {% if current_user.is_vip() %}
    <div id="customRulesModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>管理自定义过滤规则</h3>
                <span class="close" id="closeCustomRulesModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>客户端信息:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="customRulesClientName" readonly class="form-control-readonly" style="flex: 1;" placeholder="客户端名称">
                        <input type="text" id="customRulesClientId" readonly class="form-control-readonly" style="flex: 1;" placeholder="客户端ID">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="newCustomRule">添加新规则:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <select id="ruleType" class="form-select" style="width: 130px; border-radius: 8px; border: 2px solid #3a3a3c; font-weight: 500; transition: all 0.3s ease;">
                            <option value="block" style="color: #dc3545; font-weight: 500;">🚫 阻止</option>
                            <option value="allow" style="color: #28a745; font-weight: 500;">✅ 允许</option>
                        </select>
                        <input type="text" id="newCustomRule" class="form-control" style="flex: 1;" placeholder="输入域名或规则，如: example.com 或 ||ads.example.com^">
                        <button type="button" class="btn btn-primary" onclick="addCustomRule()">添加</button>
                    </div>
                    <small class="form-text">支持AdGuard语法，如: ||example.com^ (阻止域名), @@||example.com^ (允许域名)</small>
                </div>
                
                <div class="form-group">
                    <label>当前规则列表:</label>
                    <div id="customRulesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                        <div class="loading-spinner" style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> 加载中...
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelCustomRulesBtn">关闭</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
    // 导航菜单控制
    document.addEventListener('DOMContentLoaded', function() {
        const navToggle = document.getElementById('navToggle');
        const navMenu = document.getElementById('navMenu');
        
        if (navToggle && navMenu) {
            navToggle.addEventListener('click', function() {
                navToggle.classList.toggle('active');
                navMenu.classList.toggle('active');
            });
    
    // 显示客户端ID错误信息
    function showClientIdError(inputElement, message) {
        removeClientIdError(inputElement); // 先移除现有错误信息
        
        const errorMsg = document.createElement('small');
        errorMsg.className = 'client-id-error-message';
        errorMsg.style.color = '#dc3545';
        errorMsg.style.display = 'block';
        errorMsg.style.marginTop = '5px';
        errorMsg.textContent = message;
        
        inputElement.parentNode.appendChild(errorMsg);
    }
    
    // 移除客户端ID错误信息
    function removeClientIdError(inputElement) {
        const errorMsg = inputElement.parentNode.querySelector('.client-id-error-message');
        if (errorMsg) {
            errorMsg.remove();
        }
    }
    
    // 显示客户端名称错误信息
    function showClientNameError(inputElement, message) {
        removeClientNameError(inputElement); // 先移除现有错误信息
        
        const errorMsg = document.createElement('small');
        errorMsg.className = 'client-name-error-message';
        errorMsg.style.color = '#dc3545';
        errorMsg.style.display = 'block';
        errorMsg.style.marginTop = '5px';
        errorMsg.textContent = message;
        
        inputElement.parentNode.appendChild(errorMsg);
    }
    
    // 移除客户端名称错误信息
    function removeClientNameError(inputElement) {
        const errorMsg = inputElement.parentNode.querySelector('.client-name-error-message');
        if (errorMsg) {
            errorMsg.remove();
        }
    }
    
    // 检查客户端ID是否重复
    function checkClientIdDuplicate(clientId, inputElement) {
        // 移除之前的重复检查错误信息
        const existingDuplicateMsg = inputElement.parentNode.querySelector('.client-id-duplicate-message');
        if (existingDuplicateMsg) {
            existingDuplicateMsg.remove();
        }
        
        fetch('/api/clients/check-duplicate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                client_id: clientId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.duplicate) {
                    // 显示重复错误信息
                    const errorMsg = document.createElement('small');
                    errorMsg.className = 'client-id-duplicate-message';
                    errorMsg.style.color = '#dc3545';
                    errorMsg.style.display = 'block';
                    errorMsg.style.marginTop = '5px';
                    errorMsg.textContent = data.message;
                    
                    inputElement.parentNode.appendChild(errorMsg);
                } else {
                    // 显示可用信息
                    const successMsg = document.createElement('small');
                    successMsg.className = 'client-id-duplicate-message';
                    successMsg.style.color = '#28a745';
                    successMsg.style.display = 'block';
                    successMsg.style.marginTop = '5px';
                    successMsg.textContent = '✓ 客户端ID可用';
                    
                    inputElement.parentNode.appendChild(successMsg);
                    
                    // 3秒后移除成功信息
                    setTimeout(() => {
                        if (successMsg && successMsg.parentNode) {
                            successMsg.remove();
                        }
                    }, 3000);
                }
            } else {
                // 处理API返回的错误（包括重复检测）
                if (data.duplicate) {
                    // 显示重复错误信息
                    const errorMsg = document.createElement('small');
                    errorMsg.className = 'client-id-duplicate-message';
                    errorMsg.style.color = '#dc3545';
                    errorMsg.style.display = 'block';
                    errorMsg.style.marginTop = '5px';
                    errorMsg.textContent = data.message;
                    
                    inputElement.parentNode.appendChild(errorMsg);
                } else {
                    console.error('检查客户端ID重复失败:', data.message);
                }
            }
        })
        .catch(error => {
            console.error('检查客户端ID重复时发生网络错误:', error);
        });
    }
    
    // 检查客户端名称是否重复
    function checkClientNameDuplicate(clientName, inputElement) {
        // 移除之前的重复检查错误信息
        const existingDuplicateMsg = inputElement.parentNode.querySelector('.client-name-duplicate-message');
        if (existingDuplicateMsg) {
            existingDuplicateMsg.remove();
        }
        
        fetch('/api/clients/check-name-duplicate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                client_name: clientName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.duplicate) {
                    // 显示重复错误信息
                    const errorMsg = document.createElement('small');
                    errorMsg.className = 'client-name-duplicate-message';
                    errorMsg.style.color = '#dc3545';
                    errorMsg.style.display = 'block';
                    errorMsg.style.marginTop = '5px';
                    errorMsg.textContent = data.message;
                    
                    inputElement.parentNode.appendChild(errorMsg);
                } else {
                    // 显示可用信息
                    const successMsg = document.createElement('small');
                    successMsg.className = 'client-name-duplicate-message';
                    successMsg.style.color = '#28a745';
                    successMsg.style.display = 'block';
                    successMsg.style.marginTop = '5px';
                    successMsg.textContent = '✓ 客户端名称可用';
                    
                    inputElement.parentNode.appendChild(successMsg);
                    
                    // 3秒后移除成功信息
                    setTimeout(() => {
                        if (successMsg && successMsg.parentNode) {
                            successMsg.remove();
                        }
                    }, 3000);
                }
            } else {
                // 处理API返回的错误（包括重复检测）
                if (data.duplicate) {
                    // 显示重复错误信息
                    const errorMsg = document.createElement('small');
                    errorMsg.className = 'client-name-duplicate-message';
                    errorMsg.style.color = '#dc3545';
                    errorMsg.style.display = 'block';
                    errorMsg.style.marginTop = '5px';
                    errorMsg.textContent = data.message;
                    
                    inputElement.parentNode.appendChild(errorMsg);
                } else {
                    console.error('检查客户端名称重复失败:', data.message);
                }
            }
        })
        .catch(error => {
            console.error('检查客户端名称重复时发生网络错误:', error);
        });
    }
        }
        
        // 创建客户端模态框控制
        const createClientBtn = document.getElementById('createClientBtn');
        const createClientModal = document.getElementById('createClientModal');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const createClientForm = document.getElementById('createClientForm');
        const clientIdInput = document.getElementById('clientId');
        const clientNameInput = document.getElementById('clientName');
        
        // 上游DNS编辑模态框控制
        const editUpstreamsModal = document.getElementById('editUpstreamsModal');
        const closeUpstreamsModal = document.getElementById('closeUpstreamsModal');
        const cancelUpstreamsBtn = document.getElementById('cancelUpstreamsBtn');
        const editUpstreamsForm = document.getElementById('editUpstreamsForm');
        
        // 客户端ID输入验证 - 限制特殊字符和重复检测
        let duplicateCheckTimeout;
        if (clientIdInput) {
            clientIdInput.addEventListener('input', function(e) {
                // 只允许小写字母、数字、点号、连字符、下划线和冒号（用于IPv6）
                const allowedPattern = /^[a-z0-9._:-]*$/;
                const value = e.target.value;
                
                if (!allowedPattern.test(value)) {
                    // 移除不允许的字符
                    e.target.value = value.replace(/[^a-z0-9._:-]/g, '');
                    
                    // 显示提示信息
                    showClientIdError(e.target, '客户端ID只能包含小写字母、数字、点号(.)、连字符(-)、下划线(_)和冒号(:)');
                } else {
                    // 移除格式错误信息
                    removeClientIdError(e.target);
                    
                    // 防抖检查重复
                    clearTimeout(duplicateCheckTimeout);
                    if (e.target.value.trim().length > 0) {
                        duplicateCheckTimeout = setTimeout(() => {
                            checkClientIdDuplicate(e.target.value.trim(), e.target);
                        }, 500); // 500ms防抖
                    }
                }
            });
            
            // 失去焦点时也检查重复
            clientIdInput.addEventListener('blur', function(e) {
                if (e.target.value.trim().length > 0) {
                    checkClientIdDuplicate(e.target.value.trim(), e.target);
                }
            });
            
            // 防止粘贴不合法字符
            clientIdInput.addEventListener('paste', function(e) {
                setTimeout(() => {
                    const allowedPattern = /^[a-z0-9._:-]*$/;
                    const value = e.target.value;
                    
                    if (!allowedPattern.test(value)) {
                        e.target.value = value.replace(/[^a-z0-9._:-]/g, '');
                    }
                }, 0);
            });
        }
        
        // 客户端名称输入验证 - 限制只能输入英文字符和重复检测
        let nameCheckTimeout;
        if (clientNameInput) {
            clientNameInput.addEventListener('input', function(e) {
                // 只允许英文字母（大小写）
                const allowedPattern = /^[a-zA-Z]*$/;
                const value = e.target.value;
                
                if (!allowedPattern.test(value)) {
                    // 移除不允许的字符
                    e.target.value = value.replace(/[^a-zA-Z]/g, '');
                    
                    // 显示提示信息
                    showClientNameError(e.target, '客户端名称只能包含英文字母');
                } else {
                    // 移除格式错误信息
                    removeClientNameError(e.target);
                    
                    // 防抖检查重复
                    clearTimeout(nameCheckTimeout);
                    if (e.target.value.trim().length > 0) {
                        nameCheckTimeout = setTimeout(() => {
                            checkClientNameDuplicate(e.target.value.trim(), e.target);
                        }, 500); // 500ms防抖
                    }
                }
            });
            
            // 失去焦点时也检查重复
            clientNameInput.addEventListener('blur', function(e) {
                if (e.target.value.trim().length > 0) {
                    checkClientNameDuplicate(e.target.value.trim(), e.target);
                }
            });
            
            // 防止粘贴不合法字符
            clientNameInput.addEventListener('paste', function(e) {
                setTimeout(() => {
                    const allowedPattern = /^[a-zA-Z]*$/;
                    const value = e.target.value;
                    
                    if (!allowedPattern.test(value)) {
                        e.target.value = value.replace(/[^a-zA-Z]/g, '');
                        showClientNameError(e.target, '客户端名称只能包含英文字母');
                    } else {
                        removeClientNameError(e.target);
                        
                        // 粘贴后也检查重复
                        if (e.target.value.trim().length > 0) {
                            clearTimeout(nameCheckTimeout);
                            nameCheckTimeout = setTimeout(() => {
                                checkClientNameDuplicate(e.target.value.trim(), e.target);
                            }, 500);
                        }
                    }
                }, 0);
            });
        }
        
        if (createClientBtn && createClientModal) {
            // 打开模态框
            createClientBtn.addEventListener('click', function() {
                createClientModal.style.display = 'block';
            });
            
            // 关闭模态框
            function closeModalFunc() {
                createClientModal.style.display = 'none';
                createClientForm.reset();
            }
            
            closeModal.addEventListener('click', closeModalFunc);
            cancelBtn.addEventListener('click', closeModalFunc);
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(e) {
                if (e.target === createClientModal) {
                    closeModalFunc();
                }
            });
            
            // 表单提交
            createClientForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(createClientForm);
                const clientName = formData.get('client_name');
                const clientId = formData.get('client_id');
                
                // 提交前再次验证客户端名称
                const clientNamePattern = /^[a-zA-Z]+$/;
                if (!clientNamePattern.test(clientName)) {
                    alert('客户端名称格式不正确！只能包含英文字母');
                    return;
                }
                
                // 提交前再次验证客户端ID
                const allowedPattern = /^[a-z0-9._:-]+$/;
                if (!allowedPattern.test(clientId)) {
                    alert('客户端ID格式不正确！只能包含小写字母、数字、点号(.)、连字符(-)、下划线(_)和冒号(:)');
                    return;
                }
                
                // 检查客户端ID长度
                if (clientId.length < 1 || clientId.length > 100) {
                    alert('客户端ID长度必须在1-100个字符之间！');
                    return;
                }
                
                // 检查是否存在重复错误信息
                const duplicateErrorMsg = document.querySelector('.client-id-duplicate-message[style*="color: rgb(220, 53, 69)"]');
                if (duplicateErrorMsg) {
                    alert('客户端ID已存在，请使用其他ID！');
                    return;
                }
                
                // 发送创建请求
                fetch('/api/clients/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_name: clientName,
                        client_id: clientId,
                        tags: ['user_child']
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('客户端创建成功！');
                        location.reload(); // 刷新页面显示新客户端
                    } else {
                        alert('创建失败：' + (data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('创建失败：网络错误');
                });
            });
        }
        
        // 上游DNS编辑模态框事件处理
        if (editUpstreamsModal && closeUpstreamsModal && cancelUpstreamsBtn && editUpstreamsForm) {
            // 关闭模态框函数
            function closeUpstreamsModalFunc() {
                editUpstreamsModal.style.display = 'none';
                editUpstreamsForm.reset();
            }
            
            // 关闭模态框事件
            closeUpstreamsModal.addEventListener('click', closeUpstreamsModalFunc);
            cancelUpstreamsBtn.addEventListener('click', closeUpstreamsModalFunc);
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(e) {
                if (e.target === editUpstreamsModal) {
                    closeUpstreamsModalFunc();
                }
            });
            
            // 表单提交处理
            editUpstreamsForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const clientName = document.getElementById('clientNameHidden').value;
                const upstreamsText = document.getElementById('upstreamsConfig').value;
                
                // 将文本转换为数组，过滤空行
                const upstreams = upstreamsText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                // 发送更新请求
                fetch(`/api/clients/${clientName}/upstreams`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        upstreams: upstreams
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('上游DNS配置更新成功！');
                        closeUpstreamsModalFunc();
                    } else {
                        alert('更新失败：' + (data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('更新失败：网络错误');
                });
            });
        }
        
        // 点击菜单项后关闭菜单
        if (navToggle && navMenu) {
            const navLinks = navMenu.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    navToggle.classList.remove('active');
                    navMenu.classList.remove('active');
                });
            });
            
            // 点击页面其他地方关闭菜单
            document.addEventListener('click', function(e) {
                if (!navToggle.contains(e.target) && !navMenu.contains(e.target)) {
                    navToggle.classList.remove('active');
                    navMenu.classList.remove('active');
                }
            });
        }
    });
    
    // 删除客户端函数
    function deleteClient(mappingId, clientName) {
        if (confirm(`确定要删除客户端 "${clientName}" 吗？\n\n注意：删除后将无法恢复，该客户端的所有配置都将丢失。`)) {
            fetch(`/api/clients/${mappingId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('客户端删除成功！');
                    location.reload(); // 刷新页面
                } else {
                    alert('删除失败：' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('删除失败：网络错误');
            });
        }
    }

    // 自定义规则管理相关函数
    let currentClientId = '';
    let currentClientName = '';

    /**
     * 打开自定义规则管理模态框
     * @param {string} clientId - 客户端ID
     * @param {string} clientName - 客户端名称
     */
    function manageCustomRules(clientId, clientName) {
        currentClientId = clientId;
        currentClientName = clientName;
        
        document.getElementById('customRulesClientId').value = clientId;
        document.getElementById('customRulesClientName').value = clientName;
        document.getElementById('newCustomRule').value = '';
        document.getElementById('ruleType').value = 'block';
        
        // 显示模态框
        document.getElementById('customRulesModal').style.display = 'block';
        
        // 加载当前规则
        loadCustomRules(clientId);
    }

    /**
     * 加载客户端的自定义规则
     * @param {string} clientId - 客户端ID
     */
    function loadCustomRules(clientId) {
        const rulesList = document.getElementById('customRulesList');
        rulesList.innerHTML = '<div class="loading-spinner" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> 加载中...</div>';
        
        fetch(`/api/clients/${clientId}/custom-rules`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayCustomRules(data.rules);
                } else {
                    rulesList.innerHTML = '<div class="alert alert-danger">加载规则失败: ' + (data.error || '未知错误') + '</div>';
                }
            })
            .catch(error => {
                rulesList.innerHTML = '<div class="alert alert-danger">加载规则失败: ' + error.message + '</div>';
            });
    }

    /**
     * 显示自定义规则列表
     * @param {Array} rules - 规则数组
     */
    function displayCustomRules(rules) {
        const rulesList = document.getElementById('customRulesList');
        
        if (rules.length === 0) {
            rulesList.innerHTML = '<div class="text-muted" style="text-align: center; padding: 20px;">暂无自定义规则</div>';
            return;
        }
        
        let html = '<div class="rules-list">';
        rules.forEach((rule, index) => {
            const ruleType = rule.startsWith('@@') ? 'allow' : 'block';
            const ruleText = rule.startsWith('@@') ? rule.substring(2) : rule;
            const badgeClass = ruleType === 'allow' ? 'badge-success' : 'badge-danger';
            const typeText = ruleType === 'allow' ? '允许' : '阻止';
            
            html += `
                <div class="rule-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                    <div style="flex: 1;">
                        <span class="badge ${badgeClass}" style="margin-right: 8px;">${typeText}</span>
                        <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">${ruleText}</code>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeCustomRule('${rule.replace(/'/g, "\\'")}')"
                            title="删除规则">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        });
        html += '</div>';
        
        rulesList.innerHTML = html;
    }

    /**
     * 添加自定义规则
     */
    function addCustomRule() {
        const ruleInput = document.getElementById('newCustomRule');
        const ruleType = document.getElementById('ruleType').value;
        let rule = ruleInput.value.trim();
        
        if (!rule) {
            alert('请输入规则内容');
            return;
        }
        
        // 根据规则类型添加前缀
        if (ruleType === 'allow' && !rule.startsWith('@@')) {
            rule = '@@' + rule;
        } else if (ruleType === 'block' && rule.startsWith('@@')) {
            rule = rule.substring(2);
        }
        
        // 如果是简单域名，转换为AdGuard格式
        if (!rule.includes('||') && !rule.includes('^') && !rule.includes('*') && !rule.includes('/')) {
            if (rule.startsWith('@@')) {
                rule = '@@||' + rule.substring(2) + '^';
            } else {
                rule = '||' + rule + '^';
            }
        }
        
        fetch(`/api/clients/${currentClientId}/custom-rules`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rule: rule })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                ruleInput.value = '';
                loadCustomRules(currentClientId);
            } else {
                alert('添加规则失败: ' + (data.error || '未知错误'));
            }
        })
        .catch(error => {
            alert('添加规则失败: ' + error.message);
        });
    }

    /**
     * 删除自定义规则
     * @param {string} rule - 要删除的规则
     */
    function removeCustomRule(rule) {
        if (!confirm('确定要删除这条规则吗？')) {
            return;
        }
        
        fetch(`/api/clients/${currentClientId}/custom-rules`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rule: rule })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadCustomRules(currentClientId);
            } else {
                alert('删除规则失败: ' + (data.error || '未知错误'));
            }
        })
        .catch(error => {
            alert('删除规则失败: ' + error.message);
        });
    }

    // 自定义规则模态框事件处理
    document.addEventListener('DOMContentLoaded', function() {
        const customRulesModal = document.getElementById('customRulesModal');
        const closeCustomRulesModal = document.getElementById('closeCustomRulesModal');
        const cancelCustomRulesBtn = document.getElementById('cancelCustomRulesBtn');
        const newCustomRuleInput = document.getElementById('newCustomRule');
        
        // 关闭模态框
        function closeCustomRulesModalFunc() {
            customRulesModal.style.display = 'none';
            currentClientId = '';
            currentClientName = '';
        }
        
        if (closeCustomRulesModal) {
            closeCustomRulesModal.addEventListener('click', closeCustomRulesModalFunc);
        }
        
        if (cancelCustomRulesBtn) {
            cancelCustomRulesBtn.addEventListener('click', closeCustomRulesModalFunc);
        }
        
        // 点击模态框外部关闭
        if (customRulesModal) {
            customRulesModal.addEventListener('click', function(e) {
                if (e.target === customRulesModal) {
                    closeCustomRulesModalFunc();
                }
            });
        }
        
        // 回车键添加规则
        if (newCustomRuleInput) {
            newCustomRuleInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCustomRule();
                }
            });
        }
    });

    // 编辑上游DNS配置函数
    function editUpstreams(clientName, mappingId) {
        const modal = document.getElementById('editUpstreamsModal');
        const clientNameDisplay = document.getElementById('clientNameDisplay');
        const clientNameHidden = document.getElementById('clientNameHidden');
        const clientMappingId = document.getElementById('clientMappingId');
        const upstreamsConfig = document.getElementById('upstreamsConfig');
        
        // 设置客户端信息
        clientNameDisplay.value = clientName;
        clientNameHidden.value = clientName;
        clientMappingId.value = mappingId;
        
        // 获取当前上游配置
        fetch(`/api/clients/${clientName}/upstreams`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 将上游DNS数组转换为每行一个的文本
                    upstreamsConfig.value = (data.upstreams || []).join('\n');
                } else {
                    console.error('获取上游配置失败:', data.message);
                    upstreamsConfig.value = '';
                }
            })
            .catch(error => {
                console.error('获取上游配置时发生网络错误:', error);
                upstreamsConfig.value = '';
            });
        
        // 显示模态框
        modal.style.display = 'block';
    }

    </script>
</body>
</html>