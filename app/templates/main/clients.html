<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ seo_config.title if seo_config else 'å®¢æˆ·ç«¯ç®¡ç† - AdGuardHomeç”¨æˆ·ç®¡ç†ç³»ç»Ÿ' }}</title>
    
    <!-- SEO Meta Tags -->
    {% include 'components/seo_meta.html' %}
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/clients.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fontawesome/all.min.css') }}">
    
    <style>
        /* ä¼˜åŒ–è§„åˆ™ç±»å‹é€‰æ‹©å™¨æ ·å¼ */
        #ruleType {
            background: linear-gradient(135deg, #2c2c2e 0%, #1c1c1e 100%);
            color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        
        #ruleType:hover {
            border-color: #007bff;
            background: linear-gradient(135deg, #3a3a3c 0%, #2c2c2e 100%);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
            transform: translateY(-1px);
        }
        
        #ruleType:focus {
            border-color: #007bff;
            background: linear-gradient(135deg, #3a3a3c 0%, #2c2c2e 100%);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
            outline: none;
        }
        
        #ruleType option {
            padding: 8px 12px;
            font-size: 14px;
            background-color: #2c2c2e;
            color: #ffffff;
        }
        
        #ruleType option[value="block"] {
            background-color: #3d1a1a;
            color: #ff6b6b;
        }
        
        #ruleType option[value="allow"] {
            background-color: #1a3d1a;
            color: #4caf50;
        }
        
        /* ä¼˜åŒ–ä¸Šæ¸¸DNSé…ç½®æ–‡æœ¬æ¡†æ ·å¼ */
        #upstreamsConfig {
            background: linear-gradient(135deg, #2c2c2e 0%, #1c1c1e 100%);
            color: #ffffff;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            min-height: 120px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        #upstreamsConfig:hover {
            border-color: #007bff;
            background: linear-gradient(135deg, #3a3a3c 0%, #2c2c2e 100%);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
            transform: translateY(-1px);
        }
        
        #upstreamsConfig:focus {
            border-color: #007bff;
            background: linear-gradient(135deg, #3a3a3c 0%, #2c2c2e 100%);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
            outline: none;
        }
        
        #upstreamsConfig::placeholder {
            color: #888;
            font-style: italic;
        }
        
        /* ä¼˜åŒ–è¡¨å•æ–‡æœ¬æ ·å¼ */
        .form-text {
            color: #aaa;
            font-size: 12px;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="apple-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <svg class="brand-icon" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span>AdGuard Home</span>
            </div>
            <button class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-menu" id="navMenu">
                <a href="{{ url_for('main.dashboard') }}" class="nav-link">ä¸»é¡µ</a>
                <a href="{{ url_for('main.clients') }}" class="nav-link">å®¢æˆ·ç«¯</a>
                <a href="{{ url_for('main.guide') }}" class="nav-link">æŒ‡å—</a>
                <a href="{{ url_for('main.donation') }}" class="nav-link">æ”¯æŒ</a>
                {% if donation_config and donation_config.show_ranking %}
                <a href="{{ url_for('main.donation_ranking') }}" class="nav-link">æ’è¡Œæ¦œ</a>
                {% endif %}
                {% if current_user.is_admin %}
                <a href="{{ url_for('admin.index') }}" class="nav-link">ç®¡ç†åå°</a>
                {% endif %}
                <a href="{{ url_for('auth.logout') }}" class="nav-link">é€€å‡º</a>
            </div>
        </div>
    </nav>
    
    <div class="main-container">
        
        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <div class="client-list">
                <div class="client-header">
                    <h2>æˆ‘çš„å®¢æˆ·ç«¯åˆ—è¡¨</h2>
                    {% if current_user.is_vip() %}
                    <button class="btn btn-primary" id="createClientBtn">
                        <i class="fas fa-plus"></i> åˆ›å»ºæ–°å®¢æˆ·ç«¯
                    </button>
                    {% endif %}
                </div>
                {% if current_user.client_mappings %}
                <table>
                    <thead>
                        <tr>
                            <th>å®¢æˆ·ç«¯åç§°</th>
                            <th>å®¢æˆ·ç«¯ID</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mapping in current_user.client_mappings %}
                        <tr>
                            <td>{{ mapping.client_name }}</td>
                            <td>
                                <ul class="client-ids">
                                    {% for client_id in mapping.client_ids %}
                                    <li>{{ client_id }}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                            <td>{{ mapping.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>
                                {% if current_user.is_vip() %}
                                <button class="btn btn-info btn-sm" onclick="editUpstreams('{{ mapping.client_name }}', {{ mapping.id }})"
                                        title="ç¼–è¾‘ä¸Šæ¸¸DNS">
                                    <i class="fas fa-cog"></i> ä¸Šæ¸¸DNS
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="manageCustomRules('{{ mapping.client_ids[0] if mapping.client_ids else '' }}', '{{ mapping.client_name }}')"
                                        title="ç®¡ç†è‡ªå®šä¹‰è§„åˆ™">
                                    <i class="fas fa-filter"></i> è‡ªå®šä¹‰è§„åˆ™
                                </button>
                                {% if not loop.first %}
                                <button class="btn btn-danger btn-sm" onclick="deleteClient({{ mapping.id }}, '{{ mapping.client_name }}')"
                                        title="åˆ é™¤å®¢æˆ·ç«¯">
                                    <i class="fas fa-trash"></i> åˆ é™¤
                                </button>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">{% if loop.first %}ä¸»å®¢æˆ·ç«¯{% else %}ä»…VIPå¯ç¼–è¾‘{% endif %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="no-data">æ‚¨è¿˜æ²¡æœ‰å®¢æˆ·ç«¯ã€‚</p>
                {% endif %}
            </div>
        </main>
    </div>
    
    <!-- åˆ›å»ºå®¢æˆ·ç«¯æ¨¡æ€æ¡† -->
    {% if current_user.is_vip() %}
    <div id="createClientModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>åˆ›å»ºæ–°å®¢æˆ·ç«¯</h3>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createClientForm">
                    <div class="form-group">
                        <label for="clientName">å®¢æˆ·ç«¯åç§°:</label>
                        <input type="text" id="clientName" name="client_name" required placeholder="è¯·è¾“å…¥å®¢æˆ·ç«¯åç§°ï¼ˆä»…é™è‹±æ–‡å­—æ¯ï¼‰">
                    </div>
                    <div class="form-group">
                        <label for="clientId">å®¢æˆ·ç«¯ID:</label>
                        <input type="text" id="clientId" name="client_id" required placeholder="è¯·è¾“å…¥å®¢æˆ·ç«¯IDï¼ˆä»…é™å°å†™å­—æ¯ã€æ•°å­—ç­‰ï¼‰">
                        <small class="form-text">å®¢æˆ·ç«¯IDç”¨äºæ ‡è¯†è®¾å¤‡ï¼Œå¯ä»¥æ˜¯IPåœ°å€æˆ–è®¾å¤‡åç§°</small>
                    </div>
                    <!-- å®¢æˆ·ç«¯æ ‡ç­¾é€‰æ‹©åŠŸèƒ½å·²éšè—ï¼ŒVIPç”¨æˆ·é»˜è®¤ä½¿ç”¨user_childæ ‡ç­¾ -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">åˆ›å»ºå®¢æˆ·ç«¯</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ç¼–è¾‘ä¸Šæ¸¸DNSæ¨¡æ€æ¡† -->
    {% if current_user.is_vip() %}
    <div id="editUpstreamsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘ä¸Šæ¸¸DNSé…ç½®</h3>
                <span class="close" id="closeUpstreamsModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editUpstreamsForm">
                    <div class="form-group">
                        <label for="clientNameDisplay">å®¢æˆ·ç«¯åç§°:</label>
                        <input type="text" id="clientNameDisplay" readonly class="form-control-readonly">
                        <input type="hidden" id="clientMappingId">
                        <input type="hidden" id="clientNameHidden">
                    </div>
                    <div class="form-group">
                        <label for="upstreamsConfig">ä¸Šæ¸¸DNSæœåŠ¡å™¨:</label>
                        <textarea id="upstreamsConfig" name="upstreams" rows="8" 
                                  placeholder="ğŸ“¡ æ¯è¡Œä¸€ä¸ªDNSæœåŠ¡å™¨ï¼Œæ”¯æŒå¤šç§æ ¼å¼ï¼š&#10;&#10;ğŸ”¹ æ™®é€šDNS: 8.8.8.8&#10;ğŸ”¹ DoH: https://dns.google/dns-query&#10;ğŸ”¹ DoT: tls://dns.google&#10;ğŸ”¹ IPv6: 2001:4860:4860::8888&#10;&#10;ğŸ’¡ ç•™ç©ºå°†ä½¿ç”¨å…¨å±€DNSè®¾ç½®"
                                  class="form-control"></textarea>
                        <small class="form-text">âœ¨ æ”¯æŒæ™®é€šDNSã€DoH(HTTPS)ã€DoT(TLS)ã€IPv6ç­‰å¤šç§æ ¼å¼ | ğŸŒ ç•™ç©ºå°†ç»§æ‰¿å…¨å±€DNSé…ç½®</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelUpstreamsBtn">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- è‡ªå®šä¹‰è§„åˆ™ç®¡ç†æ¨¡æ€æ¡† -->
    {% if current_user.is_vip() %}
    <div id="customRulesModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>ç®¡ç†è‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™</h3>
                <span class="close" id="closeCustomRulesModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å®¢æˆ·ç«¯ä¿¡æ¯:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="customRulesClientName" readonly class="form-control-readonly" style="flex: 1;" placeholder="å®¢æˆ·ç«¯åç§°">
                        <input type="text" id="customRulesClientId" readonly class="form-control-readonly" style="flex: 1;" placeholder="å®¢æˆ·ç«¯ID">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="newCustomRule">æ·»åŠ æ–°è§„åˆ™:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <select id="ruleType" class="form-select" style="width: 130px; border-radius: 8px; border: 2px solid #3a3a3c; font-weight: 500; transition: all 0.3s ease;">
                            <option value="block" style="color: #dc3545; font-weight: 500;">ğŸš« é˜»æ­¢</option>
                            <option value="allow" style="color: #28a745; font-weight: 500;">âœ… å…è®¸</option>
                        </select>
                        <input type="text" id="newCustomRule" class="form-control" style="flex: 1;" placeholder="è¾“å…¥åŸŸåæˆ–è§„åˆ™ï¼Œå¦‚: example.com æˆ– ||ads.example.com^">
                        <button type="button" class="btn btn-primary" onclick="addCustomRule()">æ·»åŠ </button>
                    </div>
                    <small class="form-text">æ”¯æŒAdGuardè¯­æ³•ï¼Œå¦‚: ||example.com^ (é˜»æ­¢åŸŸå), @@||example.com^ (å…è®¸åŸŸå)</small>
                </div>
                
                <div class="form-group">
                    <label>å½“å‰è§„åˆ™åˆ—è¡¨:</label>
                    <div id="customRulesList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                        <div class="loading-spinner" style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelCustomRulesBtn">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
    // å¯¼èˆªèœå•æ§åˆ¶
    document.addEventListener('DOMContentLoaded', function() {
        const navToggle = document.getElementById('navToggle');
        const navMenu = document.getElementById('navMenu');
        
        if (navToggle && navMenu) {
            navToggle.addEventListener('click', function() {
                navToggle.classList.toggle('active');
                navMenu.classList.toggle('active');
            });
    
    // æ˜¾ç¤ºå®¢æˆ·ç«¯IDé”™è¯¯ä¿¡æ¯
    function showClientIdError(inputElement, message) {
        removeClientIdError(inputElement); // å…ˆç§»é™¤ç°æœ‰é”™è¯¯ä¿¡æ¯
        
        const errorMsg = document.createElement('small');
        errorMsg.className = 'client-id-error-message';
        errorMsg.style.color = '#dc3545';
        errorMsg.style.display = 'block';
        errorMsg.style.marginTop = '5px';
        errorMsg.textContent = message;
        
        inputElement.parentNode.appendChild(errorMsg);
    }
    
    // ç§»é™¤å®¢æˆ·ç«¯IDé”™è¯¯ä¿¡æ¯
    function removeClientIdError(inputElement) {
        const errorMsg = inputElement.parentNode.querySelector('.client-id-error-message');
        if (errorMsg) {
            errorMsg.remove();
        }
    }
    
    // æ˜¾ç¤ºå®¢æˆ·ç«¯åç§°é”™è¯¯ä¿¡æ¯
    function showClientNameError(inputElement, message) {
        removeClientNameError(inputElement); // å…ˆç§»é™¤ç°æœ‰é”™è¯¯ä¿¡æ¯
        
        const errorMsg = document.createElement('small');
        errorMsg.className = 'client-name-error-message';
        errorMsg.style.color = '#dc3545';
        errorMsg.style.display = 'block';
        errorMsg.style.marginTop = '5px';
        errorMsg.textContent = message;
        
        inputElement.parentNode.appendChild(errorMsg);
    }
    
    // ç§»é™¤å®¢æˆ·ç«¯åç§°é”™è¯¯ä¿¡æ¯
    function removeClientNameError(inputElement) {
        const errorMsg = inputElement.parentNode.querySelector('.client-name-error-message');
        if (errorMsg) {
            errorMsg.remove();
        }
    }
    
    // æ£€æŸ¥å®¢æˆ·ç«¯IDæ˜¯å¦é‡å¤
    function checkClientIdDuplicate(clientId, inputElement) {
        // ç§»é™¤ä¹‹å‰çš„é‡å¤æ£€æŸ¥é”™è¯¯ä¿¡æ¯
        const existingDuplicateMsg = inputElement.parentNode.querySelector('.client-id-duplicate-message');
        if (existingDuplicateMsg) {
            existingDuplicateMsg.remove();
        }
        
        fetch('/api/clients/check-duplicate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                client_id: clientId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.duplicate) {
                    // æ˜¾ç¤ºé‡å¤é”™è¯¯ä¿¡æ¯
                    const errorMsg = document.createElement('small');
                    errorMsg.className = 'client-id-duplicate-message';
                    errorMsg.style.color = '#dc3545';
                    errorMsg.style.display = 'block';
                    errorMsg.style.marginTop = '5px';
                    errorMsg.textContent = data.message;
                    
                    inputElement.parentNode.appendChild(errorMsg);
                } else {
                    // æ˜¾ç¤ºå¯ç”¨ä¿¡æ¯
                    const successMsg = document.createElement('small');
                    successMsg.className = 'client-id-duplicate-message';
                    successMsg.style.color = '#28a745';
                    successMsg.style.display = 'block';
                    successMsg.style.marginTop = '5px';
                    successMsg.textContent = 'âœ“ å®¢æˆ·ç«¯IDå¯ç”¨';
                    
                    inputElement.parentNode.appendChild(successMsg);
                    
                    // 3ç§’åç§»é™¤æˆåŠŸä¿¡æ¯
                    setTimeout(() => {
                        if (successMsg && successMsg.parentNode) {
                            successMsg.remove();
                        }
                    }, 3000);
                }
            } else {
                // å¤„ç†APIè¿”å›çš„é”™è¯¯ï¼ˆåŒ…æ‹¬é‡å¤æ£€æµ‹ï¼‰
                if (data.duplicate) {
                    // æ˜¾ç¤ºé‡å¤é”™è¯¯ä¿¡æ¯
                    const errorMsg = document.createElement('small');
                    errorMsg.className = 'client-id-duplicate-message';
                    errorMsg.style.color = '#dc3545';
                    errorMsg.style.display = 'block';
                    errorMsg.style.marginTop = '5px';
                    errorMsg.textContent = data.message;
                    
                    inputElement.parentNode.appendChild(errorMsg);
                } else {
                    console.error('æ£€æŸ¥å®¢æˆ·ç«¯IDé‡å¤å¤±è´¥:', data.message);
                }
            }
        })
        .catch(error => {
            console.error('æ£€æŸ¥å®¢æˆ·ç«¯IDé‡å¤æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:', error);
        });
    }
    
    // æ£€æŸ¥å®¢æˆ·ç«¯åç§°æ˜¯å¦é‡å¤
    function checkClientNameDuplicate(clientName, inputElement) {
        // ç§»é™¤ä¹‹å‰çš„é‡å¤æ£€æŸ¥é”™è¯¯ä¿¡æ¯
        const existingDuplicateMsg = inputElement.parentNode.querySelector('.client-name-duplicate-message');
        if (existingDuplicateMsg) {
            existingDuplicateMsg.remove();
        }
        
        fetch('/api/clients/check-name-duplicate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                client_name: clientName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.duplicate) {
                    // æ˜¾ç¤ºé‡å¤é”™è¯¯ä¿¡æ¯
                    const errorMsg = document.createElement('small');
                    errorMsg.className = 'client-name-duplicate-message';
                    errorMsg.style.color = '#dc3545';
                    errorMsg.style.display = 'block';
                    errorMsg.style.marginTop = '5px';
                    errorMsg.textContent = data.message;
                    
                    inputElement.parentNode.appendChild(errorMsg);
                } else {
                    // æ˜¾ç¤ºå¯ç”¨ä¿¡æ¯
                    const successMsg = document.createElement('small');
                    successMsg.className = 'client-name-duplicate-message';
                    successMsg.style.color = '#28a745';
                    successMsg.style.display = 'block';
                    successMsg.style.marginTop = '5px';
                    successMsg.textContent = 'âœ“ å®¢æˆ·ç«¯åç§°å¯ç”¨';
                    
                    inputElement.parentNode.appendChild(successMsg);
                    
                    // 3ç§’åç§»é™¤æˆåŠŸä¿¡æ¯
                    setTimeout(() => {
                        if (successMsg && successMsg.parentNode) {
                            successMsg.remove();
                        }
                    }, 3000);
                }
            } else {
                // å¤„ç†APIè¿”å›çš„é”™è¯¯ï¼ˆåŒ…æ‹¬é‡å¤æ£€æµ‹ï¼‰
                if (data.duplicate) {
                    // æ˜¾ç¤ºé‡å¤é”™è¯¯ä¿¡æ¯
                    const errorMsg = document.createElement('small');
                    errorMsg.className = 'client-name-duplicate-message';
                    errorMsg.style.color = '#dc3545';
                    errorMsg.style.display = 'block';
                    errorMsg.style.marginTop = '5px';
                    errorMsg.textContent = data.message;
                    
                    inputElement.parentNode.appendChild(errorMsg);
                } else {
                    console.error('æ£€æŸ¥å®¢æˆ·ç«¯åç§°é‡å¤å¤±è´¥:', data.message);
                }
            }
        })
        .catch(error => {
            console.error('æ£€æŸ¥å®¢æˆ·ç«¯åç§°é‡å¤æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:', error);
        });
    }
        }
        
        // åˆ›å»ºå®¢æˆ·ç«¯æ¨¡æ€æ¡†æ§åˆ¶
        const createClientBtn = document.getElementById('createClientBtn');
        const createClientModal = document.getElementById('createClientModal');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const createClientForm = document.getElementById('createClientForm');
        const clientIdInput = document.getElementById('clientId');
        const clientNameInput = document.getElementById('clientName');
        
        // ä¸Šæ¸¸DNSç¼–è¾‘æ¨¡æ€æ¡†æ§åˆ¶
        const editUpstreamsModal = document.getElementById('editUpstreamsModal');
        const closeUpstreamsModal = document.getElementById('closeUpstreamsModal');
        const cancelUpstreamsBtn = document.getElementById('cancelUpstreamsBtn');
        const editUpstreamsForm = document.getElementById('editUpstreamsForm');
        
        // å®¢æˆ·ç«¯IDè¾“å…¥éªŒè¯ - é™åˆ¶ç‰¹æ®Šå­—ç¬¦å’Œé‡å¤æ£€æµ‹
        let duplicateCheckTimeout;
        if (clientIdInput) {
            clientIdInput.addEventListener('input', function(e) {
                // åªå…è®¸å°å†™å­—æ¯ã€æ•°å­—ã€ç‚¹å·ã€è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿å’Œå†’å·ï¼ˆç”¨äºIPv6ï¼‰
                const allowedPattern = /^[a-z0-9._:-]*$/;
                const value = e.target.value;
                
                if (!allowedPattern.test(value)) {
                    // ç§»é™¤ä¸å…è®¸çš„å­—ç¬¦
                    e.target.value = value.replace(/[^a-z0-9._:-]/g, '');
                    
                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    showClientIdError(e.target, 'å®¢æˆ·ç«¯IDåªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—ã€ç‚¹å·(.)ã€è¿å­—ç¬¦(-)ã€ä¸‹åˆ’çº¿(_)å’Œå†’å·(:)');
                } else {
                    // ç§»é™¤æ ¼å¼é”™è¯¯ä¿¡æ¯
                    removeClientIdError(e.target);
                    
                    // é˜²æŠ–æ£€æŸ¥é‡å¤
                    clearTimeout(duplicateCheckTimeout);
                    if (e.target.value.trim().length > 0) {
                        duplicateCheckTimeout = setTimeout(() => {
                            checkClientIdDuplicate(e.target.value.trim(), e.target);
                        }, 500); // 500msé˜²æŠ–
                    }
                }
            });
            
            // å¤±å»ç„¦ç‚¹æ—¶ä¹Ÿæ£€æŸ¥é‡å¤
            clientIdInput.addEventListener('blur', function(e) {
                if (e.target.value.trim().length > 0) {
                    checkClientIdDuplicate(e.target.value.trim(), e.target);
                }
            });
            
            // é˜²æ­¢ç²˜è´´ä¸åˆæ³•å­—ç¬¦
            clientIdInput.addEventListener('paste', function(e) {
                setTimeout(() => {
                    const allowedPattern = /^[a-z0-9._:-]*$/;
                    const value = e.target.value;
                    
                    if (!allowedPattern.test(value)) {
                        e.target.value = value.replace(/[^a-z0-9._:-]/g, '');
                    }
                }, 0);
            });
        }
        
        // å®¢æˆ·ç«¯åç§°è¾“å…¥éªŒè¯ - é™åˆ¶åªèƒ½è¾“å…¥è‹±æ–‡å­—ç¬¦å’Œé‡å¤æ£€æµ‹
        let nameCheckTimeout;
        if (clientNameInput) {
            clientNameInput.addEventListener('input', function(e) {
                // åªå…è®¸è‹±æ–‡å­—æ¯ï¼ˆå¤§å°å†™ï¼‰
                const allowedPattern = /^[a-zA-Z]*$/;
                const value = e.target.value;
                
                if (!allowedPattern.test(value)) {
                    // ç§»é™¤ä¸å…è®¸çš„å­—ç¬¦
                    e.target.value = value.replace(/[^a-zA-Z]/g, '');
                    
                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    showClientNameError(e.target, 'å®¢æˆ·ç«¯åç§°åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯');
                } else {
                    // ç§»é™¤æ ¼å¼é”™è¯¯ä¿¡æ¯
                    removeClientNameError(e.target);
                    
                    // é˜²æŠ–æ£€æŸ¥é‡å¤
                    clearTimeout(nameCheckTimeout);
                    if (e.target.value.trim().length > 0) {
                        nameCheckTimeout = setTimeout(() => {
                            checkClientNameDuplicate(e.target.value.trim(), e.target);
                        }, 500); // 500msé˜²æŠ–
                    }
                }
            });
            
            // å¤±å»ç„¦ç‚¹æ—¶ä¹Ÿæ£€æŸ¥é‡å¤
            clientNameInput.addEventListener('blur', function(e) {
                if (e.target.value.trim().length > 0) {
                    checkClientNameDuplicate(e.target.value.trim(), e.target);
                }
            });
            
            // é˜²æ­¢ç²˜è´´ä¸åˆæ³•å­—ç¬¦
            clientNameInput.addEventListener('paste', function(e) {
                setTimeout(() => {
                    const allowedPattern = /^[a-zA-Z]*$/;
                    const value = e.target.value;
                    
                    if (!allowedPattern.test(value)) {
                        e.target.value = value.replace(/[^a-zA-Z]/g, '');
                        showClientNameError(e.target, 'å®¢æˆ·ç«¯åç§°åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯');
                    } else {
                        removeClientNameError(e.target);
                        
                        // ç²˜è´´åä¹Ÿæ£€æŸ¥é‡å¤
                        if (e.target.value.trim().length > 0) {
                            clearTimeout(nameCheckTimeout);
                            nameCheckTimeout = setTimeout(() => {
                                checkClientNameDuplicate(e.target.value.trim(), e.target);
                            }, 500);
                        }
                    }
                }, 0);
            });
        }
        
        if (createClientBtn && createClientModal) {
            // æ‰“å¼€æ¨¡æ€æ¡†
            createClientBtn.addEventListener('click', function() {
                createClientModal.style.display = 'block';
            });
            
            // å…³é—­æ¨¡æ€æ¡†
            function closeModalFunc() {
                createClientModal.style.display = 'none';
                createClientForm.reset();
            }
            
            closeModal.addEventListener('click', closeModalFunc);
            cancelBtn.addEventListener('click', closeModalFunc);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(e) {
                if (e.target === createClientModal) {
                    closeModalFunc();
                }
            });
            
            // è¡¨å•æäº¤
            createClientForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(createClientForm);
                const clientName = formData.get('client_name');
                const clientId = formData.get('client_id');
                
                // æäº¤å‰å†æ¬¡éªŒè¯å®¢æˆ·ç«¯åç§°
                const clientNamePattern = /^[a-zA-Z]+$/;
                if (!clientNamePattern.test(clientName)) {
                    alert('å®¢æˆ·ç«¯åç§°æ ¼å¼ä¸æ­£ç¡®ï¼åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯');
                    return;
                }
                
                // æäº¤å‰å†æ¬¡éªŒè¯å®¢æˆ·ç«¯ID
                const allowedPattern = /^[a-z0-9._:-]+$/;
                if (!allowedPattern.test(clientId)) {
                    alert('å®¢æˆ·ç«¯IDæ ¼å¼ä¸æ­£ç¡®ï¼åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—ã€ç‚¹å·(.)ã€è¿å­—ç¬¦(-)ã€ä¸‹åˆ’çº¿(_)å’Œå†’å·(:)');
                    return;
                }
                
                // æ£€æŸ¥å®¢æˆ·ç«¯IDé•¿åº¦
                if (clientId.length < 1 || clientId.length > 100) {
                    alert('å®¢æˆ·ç«¯IDé•¿åº¦å¿…é¡»åœ¨1-100ä¸ªå­—ç¬¦ä¹‹é—´ï¼');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨é‡å¤é”™è¯¯ä¿¡æ¯
                const duplicateErrorMsg = document.querySelector('.client-id-duplicate-message[style*="color: rgb(220, 53, 69)"]');
                if (duplicateErrorMsg) {
                    alert('å®¢æˆ·ç«¯IDå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–IDï¼');
                    return;
                }
                
                // å‘é€åˆ›å»ºè¯·æ±‚
                fetch('/api/clients/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_name: clientName,
                        client_id: clientId,
                        tags: ['user_child']
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸï¼');
                        location.reload(); // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°å®¢æˆ·ç«¯
                    } else {
                        alert('åˆ›å»ºå¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('åˆ›å»ºå¤±è´¥ï¼šç½‘ç»œé”™è¯¯');
                });
            });
        }
        
        // ä¸Šæ¸¸DNSç¼–è¾‘æ¨¡æ€æ¡†äº‹ä»¶å¤„ç†
        if (editUpstreamsModal && closeUpstreamsModal && cancelUpstreamsBtn && editUpstreamsForm) {
            // å…³é—­æ¨¡æ€æ¡†å‡½æ•°
            function closeUpstreamsModalFunc() {
                editUpstreamsModal.style.display = 'none';
                editUpstreamsForm.reset();
            }
            
            // å…³é—­æ¨¡æ€æ¡†äº‹ä»¶
            closeUpstreamsModal.addEventListener('click', closeUpstreamsModalFunc);
            cancelUpstreamsBtn.addEventListener('click', closeUpstreamsModalFunc);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(e) {
                if (e.target === editUpstreamsModal) {
                    closeUpstreamsModalFunc();
                }
            });
            
            // è¡¨å•æäº¤å¤„ç†
            editUpstreamsForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const clientName = document.getElementById('clientNameHidden').value;
                const upstreamsText = document.getElementById('upstreamsConfig').value;
                
                // å°†æ–‡æœ¬è½¬æ¢ä¸ºæ•°ç»„ï¼Œè¿‡æ»¤ç©ºè¡Œ
                const upstreams = upstreamsText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                // å‘é€æ›´æ–°è¯·æ±‚
                fetch(`/api/clients/${clientName}/upstreams`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        upstreams: upstreams
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ä¸Šæ¸¸DNSé…ç½®æ›´æ–°æˆåŠŸï¼');
                        closeUpstreamsModalFunc();
                    } else {
                        alert('æ›´æ–°å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('æ›´æ–°å¤±è´¥ï¼šç½‘ç»œé”™è¯¯');
                });
            });
        }
        
        // ç‚¹å‡»èœå•é¡¹åå…³é—­èœå•
        if (navToggle && navMenu) {
            const navLinks = navMenu.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    navToggle.classList.remove('active');
                    navMenu.classList.remove('active');
                });
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­èœå•
            document.addEventListener('click', function(e) {
                if (!navToggle.contains(e.target) && !navMenu.contains(e.target)) {
                    navToggle.classList.remove('active');
                    navMenu.classList.remove('active');
                }
            });
        }
    });
    
    // åˆ é™¤å®¢æˆ·ç«¯å‡½æ•°
    function deleteClient(mappingId, clientName) {
        if (confirm(`ç¡®å®šè¦åˆ é™¤å®¢æˆ·ç«¯ "${clientName}" å—ï¼Ÿ\n\næ³¨æ„ï¼šåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œè¯¥å®¢æˆ·ç«¯çš„æ‰€æœ‰é…ç½®éƒ½å°†ä¸¢å¤±ã€‚`)) {
            fetch(`/api/clients/${mappingId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('å®¢æˆ·ç«¯åˆ é™¤æˆåŠŸï¼');
                    location.reload(); // åˆ·æ–°é¡µé¢
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('åˆ é™¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯');
            });
        }
    }

    // è‡ªå®šä¹‰è§„åˆ™ç®¡ç†ç›¸å…³å‡½æ•°
    let currentClientId = '';
    let currentClientName = '';

    /**
     * æ‰“å¼€è‡ªå®šä¹‰è§„åˆ™ç®¡ç†æ¨¡æ€æ¡†
     * @param {string} clientId - å®¢æˆ·ç«¯ID
     * @param {string} clientName - å®¢æˆ·ç«¯åç§°
     */
    function manageCustomRules(clientId, clientName) {
        currentClientId = clientId;
        currentClientName = clientName;
        
        document.getElementById('customRulesClientId').value = clientId;
        document.getElementById('customRulesClientName').value = clientName;
        document.getElementById('newCustomRule').value = '';
        document.getElementById('ruleType').value = 'block';
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('customRulesModal').style.display = 'block';
        
        // åŠ è½½å½“å‰è§„åˆ™
        loadCustomRules(clientId);
    }

    /**
     * åŠ è½½å®¢æˆ·ç«¯çš„è‡ªå®šä¹‰è§„åˆ™
     * @param {string} clientId - å®¢æˆ·ç«¯ID
     */
    function loadCustomRules(clientId) {
        const rulesList = document.getElementById('customRulesList');
        rulesList.innerHTML = '<div class="loading-spinner" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</div>';
        
        fetch(`/api/clients/${clientId}/custom-rules`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayCustomRules(data.rules);
                } else {
                    rulesList.innerHTML = '<div class="alert alert-danger">åŠ è½½è§„åˆ™å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            })
            .catch(error => {
                rulesList.innerHTML = '<div class="alert alert-danger">åŠ è½½è§„åˆ™å¤±è´¥: ' + error.message + '</div>';
            });
    }

    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰è§„åˆ™åˆ—è¡¨
     * @param {Array} rules - è§„åˆ™æ•°ç»„
     */
    function displayCustomRules(rules) {
        const rulesList = document.getElementById('customRulesList');
        
        if (rules.length === 0) {
            rulesList.innerHTML = '<div class="text-muted" style="text-align: center; padding: 20px;">æš‚æ— è‡ªå®šä¹‰è§„åˆ™</div>';
            return;
        }
        
        let html = '<div class="rules-list">';
        rules.forEach((rule, index) => {
            const ruleType = rule.startsWith('@@') ? 'allow' : 'block';
            const ruleText = rule.startsWith('@@') ? rule.substring(2) : rule;
            const badgeClass = ruleType === 'allow' ? 'badge-success' : 'badge-danger';
            const typeText = ruleType === 'allow' ? 'å…è®¸' : 'é˜»æ­¢';
            
            html += `
                <div class="rule-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                    <div style="flex: 1;">
                        <span class="badge ${badgeClass}" style="margin-right: 8px;">${typeText}</span>
                        <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">${ruleText}</code>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeCustomRule('${rule.replace(/'/g, "\\'")}')"
                            title="åˆ é™¤è§„åˆ™">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        });
        html += '</div>';
        
        rulesList.innerHTML = html;
    }

    /**
     * æ·»åŠ è‡ªå®šä¹‰è§„åˆ™
     */
    function addCustomRule() {
        const ruleInput = document.getElementById('newCustomRule');
        const ruleType = document.getElementById('ruleType').value;
        let rule = ruleInput.value.trim();
        
        if (!rule) {
            alert('è¯·è¾“å…¥è§„åˆ™å†…å®¹');
            return;
        }
        
        // æ ¹æ®è§„åˆ™ç±»å‹æ·»åŠ å‰ç¼€
        if (ruleType === 'allow' && !rule.startsWith('@@')) {
            rule = '@@' + rule;
        } else if (ruleType === 'block' && rule.startsWith('@@')) {
            rule = rule.substring(2);
        }
        
        // å¦‚æœæ˜¯ç®€å•åŸŸåï¼Œè½¬æ¢ä¸ºAdGuardæ ¼å¼
        if (!rule.includes('||') && !rule.includes('^') && !rule.includes('*') && !rule.includes('/')) {
            if (rule.startsWith('@@')) {
                rule = '@@||' + rule.substring(2) + '^';
            } else {
                rule = '||' + rule + '^';
            }
        }
        
        fetch(`/api/clients/${currentClientId}/custom-rules`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rule: rule })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                ruleInput.value = '';
                loadCustomRules(currentClientId);
            } else {
                alert('æ·»åŠ è§„åˆ™å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            alert('æ·»åŠ è§„åˆ™å¤±è´¥: ' + error.message);
        });
    }

    /**
     * åˆ é™¤è‡ªå®šä¹‰è§„åˆ™
     * @param {string} rule - è¦åˆ é™¤çš„è§„åˆ™
     */
    function removeCustomRule(rule) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
            return;
        }
        
        fetch(`/api/clients/${currentClientId}/custom-rules`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rule: rule })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadCustomRules(currentClientId);
            } else {
                alert('åˆ é™¤è§„åˆ™å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            alert('åˆ é™¤è§„åˆ™å¤±è´¥: ' + error.message);
        });
    }

    // è‡ªå®šä¹‰è§„åˆ™æ¨¡æ€æ¡†äº‹ä»¶å¤„ç†
    document.addEventListener('DOMContentLoaded', function() {
        const customRulesModal = document.getElementById('customRulesModal');
        const closeCustomRulesModal = document.getElementById('closeCustomRulesModal');
        const cancelCustomRulesBtn = document.getElementById('cancelCustomRulesBtn');
        const newCustomRuleInput = document.getElementById('newCustomRule');
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeCustomRulesModalFunc() {
            customRulesModal.style.display = 'none';
            currentClientId = '';
            currentClientName = '';
        }
        
        if (closeCustomRulesModal) {
            closeCustomRulesModal.addEventListener('click', closeCustomRulesModalFunc);
        }
        
        if (cancelCustomRulesBtn) {
            cancelCustomRulesBtn.addEventListener('click', closeCustomRulesModalFunc);
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        if (customRulesModal) {
            customRulesModal.addEventListener('click', function(e) {
                if (e.target === customRulesModal) {
                    closeCustomRulesModalFunc();
                }
            });
        }
        
        // å›è½¦é”®æ·»åŠ è§„åˆ™
        if (newCustomRuleInput) {
            newCustomRuleInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCustomRule();
                }
            });
        }
    });

    // ç¼–è¾‘ä¸Šæ¸¸DNSé…ç½®å‡½æ•°
    function editUpstreams(clientName, mappingId) {
        const modal = document.getElementById('editUpstreamsModal');
        const clientNameDisplay = document.getElementById('clientNameDisplay');
        const clientNameHidden = document.getElementById('clientNameHidden');
        const clientMappingId = document.getElementById('clientMappingId');
        const upstreamsConfig = document.getElementById('upstreamsConfig');
        
        // è®¾ç½®å®¢æˆ·ç«¯ä¿¡æ¯
        clientNameDisplay.value = clientName;
        clientNameHidden.value = clientName;
        clientMappingId.value = mappingId;
        
        // è·å–å½“å‰ä¸Šæ¸¸é…ç½®
        fetch(`/api/clients/${clientName}/upstreams`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // å°†ä¸Šæ¸¸DNSæ•°ç»„è½¬æ¢ä¸ºæ¯è¡Œä¸€ä¸ªçš„æ–‡æœ¬
                    upstreamsConfig.value = (data.upstreams || []).join('\n');
                } else {
                    console.error('è·å–ä¸Šæ¸¸é…ç½®å¤±è´¥:', data.message);
                    upstreamsConfig.value = '';
                }
            })
            .catch(error => {
                console.error('è·å–ä¸Šæ¸¸é…ç½®æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:', error);
                upstreamsConfig.value = '';
            });
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.style.display = 'block';
    }

    </script>
</body>
</html>