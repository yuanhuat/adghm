{% extends "main/base.html" %}

{% block title %}{{ seo_config.title if seo_config else '主页 - ' + project_name + '用户管理系统' }}{% endblock %}

{% block page_content %}
<!-- 系统公告横幅 -->
<div class="announcement-banner" id="announcement-banner" style="display: block;" data-announcement-id="1">
    <div class="announcement-banner-content">
        <svg class="announcement-icon" viewBox="0 0 24 24" width="20" height="20">
            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        <div class="announcement-text" id="banner-announcement-text">公告----: <h1>公益DNS与高级DNS服务说明</h1><ul><li>公益DNS：仅对大众常用软件进行广告拦截，仅确保无误拦截</li><li> 高级DNS：支持小众软件广告拦截，发现漏网广告可提交管理员处理。服务费用30元/年（后期肯定会涨价，但不会对现有的VIP用户提价），需办理请添加QQ：1179736569。</li></ul><h3>高级DNS专属VIP权益</h3><ul><li>精选广告拦截规则</li><li>影视资源仓库</li><li>网易云音乐年会共享</li><li>小说资源（含听书功能）</li><li>ChatGPT5使用权限</li><li>青龙面板权限(独立面板)</li><li>支持自定义id（简单好记）</li><li>支持多客户端（给不同的设备设置规则）</li><li>支持自定义规则</li><li>支持一键拦截或放行特定列表里某个APP或WEB（看广告薅羊毛专用）</li><li>支持自定义上游（可以转接第三方付费DNS）</li></ul><h1>聚集地QQ群:704181773</h1></div>
    </div>
</div>
        
        <!-- 英雄区域 -->
        <section class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">
                    <span class="hero-greeting">欢迎回来</span>
                    <span class="hero-name">{{ current_user.username }}</span>
                </h1>
                <p class="hero-subtitle">强大的DNS管理，融入超薄、超轻、超便携的设计之中</p>
                <div class="hero-stats">
                    <div class="hero-stat">
                        <span class="stat-number" id="user-request-count">{{ user_request_count or 0 }}</span>
                        <span class="stat-label">我的DNS请求</span>
                    </div>
                    <div class="hero-stat">
                        <span class="stat-number" id="total-dns-queries">{{ total_dns_queries or 0 }}</span>
                        <span class="stat-label">总查询数</span>
                    </div>
                    <div class="hero-stat">
                        <span class="stat-number" id="total-blocked-queries">{{ total_blocked_queries or 0 }}</span>
                        <span class="stat-label">总拦截数</span>
                    </div>
                </div>
            </div>

        </section>
        
        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- 功能卡片网格 -->
            <section class="features-grid">
                <!-- 客户端管理卡片 -->
                <div class="feature-card primary-card">
                    <div class="card-header">
                        <svg class="card-icon" viewBox="0 0 24 24" width="32" height="32">
                            <path fill="currentColor" d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
                        </svg>
                        <h3>我的客户端</h3>
                    </div>
                    <div class="card-content">
                        <div class="big-number">{{ current_user.client_mappings|length }}</div>
                        <p class="card-description">管理您的DNS客户端设备</p>
                        <div class="ranking-info" id="user-ranking-info" style="display: none;">
                            <p>排名：<span id="user-ranking">-</span> / <span id="total-clients">-</span></p>
                        </div>
                    </div>
                    <div class="card-action">
                        <a href="{{ url_for('main.clients') }}" class="btn-modern">管理客户端</a>
                    </div>
                </div>



                <!-- 账号信息卡片 -->
                <div class="feature-card">
                    <div class="card-header">
                        <svg class="card-icon" viewBox="0 0 24 24" width="32" height="32">
                            <path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                        <h3>账号信息</h3>
                    </div>
                    <div class="card-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">用户名</span>
                                <span class="info-value">{{ current_user.username }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">注册时间</span>
                                <span class="info-value">{{ current_user.created_at.strftime('%Y-%m-%d') }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">账号类型</span>
                                <span class="info-value">
                                    {% if current_user.is_vip() %}
                                        <span class="vip-badge"><i class="fas fa-crown"></i> VIP用户</span>
                                    {% elif current_user.is_admin %}
                                        <span class="admin-badge"><i class="fas fa-shield-alt"></i> 管理员</span>
                                    {% else %}
                                        <span class="normal-badge">普通用户</span>
                                    {% endif %}
                                </span>
                            </div>
                            {% if current_user.is_vip() %}
                            <div class="info-item vip-info">
                                <span class="info-label">VIP到期时间</span>
                                <span class="info-value vip-expire">
                                    {% if current_user.vip_expire_time %}
                                        {{ current_user.vip_expire_time.strftime('%Y-%m-%d %H:%M') }}
                                        <small class="vip-days-left">
                                            (剩余{{ current_user.get_vip_days_left() }}天)
                                        </small>
                                    {% else %}
                                        永久VIP
                                    {% endif %}
                                </span>
                            </div>
                            {% endif %}
                            {% if current_user.total_donation and current_user.total_donation > 0 %}
                            <div class="info-item donation-info">
                                <span class="info-label">累计捐赠</span>
                                <span class="info-value donation-amount">
                                    <i class="fas fa-heart text-danger"></i> ￥{{ "%.2f"|format(current_user.total_donation) }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="card-action">
                            <button class="btn-modern" onclick="openOpenListModal()">影视</button>
                        </div>
                    </div>
                </div>

                <!-- DNS配置卡片 -->
                <div class="feature-card wide-card">
                    <div class="card-header">
                        <img src="{{ url_for('static', filename='images/dns-icon.svg') }}" alt="DNS配置" class="card-icon">
                        <h3 id="dns-config-title">DNS配置信息</h3>
                    </div>
                    <div class="card-content">
                        <div class="dns-config-content" id="dns-config-content">
                            <p>加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- 苹果设备配置卡片 -->
                <div class="feature-card wide-card">
                    <div class="card-header">
                        <img src="{{ url_for('static', filename='images/apple-icon.svg') }}" alt="苹果配置" class="card-icon">
                        <h3>苹果设备配置</h3>
                    </div>
                    <div class="card-content">
                        <p class="card-description">为您的iPhone、iPad或Mac设备快速配置DNS设置</p>
                        <div class="apple-config-content" id="apple-config-content">
                            <p>加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- 客户端排行榜卡片 -->
                <div class="feature-card wide-card">
                    <div class="card-header">
                        <img src="{{ url_for('static', filename='images/ranking-icon.svg') }}" alt="排行榜" class="card-icon">
                        <h3>客户端排行榜</h3>
                    </div>
                    <div class="card-content">
                        <div class="ranking-list" id="client-ranking">
                            <p>加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- 需求留言卡片 -->
                <div class="feature-card wide-card">
                    <div class="card-header">
                        <img src="{{ url_for('static', filename='images/feedback-icon.svg') }}" alt="留言" class="card-icon">
                        <h3>需求留言</h3>
                    </div>
                    <div class="card-content">
                        <form id="feedback-form" class="modern-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <input type="text" id="feedback-title" name="title" required maxlength="100" placeholder="留言标题">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <textarea id="feedback-content" name="content" required maxlength="1000" rows="3" placeholder="详细描述您的需求或问题"></textarea>
                                </div>
                            </div>
                            <button type="submit" class="btn-modern primary">提交留言</button>
                        </form>
                        <div class="feedback-list" id="feedback-list">
                            <h4>我的留言</h4>
                            <div id="feedback-items">
                                <p>加载中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            

        </main>
    </div>

<!-- OpenList信息模态窗 -->
<div id="openListModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>OpenList影视账户信息</h3>
            <span class="modal-close" onclick="closeOpenListModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="openlist-info-loading" id="openListLoading">
                <p>正在加载账户信息...</p>
            </div>
            <div class="openlist-info-content" id="openListContent" style="display: none;">
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">用户名</span>
                        <span class="info-value" id="openListUsername">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">密码</span>
                        <span class="info-value" id="openListPassword">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">服务器地址</span>
                        <span class="info-value" id="openListServer">-</span>
                    </div>
                </div>
            </div>
            <div class="openlist-info-error" id="openListError" style="display: none;">
                <p class="error-message">暂无OpenList账户信息</p>
            </div>
        </div>
    </div>
</div>

<!-- 公告弹窗模态框 -->
<div id="announcementModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="announcementTitle">公告</h3>
            <span class="modal-close" onclick="closeAnnouncementModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="announcementContent"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeAnnouncementModal()">我知道了</button>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s;
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 0;
    border: none;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s;
}

.modal-header {
    padding: 20px;
    background-color: #007bff;
    color: white;
    border-radius: 8px 8px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.modal-close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.modal-close:hover {
    opacity: 0.7;
}

.modal-body {
    padding: 20px;
    max-height: 400px;
    overflow-y: auto;
    line-height: 1.6;
}

.modal-footer {
    padding: 15px 20px;
    text-align: right;
    border-top: 1px solid #dee2e6;
    border-radius: 0 0 8px 8px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* OpenList信息模态窗样式 */
.openlist-info-loading {
    text-align: center;
    color: #6c757d;
    font-size: 14px;
}

.openlist-info-content .info-grid {
    display: grid;
    gap: 15px;
}

.openlist-info-content .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 3px solid #007bff;
}

.openlist-info-content .info-label {
    font-weight: 600;
    color: #495057;
    font-size: 14px;
}

.openlist-info-content .info-value {
    color: #212529;
    font-size: 14px;
    font-family: 'Courier New', monospace;
    background: #e9ecef;
    padding: 4px 8px;
    border-radius: 4px;
    word-break: break-all;
}

.openlist-info-error {
    text-align: center;
    color: #dc3545;
    font-size: 14px;
    padding: 20px;
}

.openlist-info-error .error-message {
    margin: 0;
    padding: 15px;
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 6px;
    color: #721c24;
}

/* 公告横幅样式 - 在header之上，挤压页面布局 */
.announcement-banner {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    animation: slideDown 0.5s ease-out;
    width: 100%;
}

.announcement-banner-content {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    max-width: 1200px;
    margin: 0 auto;
    gap: 15px;
    min-height: 48px;
}

.announcement-banner .fas.fa-bullhorn {
    font-size: 18px;
    color: #fff;
    flex-shrink: 0;
}

.announcement-banner .announcement-text {
    flex: 1;
    font-size: 14px;
    line-height: 1.4;
    margin: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* 关闭按钮样式已移除，公告横幅不可关闭 */

@keyframes slideDown {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

<style>
/* 苹果配置文件样式 */
.apple-config-items {
    margin-bottom: 20px;
}

/* 移动端下拉菜单样式 */
@media (max-width: 768px) {
    .nav-dropdown-menu {
        position: static;
        opacity: 0;
        visibility: hidden;
        transform: none;
        background: rgba(240, 240, 240, 0.95);
        box-shadow: none;
        border: none;
        border-radius: 0;
        padding: 0;
        margin: 0;
        min-width: auto;
        width: 100%;
        display: none;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .nav-dropdown-menu.active {
        display: block;
        opacity: 1;
        visibility: visible;
        max-height: 300px;
    }
    
    .nav-dropdown-menu a {
        color: #1d1d1f;
        padding: 12px 40px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        background: rgba(240, 240, 240, 0.95);
        text-shadow: none;
        font-size: 14px;
        margin-left: 0;
    }
    
    .nav-dropdown-menu a:hover {
        background: rgba(0, 122, 255, 0.1);
        color: #007AFF;
        transform: none;
    }
}

.apple-config-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.apple-config-item h4 {
    margin: 0 0 5px 0;
    color: #333;
    font-size: 16px;
}

.apple-config-item p {
    margin: 0;
    color: #6c757d;
    font-size: 14px;
}

.btn-download {
    padding: 8px 16px;
    font-size: 14px;
    border-radius: 6px;
    text-decoration: none;
    white-space: nowrap;
}

.btn-download:hover {
    text-decoration: none;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.apple-config-note {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.apple-config-note p {
    margin: 0 0 10px 0;
    color: #856404;
    font-weight: bold;
}

.apple-config-note ol {
    margin: 0;
    padding-left: 20px;
    color: #856404;
}

.apple-config-note li {
    margin-bottom: 5px;
}

.client-selector-container {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.client-selector-container label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #495057;
}

.client-selector-container label i {
    margin-right: 8px;
    color: #007bff;
}

.apple-config-display {
    margin-top: 15px;
    padding: 15px;
    background-color: #ffffff;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.client-selector-container {
    margin-bottom: 20px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border-left: 4px solid #28a745;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.client-selector-container:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.client-selector-container label {
    font-weight: 600;
    margin-bottom: 12px;
    display: block;
    color: #495057;
    font-size: 14px;
    letter-spacing: 0.5px;
}

.client-selector-container label i {
    margin-right: 8px;
    color: #28a745;
}

.client-selector-container select {
    width: 100%;
    padding: 14px 20px 14px 16px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    font-size: 14px;
    color: #495057;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    appearance: none;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%2328a745" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,9 12,15 18,9"></polyline></svg>');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
}

.client-selector-container select:focus {
    outline: none;
    border-color: #28a745;
    box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
    background: linear-gradient(145deg, #ffffff 0%, #f0f8f0 100%);
}

.client-selector-container select:hover {
    border-color: #28a745;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
    background: linear-gradient(145deg, #ffffff 0%, #f0f8f0 100%);
}

.client-selector-container select option {
    padding: 14px 16px;
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    color: #495057;
    font-size: 14px;
    font-weight: 500;
    border: none;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
}

.client-selector-container select option:hover {
    background: linear-gradient(145deg, #e8f5e8 0%, #f0f8f0 100%);
    color: #28a745;
    font-weight: 600;
    transform: scale(1.02);
}

.client-selector-container select option:checked,
.client-selector-container select option:selected {
    background: linear-gradient(145deg, #28a745 0%, #20c997 100%);
    color: #ffffff;
    font-weight: 700;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.client-selector-container select option:disabled {
    background: linear-gradient(145deg, #e9ecef 0%, #f8f9fa 100%);
    color: #6c757d;
    cursor: not-allowed;
    opacity: 0.6;
}

.apple-config-selector {
    margin-bottom: 20px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border-left: 4px solid #007bff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.apple-config-selector:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.apple-config-selector label {
    font-weight: 600;
    margin-bottom: 12px;
    display: block;
    color: #495057;
    font-size: 14px;
    letter-spacing: 0.5px;
}

.apple-config-selector label i {
    margin-right: 8px;
    color: #007bff;
}

.apple-config-selector select {
    width: 100%;
    padding: 14px 20px 14px 16px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    font-size: 14px;
    color: #495057;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    appearance: none;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,9 12,15 18,9"></polyline></svg>');
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
}

.apple-config-selector select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
    background: linear-gradient(145deg, #ffffff 0%, #f0f4ff 100%);
}

.apple-config-selector select:hover {
    border-color: #007bff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
    background: linear-gradient(145deg, #ffffff 0%, #f0f4ff 100%);
}

.apple-config-selector select option {
    padding: 14px 16px;
    background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
    color: #495057;
    font-size: 14px;
    font-weight: 500;
    border: none;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
}

.apple-config-selector select option:hover {
    background: linear-gradient(145deg, #e8f2ff 0%, #f0f4ff 100%);
    color: #007bff;
    font-weight: 600;
    transform: scale(1.02);
}

.apple-config-selector select option:checked,
.apple-config-selector select option:selected {
    background: linear-gradient(145deg, #007bff 0%, #0056b3 100%);
    color: #ffffff;
    font-weight: 700;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.apple-config-selector select option:disabled {
    background: linear-gradient(145deg, #e9ecef 0%, #f8f9fa 100%);
    color: #6c757d;
    cursor: not-allowed;
    opacity: 0.6;
}

.dns-config-display {
    margin-top: 15px;
}

@media (max-width: 768px) {
    .apple-config-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .btn-download {
        align-self: stretch;
        text-align: center;
    }
}
</style>

<script>
// 数字滚动动画函数
         function animateNumber(element, targetValue) {
             const currentValue = parseInt(element.textContent.replace(/,/g, '')) || 0;
             const difference = Math.abs(targetValue - currentValue);
             
             // 如果数值没有变化，直接返回
             if (difference === 0) return;
             
             // 清除可能存在的动画
             if (element.animationTimer) {
                 cancelAnimationFrame(element.animationTimer);
             }
             
             // 根据数值变化大小动态调整动画时间
             let duration;
             if (difference < 100) {
                 duration = 800;  // 小变化：快速动画
             } else if (difference < 1000) {
                 duration = 1200; // 中等变化：中等速度
             } else if (difference < 10000) {
                 duration = 1800; // 大变化：较慢动画
             } else {
                 duration = 2500; // 巨大变化：最慢动画
             }
             
             const startTime = Date.now();
             
             // 使用 requestAnimationFrame 实现更平滑的动画
             function animate() {
                 const elapsed = Date.now() - startTime;
                 const progress = Math.min(elapsed / duration, 1);
                 
                 // 使用更平滑的缓动函数（easeOutCubic）
                 const easeProgress = 1 - Math.pow(1 - progress, 3);
                 
                 const newValue = Math.round(currentValue + ((targetValue - currentValue) * easeProgress));
                 
                 // 格式化数字（添加千位分隔符）
                 element.textContent = newValue.toLocaleString();
                 
                 if (progress < 1) {
                     element.animationTimer = requestAnimationFrame(animate);
                 } else {
                     // 动画完成，确保显示准确值
                     element.textContent = targetValue.toLocaleString();
                     delete element.animationTimer;
                 }
             }
             
             animate();
         }

// 动态更新统计数据
function updateStats() {
    fetch('/api/stats', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Accept': 'application/json'
        }
    })
        .then(response => {
            console.log('Stats API response status:', response.status);
            if (response.status === 401 || response.status === 403) {
                console.log('Stats API: 认证失败，用户未登录');
                return null;
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) {
                console.log('Stats API: 跳过处理（认证失败）');
                return;
            }
            console.log('Stats API data:', data);
            
            // 更新用户请求数（滚动效果）
            const userRequestElement = document.getElementById('user-request-count');
            if (userRequestElement) {
                animateNumber(userRequestElement, data.user_request_count || 0);
            }
            
            // 更新总DNS查询数（滚动效果）
            const totalQueriesElement = document.getElementById('total-dns-queries');
            if (totalQueriesElement) {
                animateNumber(totalQueriesElement, data.total_dns_queries || 0);
            }
            
            // 更新总拦截数（滚动效果）
            const totalBlockedElement = document.getElementById('total-blocked-queries');
            if (totalBlockedElement) {
                animateNumber(totalBlockedElement, data.total_blocked_queries || 0);
            }
            
            // 更新用户排名信息
            const userRankingElement = document.getElementById('user-ranking');
            const totalClientsElement = document.getElementById('total-clients');
            const rankingInfoElement = document.getElementById('user-ranking-info');
            
            if (userRankingElement && totalClientsElement && rankingInfoElement) {
                if (data.user_ranking && data.user_ranking > 0 && data.total_clients > 0) {
                    userRankingElement.textContent = data.user_ranking;
                    totalClientsElement.textContent = data.total_clients;
                    rankingInfoElement.style.display = 'block';
                } else {
                    // 如果没有排名数据，隐藏排名信息
                    rankingInfoElement.style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('Stats API error:', error);
        });
}

// 动态更新客户端排行数据
function updateClientRanking() {
    fetch('/api/client_ranking', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Accept': 'application/json'
        }
    })
        .then(response => {
            console.log('Client ranking API response status:', response.status);
            if (response.status === 401 || response.status === 403) {
                console.log('Client ranking API: 认证失败，用户未登录');
                return null;
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) {
                console.log('Client ranking API: 跳过处理（认证失败）');
                return;
            }
            console.log('Client ranking API data:', data);
            
            const rankingElement = document.getElementById('client-ranking');
            if (rankingElement && data.client_ranking) {
                if (data.client_ranking.length === 0) {
                    rankingElement.innerHTML = '<p>暂无数据</p>';
                } else {
                    let html = '<div class="ranking-items">';
                    data.client_ranking.forEach((client, index) => {
                        const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-other';
                        const currentUserClass = client.is_current_user ? 'current-user' : '';
                        
                        // 获取排名图标
                        let rankIcon = '';
                        if (index === 0) rankIcon = '<i class="fas fa-crown"></i>';
                        else if (index === 1) rankIcon = '<i class="fas fa-medal"></i>';
                        else if (index === 2) rankIcon = '<i class="fas fa-award"></i>';
                        else rankIcon = '<i class="fas fa-user"></i>';
                        
                        // 显示完整数字
                        let formattedCount = client.request_count.toLocaleString();
                        
                        html += `
                            <div class="ranking-item ${rankClass} ${currentUserClass}">
                                <div class="rank-badge">
                                    ${rankIcon}
                                    <span class="rank-number">${index + 1}</span>
                                </div>
                                <div class="client-info">
                                    <div class="client-name">
                                        <i class="fas fa-desktop"></i>
                                        ${client.client_name}
                                        ${client.is_current_user ? '<span class="current-badge">当前</span>' : ''}
                                    </div>
                                </div>
                                <div class="request-stats">
                                    <span class="request-count">${formattedCount}</span>
                                    <span class="request-label">请求数</span>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    rankingElement.innerHTML = html;
                }
            }
        })
        .catch(error => {
            console.error('Client ranking API error:', error);
        });
}

// 获取DNS配置信息
function updateDnsConfig() {
    fetch('/api/dns-config', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => {
        console.log('DNS config API response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('DNS config API data:', data);
        
        // 保存DNS数据到全局变量，供客户端选择器使用
        window.currentDnsData = data;
        
        const titleElement = document.getElementById('dns-config-title');
        const contentElement = document.getElementById('dns-config-content');
        
        if (titleElement && data.display_title) {
            titleElement.textContent = data.display_title;
        }
        
        if (contentElement) {
            let html = '';
            
            if (data.display_description) {
                html += `<p class="dns-description">${data.display_description}</p>`;
            }
            
            let hasConfig = false;
            
            // 检查是否有客户端配置
            if (!data.clients || data.clients.length === 0) {
                html = '<p class="no-config">暂无可用的DNS配置信息</p>';
                contentElement.innerHTML = html;
                return;
            }
            
            // 检查是否有可用的DNS配置
            const availableClients = data.clients.filter(client => {
                const hasDoQ = data.doq_enabled && client.doq_server;
                const hasDoT = data.dot_enabled && client.dot_server;
                const hasDoH = data.doh_enabled && client.doh_server;
                return hasDoQ || hasDoT || hasDoH;
            });
            
            if (availableClients.length > 0) {
                hasConfig = true;
                
                // 如果有多个客户端，显示选择器
                if (availableClients.length > 1) {
                    html += `
                        <div class="client-selector-container">
                            <label for="dns-client-select"><i class="fas fa-desktop"></i> 选择客户端配置：</label>
                            <select id="dns-client-select" class="form-control" onchange="updateDnsConfigForClient()">
                                <option value="">请选择客户端</option>
                    `;
                    
                    availableClients.forEach(client => {
                        html += `<option value="${client.client_id}">${client.client_name} (${client.client_id})</option>`;
                    });
                    
                    html += `
                            </select>
                        </div>
                        <div id="dns-config-display" class="dns-config-display" style="display: none;">
                        </div>
                    `;
                } else {
                    // 只有一个客户端，直接显示
                    const client = availableClients[0];
                    html += generateDnsConfigItems(client, data);
                }
            }
            
            if (!hasConfig) {
                html = '<p class="no-config">暂无可用的DNS配置信息</p>';
            }
            
            contentElement.innerHTML = html;
        }
        
        // 同时更新苹果配置文件
        updateAppleConfig(data);
    })
    .catch(error => {
        console.error('DNS config API error:', error);
        const contentElement = document.getElementById('dns-config-content');
        if (contentElement) {
            contentElement.innerHTML = '<p class="error-message">加载DNS配置信息失败</p>';
        }
    });
}

// 生成DNS配置项的HTML
function generateDnsConfigItems(client, data) {
    let html = '';
    
    // DNS-over-QUIC配置
    if (data.doq_enabled && client.doq_server) {
        html += `
            <div class="dns-config-item">
                <h4><i class="fas fa-bolt" style="color: #007bff;"></i> DNS-over-QUIC (DoQ)</h4>
                <div class="dns-server-info">
                    <p><strong>服务器：</strong> <code>quic://${client.doq_server}:${data.doq_port}</code></p>
                    ${data.doq_description ? `<p class="dns-desc">${data.doq_description}</p>` : ''}
                </div>
            </div>
        `;
    }
    
    // DNS-over-TLS配置
    if (data.dot_enabled && client.dot_server) {
        html += `
            <div class="dns-config-item">
                <h4><i class="fas fa-shield-alt" style="color: #28a745;"></i> DNS-over-TLS (DoT)</h4>
                <div class="dns-server-info">
                    <p><strong>服务器：</strong> <code>tls://${client.dot_server}:${data.dot_port}</code></p>
                    ${data.dot_description ? `<p class="dns-desc">${data.dot_description}</p>` : ''}
                </div>
            </div>
        `;
    }
    
    // DNS-over-HTTPS配置
    if (data.doh_enabled && client.doh_server) {
        const dohUrl = `https://${client.doh_server}${data.doh_port && data.doh_port != 443 ? ':' + data.doh_port : ''}${client.doh_path || '/dns-query'}`;
        html += `
            <div class="dns-config-item">
                <h4><i class="fas fa-globe" style="color: #17a2b8;"></i> DNS-over-HTTPS (DoH)</h4>
                <div class="dns-server-info">
                    <p><strong>服务器：</strong> <code>${dohUrl}</code></p>
                    ${data.doh_description ? `<p class="dns-desc">${data.doh_description}</p>` : ''}
                </div>
            </div>
        `;
    }
    
    return html;
}

// 根据选择的客户端更新DNS配置显示
function updateDnsConfigForClient() {
    const select = document.getElementById('dns-client-select');
    const displayDiv = document.getElementById('dns-config-display');
    
    if (!select || !displayDiv || !window.currentDnsData) {
        return;
    }
    
    const selectedClientId = select.value;
    
    if (!selectedClientId) {
        displayDiv.style.display = 'none';
        return;
    }
    
    // 查找选中的客户端
    const selectedClient = window.currentDnsData.clients.find(client => client.client_id === selectedClientId);
    
    if (selectedClient) {
        const html = generateDnsConfigItems(selectedClient, window.currentDnsData);
        displayDiv.innerHTML = html;
        displayDiv.style.display = 'block';
    } else {
        displayDiv.style.display = 'none';
    }
}

// 更新苹果配置文件
function updateAppleConfig(dnsData) {
    const appleContentElement = document.getElementById('apple-config-content');
    if (!appleContentElement) return;
    
    let html = '';
    let hasConfig = false;
    
    // 检查管理员是否启用了苹果配置文件功能
    if (!dnsData.apple_config_enabled) {
        html = '<p class="no-config">管理员已禁用苹果设备配置文件下载功能</p>';
        appleContentElement.innerHTML = html;
        return;
    }
    
    // 检查是否有客户端配置
    if (!dnsData.clients || dnsData.clients.length === 0) {
        html = '<p class="no-config">暂无可用的DNS配置，请联系管理员设置</p>';
        appleContentElement.innerHTML = html;
        return;
    }
    
    // 检查是否有可用的配置
    const availableClients = dnsData.clients.filter(client => {
        const hasDoH = dnsData.doh_enabled && client.doh_server && dnsData.apple_doh_config_enabled;
        const hasDoT = dnsData.dot_enabled && client.dot_server && dnsData.apple_dot_config_enabled;
        return hasDoH || hasDoT;
    });
    
    if (availableClients.length > 0) {
        hasConfig = true;
        
        // 如果有多个客户端，显示选择器
        if (availableClients.length > 1) {
            html += `
                <div class="apple-config-selector">
                    <label for="apple-client-select"><i class="fas fa-mobile-alt"></i> 选择客户端配置：</label>
                    <select id="apple-client-select" class="form-control" onchange="updateAppleConfigForClient()">
                        <option value="">请选择客户端</option>
            `;
            
            availableClients.forEach(client => {
                html += `<option value="${client.client_id}">${client.client_name} (${client.client_id})</option>`;
            });
            
            html += `
                    </select>
                </div>
                <div id="apple-config-display" class="apple-config-display" style="display: none;">
            `;
        } else {
            // 只有一个客户端，直接显示
            const client = availableClients[0];
            html += '<div class="apple-config-items">';
            html += generateAppleConfigItems(client, dnsData);
            html += '</div>';
        }
        
        // 如果有多个客户端，关闭显示区域
        if (availableClients.length > 1) {
            html += '</div>';
        }
    }
    
    if (hasConfig) {
        html += '<div class="apple-config-note">';
        html += '<p><i class="fas fa-info-circle"></i> <strong>使用说明：</strong></p>';
        html += '<ol>';
        html += '<li>点击下载按钮获取配置文件</li>';
        html += '<li>在设备上打开下载的.mobileconfig文件</li>';
        html += '<li>按照系统提示安装配置文件</li>';
        html += '<li>安装完成后，您的设备将自动使用{{ project_name }}的DNS服务</li>';
        html += '</ol>';
        html += '</div>';
    } else {
        html = '<p class="no-config">暂无可用的DNS配置，请联系管理员设置</p>';
    }
    
    appleContentElement.innerHTML = html;
}

// 生成苹果配置项的辅助函数
function generateAppleConfigItems(client, dnsData) {
    let html = '';
    const hasDoH = dnsData.doh_enabled && client.doh_server && dnsData.apple_doh_config_enabled;
    const hasDoT = dnsData.dot_enabled && client.dot_server && dnsData.apple_dot_config_enabled;
    
    if (hasDoH) {
        // 从包含客户端ID的服务器地址中提取原始域名
        const dohServerWithClientId = client.doh_server || 'localhost';
        const dohHost = dohServerWithClientId.includes('.') ? 
            dohServerWithClientId.substring(dohServerWithClientId.indexOf('.') + 1) : 
            dohServerWithClientId;
        html += `
            <div class="apple-config-item">
                <div class="config-info">
                    <h4><i class="fas fa-globe" style="color: #17a2b8;"></i> DNS-over-HTTPS (DoH)</h4>
                    <p>适用于 iOS 14+ 和 macOS Big Sur+</p>
                </div>
                <a href="/api/apple/doh.mobileconfig?host=${encodeURIComponent(dohHost)}&client_id=${encodeURIComponent(client.client_id)}" class="btn btn-primary btn-download" download>
                    <i class="fas fa-download"></i> 下载配置文件
                </a>
            </div>
        `;
    }
    
    if (hasDoT) {
        // 从包含客户端ID的服务器地址中提取原始域名
        const dotServerWithClientId = client.dot_server || 'localhost';
        const dotHost = dotServerWithClientId.includes('.') ? 
            dotServerWithClientId.substring(dotServerWithClientId.indexOf('.') + 1) : 
            dotServerWithClientId;
        html += `
            <div class="apple-config-item">
                <div class="config-info">
                    <h4><i class="fas fa-shield-alt" style="color: #28a745;"></i> DNS-over-TLS (DoT)</h4>
                    <p>适用于 iOS 14+ 和 macOS Big Sur+</p>
                </div>
                <a href="/api/apple/dot.mobileconfig?host=${encodeURIComponent(dotHost)}&client_id=${encodeURIComponent(client.client_id)}" class="btn btn-primary btn-download" download>
                    <i class="fas fa-download"></i> 下载配置文件
                </a>
            </div>
        `;
    }
    
    return html;
}

// 处理客户端选择变化
function updateAppleConfigForClient() {
    const selectElement = document.getElementById('apple-client-select');
    const displayElement = document.getElementById('apple-config-display');
    
    if (!selectElement || !displayElement) return;
    
    const selectedClientId = selectElement.value;
    
    if (!selectedClientId) {
        displayElement.style.display = 'none';
        return;
    }
    
    // 从全局DNS数据中找到选中的客户端
    const selectedClient = window.currentDnsData?.clients?.find(client => client.client_id === selectedClientId);
    
    if (selectedClient && window.currentDnsData) {
        const configHtml = generateAppleConfigItems(selectedClient, window.currentDnsData);
        displayElement.innerHTML = `<div class="apple-config-items">${configHtml}</div>`;
        displayElement.style.display = 'block';
    } else {
        displayElement.style.display = 'none';
    }
}

// 提交留言表单
function submitFeedback(event) {
    event.preventDefault();
    
    const form = document.getElementById('feedback-form');
    const formData = new FormData(form);
    const data = {
        title: formData.get('title'),
        content: formData.get('content')
    };
    
    fetch('/api/feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.status === 401 || response.status === 403) {
            alert('请先登录后再提交留言');
            return null;
        }
        return response.json();
    })
    .then(data => {
        if (!data) return; // 认证失败时跳过处理
        
        if (data.success) {
            form.reset();
            updateFeedbackList();
            alert('留言提交成功！');
        } else {
            alert('提交失败：' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        alert('提交失败，请稍后重试');
    });
}

// 更新留言列表
function updateFeedbackList() {
    fetch('/api/feedback')
        .then(response => {
            if (response.status === 401 || response.status === 403) {
                // 认证失败，可能需要重新登录
                return null;
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // 认证失败时跳过处理
            
            const feedbackItemsElement = document.getElementById('feedback-items');
            if (feedbackItemsElement && data.feedbacks) {
                if (data.feedbacks.length === 0) {
                    feedbackItemsElement.innerHTML = '<p>暂无留言</p>';
                } else {
                    let html = '';
                    data.feedbacks.forEach(feedback => {
                        const statusClass = feedback.status === 'open' ? 'status-open' : 'status-closed';
                        const statusText = feedback.status === 'open' ? '待处理' : '已关闭';
                        html += `
                            <div class="feedback-item ${statusClass}">
                                <div class="feedback-header">
                                    <h4>${feedback.title}</h4>
                                    <span class="feedback-status">${statusText}</span>
                                </div>
                                <div class="feedback-content">${feedback.content}</div>
                                <div class="feedback-meta">
                                    <span>创建时间：${new Date(feedback.created_at).toLocaleString()}</span>
                                    ${feedback.admin_reply ? `<div class="admin-reply"><strong>管理员回复：</strong>${feedback.admin_reply}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    feedbackItemsElement.innerHTML = html;
                }
            }
        })
        .catch(error => {
            console.error('Feedback API error:', error);
        });
}

// 公告相关函数
function loadAnnouncements() {
    fetch('/api/announcements/active', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (response.status === 401 || response.status === 403) {
            return null;
        }
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // 更新公告横幅显示
        updateAnnouncementBanner(data);
        
        // 检查是否有未读公告需要弹窗显示
        checkForUnreadAnnouncements(data);
    })
    .catch(error => {
        console.error('获取公告失败:', error);
    });
}

function updateAnnouncementBanner(data) {
    const banner = document.getElementById('announcement-banner');
    const bannerText = document.getElementById('banner-announcement-text');
    
    if (!banner || !bannerText) return;
    
    // 公告横幅始终显示，不可关闭
    banner.style.display = 'block';
    
    if (data && data.announcements && data.announcements.length > 0) {
        // 显示最新的公告
        const latestAnnouncement = data.announcements[0];
        bannerText.innerHTML = `${latestAnnouncement.title}: ${latestAnnouncement.content}`;
        banner.dataset.announcementId = latestAnnouncement.id;
    }
    // 如果没有公告数据，保持当前显示的内容不变
}

// 公告横幅不可关闭，此函数已禁用
function closeAnnouncementBanner() {
    // 公告横幅设置为不可关闭，此函数不执行任何操作
    return;
}

function checkForUnreadAnnouncements(data) {
    if (!data || !data.announcements || data.announcements.length === 0) {
        return;
    }
    
    // 获取已读公告列表
    const readAnnouncements = JSON.parse(localStorage.getItem('readAnnouncements') || '[]');
    
    // 查找未读公告
    const unreadAnnouncement = data.announcements.find(announcement => 
        !readAnnouncements.includes(announcement.id)
    );
    
    if (unreadAnnouncement) {
        showAnnouncementModal(unreadAnnouncement);
    }
}

function showAnnouncementModal(announcement) {
    const modal = document.getElementById('announcementModal');
    const title = document.getElementById('announcementTitle');
    const content = document.getElementById('announcementContent');
    
    if (modal && title && content) {
        title.textContent = announcement.title;
        content.innerHTML = announcement.content;
        modal.style.display = 'block';
        
        // 记录当前显示的公告ID
        modal.dataset.announcementId = announcement.id;
    }
}

function closeAnnouncementModal() {
    const modal = document.getElementById('announcementModal');
    if (modal) {
        const announcementId = modal.dataset.announcementId;
        if (announcementId) {
            // 标记公告为已读
            const readAnnouncements = JSON.parse(localStorage.getItem('readAnnouncements') || '[]');
            if (!readAnnouncements.includes(parseInt(announcementId))) {
                readAnnouncements.push(parseInt(announcementId));
                localStorage.setItem('readAnnouncements', JSON.stringify(readAnnouncements));
            }
        }
        modal.style.display = 'none';
    }
}

// OpenList模态窗相关函数
function openOpenListModal() {
    const modal = document.getElementById('openListModal');
    const loading = document.getElementById('openListLoading');
    const content = document.getElementById('openListContent');
    const error = document.getElementById('openListError');
    
    // 显示模态窗和加载状态
    modal.style.display = 'block';
    loading.style.display = 'block';
    content.style.display = 'none';
    error.style.display = 'none';
    
    // 加载OpenList账户信息
    loadOpenListInfo();
}

function closeOpenListModal() {
    const modal = document.getElementById('openListModal');
    modal.style.display = 'none';
}

function loadOpenListInfo() {
    fetch('/api/user/openlist-info')
        .then(response => response.json())
        .then(data => {
            const loading = document.getElementById('openListLoading');
            const content = document.getElementById('openListContent');
            const error = document.getElementById('openListError');
            
            loading.style.display = 'none';
            
            if (data.success && data.openlist_info) {
                // 显示账户信息
                document.getElementById('openListUsername').textContent = data.openlist_info.username || '-';
                document.getElementById('openListPassword').textContent = data.openlist_info.password || '-';
                document.getElementById('openListServer').textContent = data.openlist_info.server_address || '-';
                content.style.display = 'block';
            } else {
                // 显示错误信息
                error.style.display = 'block';
            }
        })
        .catch(err => {
            console.error('加载OpenList信息失败:', err);
            const loading = document.getElementById('openListLoading');
            const error = document.getElementById('openListError');
            loading.style.display = 'none';
            error.style.display = 'block';
        });
}

// VIP权限提示函数
function showVipRequiredAlert(event) {
    event.preventDefault();
    alert('您暂时无法查看');
    return false;
}

// 点击模态框外部关闭
window.onclick = function(event) {
    const announcementModal = document.getElementById('announcementModal');
    const openListModal = document.getElementById('openListModal');
    
    if (event.target === announcementModal) {
        closeAnnouncementModal();
    }
    if (event.target === openListModal) {
        closeOpenListModal();
    }
}

// 页面加载完成后开始定期更新
document.addEventListener('DOMContentLoaded', function() {
    // 立即更新一次
    updateStats();
    updateClientRanking();
    updateFeedbackList();
    updateDnsConfig();
    
    // 加载公告
    loadAnnouncements();
    
    // 绑定留言表单提交事件
    const feedbackForm = document.getElementById('feedback-form');
    if (feedbackForm) {
        feedbackForm.addEventListener('submit', submitFeedback);
    }
    
    // 每1秒更新一次统计数据
    setInterval(updateStats, 1000);
    
    // 每5秒更新一次客户端排行
    setInterval(updateClientRanking, 5000);
    
    // 每30秒更新一次留言列表
    setInterval(updateFeedbackList, 30000);
    
    // 每2分钟更新一次公告
    setInterval(loadAnnouncements, 120000);
    
    // 导航栏功能已在base.html中实现，此处不需要重复定义
});
</script>
{% endblock %}