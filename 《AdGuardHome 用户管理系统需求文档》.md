AdGuardHome 对接功能需求文档
一、项目概述
本功能旨在实现自有项目系统与 AdGuardHome 的对接，通过 API 交互实现用户管理与 AdGuardHome 客户端管理的自动化关联，简化管理员操作流程，提升用户体验。
1.1 背景
AdGuardHome 是一款网络广告过滤与隐私保护工具，支持通过客户端识别与管理实现精细化的过滤规则配置。为将用户系统与 AdGuardHome 的客户端管理无缝整合，需开发相应对接功能。
1.2 目标
实现项目系统对 AdGuardHome 服务的配置管理。
实现用户注册后自动在 AdGuardHome 中创建对应的持久化客户端。
提供管理员系统，支持对用户及其关联的 AdGuardHome 持久化客户端进行统一管理（修改、删除等）。
二、核心功能需求
2.1 AdGuardHome 对接配置
项目系统需提供配置界面，用于设置对接的 AdGuardHome 服务信息，具体包括：
AdGuardHome API 基础地址：配置 AdGuardHome 服务的 API 访问根地址。
连接测试：提供 “测试连接” 功能，验证配置的 AdGuardHome 地址和认证信息是否有效。
2.2 用户注册与 AdGuardHome 持久化客户端自动创建
触发时机：用户在项目系统中完成注册并成功激活账号后，系统自动触发 AdGuardHome 客户端创建流程。
客户端信息：在 AdGuardHome 中创建的持久化客户端需包含以下关键信息：
客户端名称：使用项目系统中的用户名（或用户名 + 用户 ID），确保唯一性和可识别性。
识别方式：根据实际需求配置客户端识别方式（可在项目配置中预设默认识别方式）。
持久化属性：将客户端设置为 “持久化”（即 AdGuardHome 不会自动删除该客户端记录）。
关联存储：客户端创建成功后，项目系统需将 AdGuardHome 返回的客户端唯一标识与本地用户 ID 关联存储。
错误处理：若客户端创建失败，系统需记录详细日志，并可根据配置触发告警，同时确保用户注册流程不受阻塞（或根据业务需求决定是否阻塞）。
2.3 管理员系统 - 用户及关联 AdGuardHome 客户端管理
管理员系统需提供专门的功能模块，用于管理用户及其在 AdGuardHome 中的关联客户端，具体功能包括：
2.3.1 用户列表与关联客户端信息展示
管理员可查看系统内所有用户的列表，列表中需明确标识每个用户是否已关联 AdGuardHome 客户端。
对于已关联客户端的用户，需显示其对应的 AdGuardHome 客户端 ID、客户端名称、创建时间等关键信息。
2.3.2 用户信息修改与客户端同步
当管理员在系统中修改用户名时，可选择是否同步更新 AdGuardHome 中对应客户端的名称。
若用户的识别信息发生变更，管理员可在系统中更新，并同步至 AdGuardHome 客户端的配置中。
支持管理员手动触发 “重新关联” 功能：当用户与客户端的关联关系异常时，可重新在 AdGuardHome 中为该用户创建客户端并建立关联。
2.3.3 用户删除与客户端清理
当管理员删除系统中的用户时，需提供选项：是否同时删除 AdGuardHome 中对应的持久化客户端。
若选择 “是”：系统调用 AdGuardHome API 删除该客户端，并清除本地关联记录。
若选择 “否”：仅删除系统内用户信息，保留 AdGuardHome 客户端。
删除操作需有二次确认机制，防止误操作。删除失败时，需记录日志并提示管理员手动处理。
三、非功能性需求
安全性：
AdGuardHome 的 API 认证信息需加密存储，避免明文泄露。
管理员操作需有严格的权限控制，仅授权用户可进行管理操作。
可靠性：
与 AdGuardHome 的 API 交互需实现重试机制，应对临时网络波动或服务响应延迟。
关键操作（如客户端创建、删除）需记录操作日志，支持追溯。
可扩展性：
预留接口扩展空间，支持未来对接多个 AdGuardHome 实例的场景。
客户端创建的默认参数（如识别方式）可通过配置灵活调整，无需修改代码。
四、接口交互说明
项目系统与 AdGuardHome 的交互需基于 AdGuardHome 官方 API 实现，核心接口包括：
客户端创建接口：调用 AdGuardHome API 新建持久化客户端。
客户端查询接口：获取指定客户端的详细信息，用于验证创建结果或展示客户端状态。
客户端更新接口：当用户信息变更时，同步更新 AdGuardHome 中客户端的对应信息。
客户端删除接口：当用户被删除且选择同步删除客户端时，调用此接口移除 AdGuardHome 中的客户端。